<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GestiÃ³n de Pedidos - FactuFacil</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        :root {
            --primary: #3b82f6;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --info: #6366f1;
            --dark: #1e293b;
            --light: #f8fafc;
            --border: #e2e8f0;
        }

        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background-color: #f1f5f9;
            min-height: 100vh;
        }

        /* Navbar */
        .navbar-custom {
            background: linear-gradient(135deg, var(--dark), #334155);
            padding: 0.75rem 1.5rem;
        }

        .navbar-brand {
            font-weight: 700;
            font-size: 1.25rem;
        }

        /* Stats Cards */
        .stats-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .stat-card {
            background: white;
            border-radius: 16px;
            padding: 1.25rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .stat-icon {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }

        .stat-icon.pendientes { background: #fef3c7; color: #92400e; }
        .stat-icon.hoy { background: #dbeafe; color: #1e40af; }
        .stat-icon.mes { background: #d1fae5; color: #065f46; }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            line-height: 1.2;
        }

        .stat-label {
            font-size: 0.85rem;
            color: #64748b;
        }

        /* Filters */
        .filters-section {
            background: white;
            border-radius: 16px;
            padding: 1rem 1.25rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            align-items: center;
        }

        .filter-btn {
            padding: 0.5rem 1rem;
            border-radius: 50px;
            border: 2px solid var(--border);
            background: white;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .filter-btn:hover {
            border-color: var(--primary);
        }

        .filter-btn.active {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
        }

        .filter-badge {
            background: rgba(0,0,0,0.1);
            padding: 0.15rem 0.5rem;
            border-radius: 50px;
            font-size: 0.75rem;
        }

        .filter-btn.active .filter-badge {
            background: rgba(255,255,255,0.2);
        }

        /* Pedidos Table */
        .pedidos-container {
            background: white;
            border-radius: 16px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .table {
            margin-bottom: 0;
        }

        .table th {
            background: #f8fafc;
            font-weight: 600;
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: #64748b;
            padding: 1rem;
            border-bottom: 2px solid var(--border);
        }

        .table td {
            padding: 1rem;
            vertical-align: middle;
        }

        .table tbody tr {
            transition: background 0.2s;
        }

        .table tbody tr:hover {
            background: #f8fafc;
        }

        /* Estado badges */
        .estado-badge {
            padding: 0.35rem 0.75rem;
            border-radius: 50px;
            font-size: 0.75rem;
            font-weight: 600;
            display: inline-block;
        }

        .estado-pendiente { background: #fef3c7; color: #92400e; }
        .estado-preparando { background: #dbeafe; color: #1e40af; }
        .estado-cotizado { background: #fae8ff; color: #86198f; }
        .estado-aceptado { background: #dcfce7; color: #166534; }
        .estado-listo { background: #d1fae5; color: #065f46; }
        .estado-facturado { background: #e0e7ff; color: #3730a3; }
        .estado-rechazado { background: #fee2e2; color: #991b1b; }
        .estado-cancelado { background: #fee2e2; color: #991b1b; }

        /* Cliente info */
        .cliente-nombre {
            font-weight: 600;
            color: var(--dark);
        }

        .cliente-doc {
            font-size: 0.8rem;
            color: #64748b;
        }

        .cliente-tel {
            font-size: 0.8rem;
            color: #64748b;
        }

        /* Total */
        .pedido-total {
            font-weight: 700;
            font-size: 1.1rem;
            color: var(--success);
        }

        /* Actions */
        .btn-action {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            border: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-view {
            background: #e0e7ff;
            color: #4f46e5;
        }

        .btn-view:hover {
            background: #4f46e5;
            color: white;
        }

        .btn-facturar {
            background: #d1fae5;
            color: #059669;
        }

        .btn-facturar:hover {
            background: #059669;
            color: white;
        }

        /* Estado Select */
        .estado-select {
            padding: 0.35rem 0.75rem;
            border-radius: 8px;
            border: 2px solid var(--border);
            font-size: 0.85rem;
            cursor: pointer;
        }

        .estado-select:focus {
            outline: none;
            border-color: var(--primary);
        }

        /* Modal */
        .modal-content {
            border: none;
            border-radius: 16px;
        }

        .modal-header {
            background: #f8fafc;
            border-radius: 16px 16px 0 0;
        }

        .producto-row {
            display: flex;
            justify-content: space-between;
            padding: 0.75rem 0;
            border-bottom: 1px solid var(--border);
        }

        .producto-row:last-child {
            border-bottom: none;
        }

        .producto-nombre {
            font-weight: 500;
        }

        .producto-codigo {
            font-size: 0.8rem;
            color: #64748b;
        }

        .producto-qty {
            color: #64748b;
        }

        /* EdiciÃ³n de cantidades */
        .qty-input {
            width: 80px;
            padding: 0.35rem 0.5rem;
            border: 2px solid var(--border);
            border-radius: 8px;
            text-align: center;
            font-weight: 600;
        }

        .qty-input:focus {
            outline: none;
            border-color: var(--primary);
        }

        /* NUEVO: Productos pesables */
        .qty-pesable {
            background-color: #fffbeb !important;
            border-color: #f59e0b !important;
            width: 100px;
        }

        .qty-pesable:focus {
            box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.25) !important;
        }

        .linea-pesable {
            border-left: 3px solid #f59e0b;
            background-color: rgba(245, 158, 11, 0.05);
            padding-left: 0.75rem !important;
        }

        .producto-row-edit {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 0;
            border-bottom: 1px solid var(--border);
        }

        .producto-row-edit:last-child {
            border-bottom: none;
        }

        /* LÃ­neas pesables en modo lectura */
        .producto-row.linea-pesable {
            border-left: 3px solid #0dcaf0;
            background-color: rgba(13, 202, 240, 0.05);
            padding-left: 0.75rem;
            margin-left: 0.5rem;
        }

        .total-calculado {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            padding: 1rem;
            border-radius: 12px;
            margin-top: 1rem;
        }

        .total-pendiente {
            background: #fef3c7;
            color: #92400e;
            padding: 1rem;
            border-radius: 12px;
            margin-top: 1rem;
            text-align: center;
        }

        .btn-cotizar {
            background: linear-gradient(135deg, #8b5cf6, #7c3aed);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-cotizar:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(139, 92, 246, 0.3);
        }

        /* Empty state */
        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
        }

        .empty-state i {
            font-size: 4rem;
            color: #cbd5e1;
            margin-bottom: 1rem;
        }

        /* Loading */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255,255,255,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .spinner-lg {
            width: 60px;
            height: 60px;
            border: 4px solid var(--border);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .stats-row {
                grid-template-columns: 1fr;
            }

            .filters-section {
                flex-direction: column;
                align-items: stretch;
            }

            .filter-btn {
                justify-content: center;
            }

            .table-responsive {
                font-size: 0.875rem;
            }
        }

        /* Refresh button */
        .btn-refresh {
            background: white;
            border: 2px solid var(--border);
            border-radius: 8px;
            padding: 0.5rem 1rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-refresh:hover {
            border-color: var(--primary);
            color: var(--primary);
        }

        .btn-refresh.loading i {
            animation: spin 1s linear infinite;
        }
    </style>
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-dark navbar-custom">
        <div class="container-fluid">
            <a class="navbar-brand text-white" href="/">
                <i class="bi bi-box-seam me-2"></i>FactuFacil
            </a>
            <div class="d-flex align-items-center gap-3">
                <span class="text-white-50">GestiÃ³n de Pedidos</span>
                <a href="/" class="btn btn-outline-light btn-sm">
                    <i class="bi bi-arrow-left me-1"></i>Volver
                </a>
            </div>
        </div>
    </nav>

    <div class="container-fluid py-4">
        <!-- Stats -->
        <div class="stats-row" id="statsRow">
            <div class="stat-card">
                <div class="stat-icon pendientes">
                    <i class="bi bi-clock-history"></i>
                </div>
                <div>
                    <div class="stat-value" id="statPendientes">-</div>
                    <div class="stat-label">Pedidos Pendientes</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon hoy">
                    <i class="bi bi-calendar-check"></i>
                </div>
                <div>
                    <div class="stat-value" id="statHoy">-</div>
                    <div class="stat-label">Pedidos Hoy</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon mes">
                    <i class="bi bi-graph-up"></i>
                </div>
                <div>
                    <div class="stat-value" id="statMes">-</div>
                    <div class="stat-label">Este Mes</div>
                </div>
            </div>
        </div>

        <!-- ConfiguraciÃ³n de Listas de Precios -->
        <div class="stats-row mb-3">
            <div class="stat-card" style="flex: 1; max-width: 500px;">
                <div class="stat-icon" style="background: #fae8ff; color: #86198f;">
                    <i class="bi bi-gear"></i>
                </div>
                <div style="flex: 1;">
                    <div class="stat-label mb-2"><strong>ConfiguraciÃ³n de Listas de Precios</strong></div>
                    <div class="d-flex gap-3 align-items-center">
                        <div>
                            <small class="text-muted">Retiro:</small>
                            <select class="form-select form-select-sm" id="configListaRetiro" style="width: 110px;" onchange="guardarConfiguracion()">
                                <option value="1">Lista 1</option>
                                <option value="2">Lista 2</option>
                                <option value="3">Lista 3</option>
                                <option value="4">Lista 4</option>
                                <option value="5">Lista 5</option>
                            </select>
                        </div>
                        <div>
                            <small class="text-muted">EnvÃ­o:</small>
                            <select class="form-select form-select-sm" id="configListaEnvio" style="width: 110px;" onchange="guardarConfiguracion()">
                                <option value="1">Lista 1</option>
                                <option value="2">Lista 2</option>
                                <option value="3">Lista 3</option>
                                <option value="4">Lista 4</option>
                                <option value="5">Lista 5</option>
                            </select>
                        </div>
                        <span id="configStatus" class="text-success" style="font-size: 0.8rem;"></span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Filters -->
        <div class="filters-section">
            <button class="filter-btn active" onclick="filtrarEstado('')" data-estado="">
                <i class="bi bi-grid"></i>
                Todos
                <span class="filter-badge" id="countTodos">0</span>
            </button>
            <button class="filter-btn" onclick="filtrarEstado('pendiente')" data-estado="pendiente">
                <i class="bi bi-clock"></i>
                Pendientes
                <span class="filter-badge" id="countPendiente">0</span>
            </button>
            <button class="filter-btn" onclick="filtrarEstado('preparando')" data-estado="preparando">
                <i class="bi bi-box-seam"></i>
                Preparando
                <span class="filter-badge" id="countPreparando">0</span>
            </button>
            <button class="filter-btn" onclick="filtrarEstado('listo')" data-estado="listo">
                <i class="bi bi-check-circle"></i>
                Listos
                <span class="filter-badge" id="countListo">0</span>
            </button>
            <button class="filter-btn" onclick="filtrarEstado('facturado')" data-estado="facturado">
                <i class="bi bi-receipt"></i>
                Facturados
                <span class="filter-badge" id="countFacturado">0</span>
            </button>
            
            <div class="ms-auto">
                <button class="btn-refresh" onclick="cargarPedidos()" id="btnRefresh">
                    <i class="bi bi-arrow-clockwise"></i>
                    Actualizar
                </button>
            </div>
        </div>

        <!-- Pedidos Table -->
        <div class="pedidos-container">
            <div class="table-responsive">
                <table class="table">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Fecha</th>
                            <th>Cliente</th>
                            <th>Total</th>
                            <th>Estado</th>
                            <th>Notas</th>
                            <th class="text-center">Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="pedidosBody">
                        <tr>
                            <td colspan="7">
                                <div class="text-center py-4">
                                    <div class="spinner-border text-primary"></div>
                                    <p class="mt-2 mb-0">Cargando pedidos...</p>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Modal Detalle -->
    <div class="modal fade" id="modalDetalle" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-box-seam me-2"></i>
                        Detalle del Pedido <span id="modalPedidoId">#</span>
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="modalBody">
                    <div class="text-center py-4">
                        <div class="spinner-border text-primary"></div>
                    </div>
                </div>
                <div class="modal-footer" id="modalFooter">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // VARIABLES GLOBALES
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        let pedidos = [];
        let estadoFiltro = '';
        let pedidoActual = null;

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // INICIALIZACIÃ“N
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        document.addEventListener('DOMContentLoaded', function() {
            cargarEstadisticas();
            cargarConfiguracion();
            cargarPedidos();
            
            // Auto-refresh cada 30 segundos
            setInterval(() => {
                cargarPedidos(true);
            }, 30000);
        });

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // CARGAR DATOS
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        async function cargarEstadisticas() {
            try {
                const response = await fetch('/api/admin/pedidos/estadisticas');
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('statPendientes').textContent = data.pendientes.cantidad;
                    document.getElementById('statHoy').textContent = data.hoy.cantidad;
                    document.getElementById('statMes').textContent = data.mes.cantidad;
                }
            } catch (error) {
                console.error('Error cargando estadÃ­sticas:', error);
            }
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // CONFIGURACIÃ“N DE LISTAS DE PRECIOS
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        async function cargarConfiguracion() {
            try {
                const response = await fetch('/api/admin/pedidos/configuracion');
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('configListaRetiro').value = data.lista_retiro;
                    document.getElementById('configListaEnvio').value = data.lista_envio;
                }
            } catch (error) {
                console.error('Error cargando configuraciÃ³n:', error);
            }
        }

        async function guardarConfiguracion() {
            const listaRetiro = document.getElementById('configListaRetiro').value;
            const listaEnvio = document.getElementById('configListaEnvio').value;
            const status = document.getElementById('configStatus');
            
            try {
                const response = await fetch('/api/admin/pedidos/configuracion', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        lista_retiro: parseInt(listaRetiro),
                        lista_envio: parseInt(listaEnvio)
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    status.textContent = 'âœ“ Guardado';
                    status.className = 'text-success';
                    setTimeout(() => { status.textContent = ''; }, 2000);
                } else {
                    status.textContent = 'âœ— Error';
                    status.className = 'text-danger';
                }
            } catch (error) {
                status.textContent = 'âœ— Error';
                status.className = 'text-danger';
            }
        }

        async function cargarPedidos(silent = false) {
            const btn = document.getElementById('btnRefresh');
            const tbody = document.getElementById('pedidosBody');
            
            if (!silent) {
                btn.classList.add('loading');
            }
            
            try {
                const params = estadoFiltro ? `?estado=${estadoFiltro}` : '';
                const response = await fetch('/api/admin/pedidos' + params);
                const data = await response.json();
                
                if (data.success) {
                    pedidos = data.pedidos;
                    actualizarContadores(data.conteo);
                    renderizarPedidos();
                }
            } catch (error) {
                console.error('Error cargando pedidos:', error);
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7">
                            <div class="empty-state">
                                <i class="bi bi-exclamation-circle"></i>
                                <p>Error al cargar pedidos</p>
                            </div>
                        </td>
                    </tr>`;
            } finally {
                btn.classList.remove('loading');
            }
        }

        function actualizarContadores(conteo) {
            const total = Object.values(conteo).reduce((a, b) => a + b, 0);
            document.getElementById('countTodos').textContent = total;
            document.getElementById('countPendiente').textContent = conteo.pendiente || 0;
            document.getElementById('countPreparando').textContent = conteo.preparando || 0;
            document.getElementById('countListo').textContent = conteo.listo || 0;
            document.getElementById('countFacturado').textContent = conteo.facturado || 0;
        }

        function renderizarPedidos() {
            const tbody = document.getElementById('pedidosBody');
            
            if (pedidos.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7">
                            <div class="empty-state">
                                <i class="bi bi-inbox"></i>
                                <p>No hay pedidos ${estadoFiltro ? 'con estado "' + estadoFiltro + '"' : ''}</p>
                            </div>
                        </td>
                    </tr>`;
                return;
            }
            
            let html = '';
            pedidos.forEach(pedido => {
                html += `
                    <tr>
                        <td><strong>#${pedido.id}</strong></td>
                        <td>${pedido.fecha}</td>
                        <td>
                            <div class="cliente-nombre">${pedido.cliente_nombre}</div>
                            <div class="cliente-doc">${pedido.cliente_documento}</div>
                            ${pedido.cliente_telefono ? `<div class="cliente-tel"><i class="bi bi-telephone me-1"></i>${pedido.cliente_telefono}</div>` : ''}
                            <span class="badge ${pedido.tipo_entrega === 'envio' ? 'bg-info' : 'bg-secondary'}" style="font-size: 0.7rem;">
                                <i class="bi ${pedido.tipo_entrega === 'envio' ? 'bi-truck' : 'bi-shop'} me-1"></i>
                                ${pedido.tipo_entrega === 'envio' ? 'EnvÃ­o' : 'Retiro'}
                            </span>
                        </td>
                        <td class="pedido-total">${pedido.total > 0 ? '$' + formatNumber(pedido.total) : '<span class="text-muted">Pendiente</span>'}</td>
                        <td>
                            ${pedido.estado === 'facturado' ? `
                                <span class="estado-badge estado-${pedido.estado}">${pedido.estado.toUpperCase()}</span>
                                ${pedido.factura_numero ? `<br><small class="text-muted">Fact: ${pedido.factura_numero}</small>` : ''}
                            ` : `
                                <select class="estado-select" onchange="console.log('Cambio detectado:', ${pedido.id}, this.value); cambiarEstado(${pedido.id}, this.value)">
                                    <option value="pendiente" ${pedido.estado === 'pendiente' ? 'selected' : ''}>Pendiente</option>
                                    <option value="preparando" ${pedido.estado === 'preparando' ? 'selected' : ''}>Preparando</option>
                                    <option value="cotizado" ${pedido.estado === 'cotizado' ? 'selected' : ''}>Cotizado</option>
                                    <option value="aceptado" ${pedido.estado === 'aceptado' ? 'selected' : ''}>Aceptado</option>
                                    <option value="listo" ${pedido.estado === 'listo' ? 'selected' : ''}>Listo</option>
                                    <option value="rechazado" ${pedido.estado === 'rechazado' ? 'selected' : ''}>Rechazado</option>
                                    <option value="cancelado" ${pedido.estado === 'cancelado' ? 'selected' : ''}>Cancelado</option>
                                </select>
                            `}
                        </td>
                        <td>
                            ${pedido.notas ? `<span title="${pedido.notas}"><i class="bi bi-chat-text text-muted"></i> ${pedido.notas.substring(0, 30)}${pedido.notas.length > 30 ? '...' : ''}</span>` : '-'}
                        </td>
                        <td class="text-center">
                            <button class="btn-action btn-view me-1" onclick="verDetalle(${pedido.id})" title="Ver detalle">
                                <i class="bi bi-eye"></i>
                            </button>
                            ${pedido.estado !== 'facturado' ? `
                                <button class="btn-action btn-facturar" onclick="cargarEnVenta(${pedido.id})" title="Facturar">
                                    <i class="bi bi-receipt"></i>
                                </button>
                            ` : ''}
                        </td>
                    </tr>`;
            });
            
            tbody.innerHTML = html;
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // FILTROS
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        function filtrarEstado(estado) {
            estadoFiltro = estado;
            
            // Actualizar botones
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.estado === estado);
            });
            
            cargarPedidos();
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // CAMBIAR ESTADO
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        async function cambiarEstado(pedidoId, nuevoEstado) {
            console.log(`ğŸ”„ Cambiando pedido ${pedidoId} a estado: ${nuevoEstado}`);
            try {
                console.log('ğŸ“¡ Enviando peticiÃ³n...');
                const response = await fetch(`/api/admin/pedidos/${pedidoId}/estado`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ estado: nuevoEstado })
                });
                
                console.log('ğŸ“¡ Response status:', response.status);
                console.log('ğŸ“¡ Response ok:', response.ok);
                
                const data = await response.json();
                console.log('ğŸ“¥ Response data:', data);
                
                if (data.success) {
                    console.log('âœ… Ã‰xito, recargando pedidos...');
                    // Recargar
                    await cargarPedidos(true);
                    await cargarEstadisticas();
                    console.log('âœ… Pedidos recargados');
                } else {
                    console.log('âŒ Error del servidor:', data.error);
                    alert('Error: ' + data.error);
                }
            } catch (error) {
                console.error('âŒ Error de conexiÃ³n:', error);
                alert('Error de conexiÃ³n: ' + error.message);
            }
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // VER DETALLE - CON SOPORTE PARA PRODUCTOS PESABLES
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        async function verDetalle(pedidoId) {
            const modal = new bootstrap.Modal(document.getElementById('modalDetalle'));
            document.getElementById('modalPedidoId').textContent = '#' + pedidoId;
            document.getElementById('modalBody').innerHTML = '<div class="text-center py-4"><div class="spinner-border text-primary"></div></div>';
            
            modal.show();
            
            try {
                const response = await fetch(`/api/pedidos/detalle/${pedidoId}`);
                const data = await response.json();
                
                if (data.success) {
                    pedidoActual = data.pedido;
                    
                    // Determinar si se puede editar (pendiente o preparando)
                    const puedeEditar = ['pendiente', 'preparando', 'cotizado'].includes(data.pedido.estado);
                    const estaCotizado = data.pedido.estado === 'cotizado';
                    const estaAceptado = data.pedido.estado === 'aceptado';
                    const totalPendiente = data.pedido.total === 0 || data.pedido.total === null;
                    
                    let productosHtml = '';
                    
                    if (puedeEditar) {
                        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                        // MODO EDICIÃ“N - inputs para cantidades
                        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                        data.pedido.productos.forEach((p, index) => {
                            const esPesable = p.es_pesable || false;
                            const esExpandida = p.linea_expandida || false;
                            
                            const claseLinea = esExpandida ? 'linea-pesable' : '';
                            
                            let labelExtra = '';
                            if (esExpandida) {
                                labelExtra = `<span class="badge bg-warning text-dark ms-2">
                                    <i class="bi bi-speedometer2"></i> Unidad ${p.indice_unidad}/${p.total_unidades} - Ingresar peso
                                </span>`;
                            } else if (esPesable) {
                                labelExtra = `<span class="badge bg-warning text-dark ms-2">
                                    <i class="bi bi-speedometer2"></i> Pesable (KG)
                                </span>`;
                            }
                            
                            const placeholder = esPesable ? 'Peso en KG' : 'Cantidad';
                            const step = esPesable ? '0.001' : '0.01';
                            const inputClass = esPesable ? 'qty-input qty-pesable' : 'qty-input';
                            
                            productosHtml += `
                                <div class="producto-row-edit ${claseLinea}">
                                    <div style="flex: 1;">
                                        <div class="producto-nombre">
                                            ${p.nombre}
                                            ${labelExtra}
                                        </div>
                                        <div class="producto-codigo">${p.codigo} - $${formatNumber(p.precio_unitario || 0)}/u</div>
                                    </div>
                                    <div class="d-flex align-items-center gap-2">
                                        <input type="text" inputmode="decimal" class="${inputClass}" 
                                            id="qty_${p.detalle_id || index}" 
                                            data-detalle-id="${p.detalle_id || ''}"
                                            data-producto-id="${p.producto_id}"
                                            data-precio="${p.precio_unitario || 0}"
                                            data-es-pesable="${esPesable}"
                                            value="${p.cantidad}" 
                                            min="0" step="${step}"
                                            placeholder="${placeholder}"
                                            oninput="procesarInputPeso(this)" onchange="recalcularTotal()">
                                        <span class="subtotal-item" id="sub_${p.detalle_id || index}">$${formatNumber(p.subtotal || 0)}</span>
                                    </div>
                                </div>`;
                        });
                    } else {
                        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                        // MODO SOLO LECTURA - muestra cantidades/pesos
                        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                        data.pedido.productos.forEach(p => {
                            const esPesable = p.es_pesable || false;
                            const esExpandida = p.linea_expandida || false;
                            
                            // Clase CSS para lÃ­neas de pesables expandidas
                            const claseLinea = esExpandida ? 'linea-pesable' : '';
                            
                            // Etiqueta segÃºn tipo
                            let labelExtra = '';
                            if (esExpandida) {
                                labelExtra = `<span class="badge bg-info text-white ms-2">
                                    <i class="bi bi-speedometer2"></i> Unidad ${p.indice_unidad}/${p.total_unidades}
                                </span>`;
                            } else if (esPesable) {
                                labelExtra = '<span class="badge bg-secondary ms-2"><i class="bi bi-speedometer2"></i> KG</span>';
                            }
                            
                            // Formato de cantidad segÃºn tipo
                            let cantidadDisplay = p.cantidad;
                            if (esPesable) {
                                cantidadDisplay = p.cantidad.toFixed(3) + ' kg';
                            }
                            
                            productosHtml += `
                                <div class="producto-row ${claseLinea}">
                                    <div>
                                        <div class="producto-nombre">${p.nombre} ${labelExtra}</div>
                                        <div class="producto-codigo">${p.codigo}</div>
                                    </div>
                                    <div class="text-end">
                                        <div class="producto-qty">${cantidadDisplay} x $${formatNumber(p.precio_unitario)}</div>
                                        <div><strong>$${formatNumber(p.subtotal)}</strong></div>
                                    </div>
                                </div>`;
                        });
                    }
                    
                    // SecciÃ³n de totales
                    let totalesHtml = '';
                    if (puedeEditar) {
                        totalesHtml = `
                            <div class="total-pendiente">
                                <i class="bi bi-calculator me-2"></i>
                                <strong>${estaCotizado ? "EditÃ¡ los pesos y hacÃ© click en \"Re-cotizar\"" : "IngresÃ¡ las cantidades/pesos reales y hacÃ© click en \"Cotizar\""}</strong>
                            </div>
                            <div class="mt-3 text-end">
                                <div class="mb-2">
                                    <span>Subtotal: </span><strong id="subtotalCalc">$0,00</strong>
                                </div>
                                <div class="mb-2">
                                    <span>IVA (21%): </span><strong id="ivaCalc">$0,00</strong>
                                </div>
                                <div class="fs-5">
                                    <span>TOTAL: </span><strong class="text-success" id="totalCalc">$0,00</strong>
                                </div>
                            </div>`;
                    } else {
                        totalesHtml = `
                            <div class="row">
                                <div class="col-6">Subtotal:</div>
                                <div class="col-6 text-end">$${formatNumber(data.pedido.subtotal)}</div>
                            </div>
                            <div class="row">
                                <div class="col-6">IVA:</div>
                                <div class="col-6 text-end">$${formatNumber(data.pedido.iva)}</div>
                            </div>
                            <div class="row mt-2">
                                <div class="col-6"><strong>Total:</strong></div>
                                <div class="col-6 text-end"><strong class="text-success fs-5">$${formatNumber(data.pedido.total)}</strong></div>
                            </div>`;
                    }
                    
                    document.getElementById('modalBody').innerHTML = `
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <strong><i class="bi bi-person me-1"></i>Cliente:</strong><br>
                                ${data.pedido.cliente_nombre}<br>
                                <small class="text-muted">${data.pedido.cliente_documento}</small>
                            </div>
                            <div class="col-md-6 text-md-end">
                                <strong><i class="bi bi-calendar me-1"></i>Fecha:</strong><br>
                                ${data.pedido.fecha}<br>
                                <span class="estado-badge estado-${data.pedido.estado}">${data.pedido.estado.toUpperCase()}</span>
                            </div>
                        </div>
                        
                        <hr>
                        
                        <h6 class="mb-3">
                            <i class="bi bi-box me-1"></i>Productos
                            ${puedeEditar ? '<small class="text-muted">(editÃ¡ las cantidades/pesos segÃºn corresponda)</small>' : ''}
                        </h6>
                        ${productosHtml}
                        
                        <hr>
                        
                        ${totalesHtml}
                        
                        ${data.pedido.notas ? `<hr><p class="mb-0"><strong><i class="bi bi-chat-text me-1"></i>Notas:</strong><br>${data.pedido.notas}</p>` : ''}
                    `;
                    
                    // Footer con botones segÃºn estado
                    let footerHtml = '<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>';
                    
                    if (puedeEditar) {
                        footerHtml += `
                            <button type="button" class="btn-cotizar" onclick="cotizarPedido(${pedidoId})">
                                <i class="bi bi-calculator me-1"></i>${estaCotizado ? "Re-cotizar" : "Cotizar Pedido"}
                            </button>`;
                    }
                    
                    if (estaAceptado || estaCotizado) {
                        footerHtml += `
                            <button type="button" class="btn btn-success" onclick="cargarEnVenta(${pedidoId})">
                                <i class="bi bi-receipt me-1"></i>Facturar Pedido
                            </button>`;
                    }
                    
                    document.getElementById('modalFooter').innerHTML = footerHtml;
                    
                    // Si estÃ¡ en modo ediciÃ³n, calcular totales iniciales
                    if (puedeEditar) {
                        setTimeout(() => recalcularTotal(), 100);
                    }
                    
                } else {
                    document.getElementById('modalBody').innerHTML = `<div class="alert alert-danger">${data.error}</div>`;
                }
            } catch (error) {
                document.getElementById('modalBody').innerHTML = '<div class="alert alert-danger">Error al cargar detalle</div>';
            }
        }
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // DETECTAR CÃ“DIGO DE BALANZA EN INPUT DE PESO
        // Formato: 13 dÃ­gitos, posiciones 8-12 = peso en gramos
        // Ejemplo: 2003005021108 â†’ peso = 02110 = 2.110 kg
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function procesarInputPeso(input) {
            const valor = input.value.trim();
            
            // Solo procesar si es producto pesable
            if (input.dataset.esPesable !== 'true') return;
            
            // Detectar cÃ³digo de balanza: 13 dÃ­gitos
            if (/^\d{13}$/.test(valor)) {
                // Extraer peso de posiciones 8-12 (Ã­ndices 7-11 en JS, 0-indexed)
                const pesoGramos = valor.substring(7, 12);
                const pesoKg = parseInt(pesoGramos, 10) / 1000;
                
                console.log(`âš–ï¸ CÃ³digo balanza detectado: ${valor}`);
                console.log(`   Peso extraÃ­do: ${pesoGramos} g = ${pesoKg.toFixed(3)} kg`);
                
                // Actualizar el input con el peso en kg
                input.value = pesoKg.toFixed(3);
                
                // Recalcular totales
                recalcularTotal();
                
                // Mover al siguiente input automÃ¡ticamente
                const inputs = Array.from(document.querySelectorAll('.qty-input'));
                const currentIndex = inputs.indexOf(input);
                if (currentIndex < inputs.length - 1) {
                    setTimeout(() => {
                        inputs[currentIndex + 1].focus();
                        inputs[currentIndex + 1].select();
                    }, 100);
                }
            }
        }
                // Recalcular total en tiempo real
        function recalcularTotal() {
            let subtotal = 0;
            
            document.querySelectorAll('.qty-input').forEach(input => {
                const cantidad = parseFloat(input.value) || 0;
                const precio = parseFloat(input.dataset.precio) || 0;
                const itemSubtotal = cantidad * precio;
                
                // Actualizar subtotal del item
                const subId = input.id.replace('qty_', 'sub_');
                const subElement = document.getElementById(subId);
                if (subElement) {
                    subElement.textContent = '$' + formatNumber(itemSubtotal);
                }
                
                subtotal += itemSubtotal;
            });
            
            const iva = subtotal * 0.21;
            const total = subtotal + iva;
            
            const subtotalEl = document.getElementById('subtotalCalc');
            const ivaEl = document.getElementById('ivaCalc');
            const totalEl = document.getElementById('totalCalc');
            
            if (subtotalEl) subtotalEl.textContent = '$' + formatNumber(subtotal);
            if (ivaEl) ivaEl.textContent = '$' + formatNumber(iva);
            if (totalEl) totalEl.textContent = '$' + formatNumber(total);
        }

        // Cotizar pedido - guardar cantidades y calcular total
        async function cotizarPedido(pedidoId) {
            // Recoger cantidades CON es_pesable
            const items = [];
            document.querySelectorAll('.qty-input').forEach(input => {
                items.push({
                    detalle_id: input.dataset.detalleId,
                    producto_id: input.dataset.productoId,
                    cantidad: parseFloat(input.value) || 0,
                    precio_unitario: parseFloat(input.dataset.precio) || 0,
                    es_pesable: input.dataset.esPesable === 'true'  // â† AGREGADO
                });
            });
            
            if (items.some(i => i.cantidad <= 0)) {
                alert('Todas las cantidades/pesos deben ser mayores a 0');
                return;
            }
            
            try {
                const response = await fetch(`/api/admin/pedidos/${pedidoId}/cotizar`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ items })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert(`âœ… Pedido cotizado!\nTotal: $${formatNumber(data.total)}\n\nEl cliente puede verlo y aceptar/rechazar.`);
                    bootstrap.Modal.getInstance(document.getElementById('modalDetalle')).hide();
                    cargarPedidos(true);
                    cargarEstadisticas();
                } else {
                    alert('Error: ' + data.error);
                }
            } catch (error) {
                alert('Error de conexiÃ³n');
            }
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // CARGAR EN VENTA
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        async function cargarEnVenta(pedidoId) {
            try {
                const response = await fetch(`/api/admin/pedidos/${pedidoId}/cargar_venta`);
                const data = await response.json();
                
                if (data.success) {
                    // Guardar en sessionStorage para que nueva_venta lo lea
                    sessionStorage.setItem('pedido_para_facturar', JSON.stringify({
                        pedido_id: data.pedido_id,
                        cliente_id: data.cliente_id,
                        cliente_nombre: data.cliente_nombre,
                        lista_precio: data.lista_precio,
                        productos: data.productos
                    }));
                    
                    // Redirigir a nueva_venta
                    window.location.href = '/nueva_venta';
                } else {
                    alert('Error: ' + data.error);
                }
            } catch (error) {
                alert('Error de conexiÃ³n');
            }
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // UTILIDADES
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        function formatNumber(num) {
            return num.toLocaleString('es-AR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }
    </script>
</body>
</html>