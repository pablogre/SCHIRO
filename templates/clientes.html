<!-- templates/clientes.html -->
{% extends "base.html" %}

{% block title %}Clientes - POS Argentina{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2"><i class="fas fa-users"></i> Gesti√≥n de Clientes</h1>
    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modalCliente" onclick="limpiarFormCliente()">
        <i class="fas fa-plus"></i> Nuevo Cliente
    </button>
</div>

<!-- Filtros -->
<div class="card mb-3">
    <div class="card-body">
        <div class="row">
            <div class="col-md-4">
                <label class="form-label">Buscar cliente</label>
                <input type="text" class="form-control" id="buscarCliente" placeholder="Nombre o documento...">
            </div>
            <div class="col-md-3">
                <label class="form-label">Tipo documento</label>
                <select class="form-select" id="filtroTipoDoc">
                    <option value="">Todos</option>
                    <option value="DNI">DNI</option>
                    <option value="CUIT">CUIT</option>
                    <option value="CUIL">CUIL</option>
                    <option value="PASAPORTE">Pasaporte</option>
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label">Condici√≥n IVA</label>
                <select class="form-select" id="filtroCondicionIva">
                    <option value="">Todas</option>
                    <option value="CONSUMIDOR_FINAL">Consumidor Final</option>
                    <option value="IVA_RESPONSABLE_INSCRIPTO">Responsable Inscripto</option>
                    <option value="MONOTRIBUTISTA">Monotributista</option>
                </select>
            </div>
            <div class="col-md-2">
                <label class="form-label">&nbsp;</label>
                <div class="d-grid gap-2">
                    <button class="btn btn-primary" onclick="aplicarFiltrosClientes()">
                        <i class="fas fa-search"></i> Buscar
                    </button>
                    <button class="btn btn-secondary" onclick="limpiarFiltrosClientes()">
                        <i class="fas fa-eraser"></i> Limpiar
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Lista de clientes -->
<div class="card">
    <div class="card-header">
        <h5><i class="fas fa-list"></i> Listado de Clientes</h5>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <!-- ‚úÖ IMPORTANTE: Agregar ID a la tabla -->
            <table class="table table-striped table-hover" id="tablaClientes">
                <thead class="table-dark">
                    <tr>
                        <th>Nombre/Raz√≥n Social</th>
                        <th>Documento</th>
                        <th>Contacto</th>
                        <th>Condici√≥n IVA</th>
                        <th>Lista</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    {% for cliente in clientes %}
                    <tr>
                        <td>
                            <strong>{{ cliente.nombre }}</strong>
                            {% if cliente.direccion %}
                                <br><small class="text-muted">{{ cliente.direccion }}</small>
                            {% endif %}
                        </td>
                        <td>
                            {% if cliente.documento %}
                                <span class="badge bg-secondary">{{ cliente.tipo_documento }}</span><br>
                                <code>{{ cliente.documento }}</code>
                            {% else %}
                                <span class="text-muted">Sin documento</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if cliente.email %}
                                <i class="fas fa-envelope"></i> {{ cliente.email }}<br>
                            {% endif %}
                            {% if cliente.telefono %}
                                <i class="fas fa-phone"></i> {{ cliente.telefono }}
                            {% endif %}
                            {% if not cliente.email and not cliente.telefono %}
                                <span class="text-muted">Sin contacto</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if cliente.condicion_iva == 'IVA_RESPONSABLE_INSCRIPTO' %}
                                <span class="badge bg-success">Responsable Inscripto</span>
                            {% elif cliente.condicion_iva == 'MONOTRIBUTISTA' %}
                                <span class="badge bg-info">Monotributista</span>
                            {% elif cliente.condicion_iva == 'CONSUMIDOR_FINAL' %}
                                <span class="badge bg-warning text-dark">Consumidor Final</span>
                            {% else %}
                                <span class="badge bg-secondary">{{ cliente.condicion_iva.replace('_', ' ').title() if cliente.condicion_iva else 'Sin especificar' }}</span>
                            {% endif %}
                        </td>
                        <td>
                            {% set lista = cliente.lista_precio or 1 %}
                            {% if lista == 1 %}
                                <span class="badge bg-primary">L1 Minorista</span>
                            {% elif lista == 2 %}
                                <span class="badge bg-success">L2 Mayorista</span>
                            {% elif lista == 3 %}
                                <span class="badge bg-info">L3 Distribuidor</span>
                            {% elif lista == 4 %}
                                <span class="badge bg-warning text-dark">L4 Especial</span>
                            {% elif lista == 5 %}
                                <span class="badge bg-danger">L5 Promocional</span>
                            {% else %}
                                <span class="badge bg-secondary">L{{ lista }}</span>
                            {% endif %}
                        </td>
                        <td>
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-warning" onclick="editarCliente({{ cliente.id }})" title="Editar">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-info" onclick="verFacturas({{ cliente.id }})" title="Ver Facturas">
                                    <i class="fas fa-file-invoice"></i>
                                </button>
                                <button class="btn btn-success" onclick="nuevaVentaCliente({{ cliente.id }})" title="Nueva Venta">
                                    <i class="fas fa-cash-register"></i>
                                </button>
                                <button class="btn btn-danger" onclick="eliminarCliente({{ cliente.id }}, '{{ cliente.nombre.replace("'", "\\'") }}')" title="Eliminar">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Modal Cliente -->
<div class="modal fade" id="modalCliente" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="tituloModalCliente">
                    <i class="fas fa-plus"></i> Nuevo Cliente
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="formCliente">
                    <input type="hidden" id="clienteId">
                    <div class="mb-3">
                        <label for="nombreCliente" class="form-label">Nombre/Raz√≥n Social *</label>
                        <input type="text" class="form-control" id="nombreCliente" required>
                    </div>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="tipoDocumento" class="form-label">Tipo Documento</label>
                                <select class="form-select" id="tipoDocumento">
                                    <option value="DNI">DNI</option>
                                    <option value="CUIT">CUIT</option>
                                    <option value="CUIL">CUIL</option>
                                    <option value="PASAPORTE">Pasaporte</option>
                                    <option value="SIN_DOC">Sin documento</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-8">
                            <div class="mb-3">
                                <label for="documento" class="form-label">N√∫mero de Documento</label>
                                <input type="text" class="form-control" id="documento" placeholder="Sin guiones ni espacios">
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="email" class="form-label">Email</label>
                                <input type="email" class="form-control" id="email">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="telefono" class="form-label">Tel√©fono</label>
                                <input type="text" class="form-control" id="telefono">
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="direccion" class="form-label">Direcci√≥n</label>
                        <textarea class="form-control" id="direccion" rows="2" placeholder="Direcci√≥n completa"></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="condicionIva" class="form-label">Condici√≥n ante el IVA</label>
                        <select class="form-select" id="condicionIva">
                            <option value="CONSUMIDOR_FINAL">Consumidor Final</option>
                            <option value="IVA_RESPONSABLE_INSCRIPTO">IVA Responsable Inscripto</option>
                            <option value="MONOTRIBUTISTA">Monotributista</option>
                            <option value="IVA_NO_RESPONSABLE">IVA No Responsable</option>
                            <option value="IVA_SUJETO_EXENTO">IVA Sujeto Exento</option>
                        </select>
                        <div class="form-text">
                            Determina el tipo de comprobante que se le emitir√°
                        </div>
                    </div>
                    <!-- Campo Lista de Precios -->
                    <div class="mb-3">
                        <label for="listaPrecio" class="form-label">
                            <i class="fas fa-tags"></i> Lista de Precios
                        </label>
                        <select class="form-select" id="listaPrecio">
                            <option value="1">üìã Lista 1 - Minorista (Precio base)</option>
                            <option value="2">üìã Lista 2 - Mayorista</option>
                            <option value="3">üìã Lista 3 - Distribuidor</option>
                            <option value="4">üìã Lista 4 - Especial</option>
                            <option value="5">üìã Lista 5 - Promocional</option>
                        </select>
                        <div class="form-text">
                            <i class="fas fa-info-circle"></i> 
                            Selecciona la lista de precios que se aplicar√° a este cliente.<br>
                            <small class="text-muted">Tip: Para vender al costo, us√° una lista con margen 0%</small>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times"></i> Cancelar
                </button>
                <button type="button" class="btn btn-primary" onclick="guardarCliente()">
                    <i class="fas fa-save"></i> Guardar Cliente
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Variables globales
let clienteActual = null;

// Funci√≥n para limpiar el formulario
function limpiarFormCliente() {
    document.getElementById('formCliente').reset();
    document.getElementById('clienteId').value = '';
    document.getElementById('tituloModalCliente').innerHTML = '<i class="fas fa-plus"></i> Nuevo Cliente';
    clienteActual = null;
    
    // Limpiar validaciones
    const inputs = document.querySelectorAll('#formCliente input, #formCliente select, #formCliente textarea');
    inputs.forEach(input => {
        input.setCustomValidity('');
        input.classList.remove('is-invalid', 'is-valid');
    });
}

// Funci√≥n para cargar datos de cliente en el formulario
function cargarClienteEnFormulario(cliente) {
    document.getElementById('clienteId').value = cliente.id;
    document.getElementById('nombreCliente').value = cliente.nombre;
    document.getElementById('documento').value = cliente.documento || '';
    document.getElementById('tipoDocumento').value = cliente.tipo_documento || 'DNI';
    document.getElementById('email').value = cliente.email || '';
    document.getElementById('telefono').value = cliente.telefono || '';
    document.getElementById('direccion').value = cliente.direccion || '';
    document.getElementById('condicionIva').value = cliente.condicion_iva || 'CONSUMIDOR_FINAL';
    document.getElementById('listaPrecio').value = cliente.lista_precio || 1;
    
    document.getElementById('tituloModalCliente').innerHTML = '<i class="fas fa-edit"></i> Editar Cliente';
    clienteActual = cliente;
}

// Funci√≥n para editar cliente
function editarCliente(id) {
    fetch(`/api/cliente/${id}`)
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                alert('Error: ' + data.error);
                return;
            }
            
            cargarClienteEnFormulario(data);
            
            // Mostrar el modal
            const modal = new bootstrap.Modal(document.getElementById('modalCliente'));
            modal.show();
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error al cargar los datos del cliente');
        });
}

// Funci√≥n para guardar cliente
function guardarCliente() {
    const form = document.getElementById('formCliente');
    
    // Validar formulario
    if (!form.checkValidity()) {
        form.reportValidity();
        return;
    }
    
    // Recopilar datos del formulario
    const formData = {
        id: document.getElementById('clienteId').value || null,
        nombre: document.getElementById('nombreCliente').value.trim(),
        documento: document.getElementById('documento').value.trim(),
        tipo_documento: document.getElementById('tipoDocumento').value,
        email: document.getElementById('email').value.trim(),
        telefono: document.getElementById('telefono').value.trim(),
        direccion: document.getElementById('direccion').value.trim(),
        condicion_iva: document.getElementById('condicionIva').value,
        lista_precio: parseInt(document.getElementById('listaPrecio').value) || 1
    };
    
    // Validaciones adicionales
    if (!formData.nombre) {
        alert('El nombre es obligatorio');
        document.getElementById('nombreCliente').focus();
        return;
    }
    
    // Validar CUIT si es necesario
    if (formData.tipo_documento === 'CUIT' && formData.documento) {
        if (!/^\d{11}$/.test(formData.documento)) {
            alert('El CUIT debe tener exactamente 11 d√≠gitos sin guiones');
            document.getElementById('documento').focus();
            return;
        }
    }
    
    // Mostrar indicador de carga
    const btnGuardar = document.querySelector('#modalCliente .btn-primary');
    const textoOriginal = btnGuardar.innerHTML;
    btnGuardar.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Guardando...';
    btnGuardar.disabled = true;
    
    // Enviar datos al servidor
    fetch('/guardar_cliente', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(formData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            
            // Cerrar modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('modalCliente'));
            modal.hide();
            
            // Recargar la p√°gina para mostrar los cambios
            window.location.reload();
        } else {
            alert('Error: ' + (data.error || 'Error desconocido'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error de conexi√≥n al guardar el cliente');
    })
    .finally(() => {
        // Restaurar bot√≥n
        btnGuardar.innerHTML = textoOriginal;
        btnGuardar.disabled = false;
    });
}

// Funci√≥n para ver facturas del cliente
function verFacturas(id) {
    window.location.href = `/facturas?cliente_id=${id}`;
}

// Funci√≥n para nueva venta con cliente preseleccionado
function nuevaVentaCliente(id) {
    window.location.href = `/nueva_venta?cliente_id=${id}`;
}

// Funci√≥n para eliminar cliente
function eliminarCliente(id, nombre) {
    if (confirm(`¬øEst√° seguro que desea eliminar el cliente "${nombre}"?\n\nEsta acci√≥n no se puede deshacer.`)) {
        fetch(`/eliminar_cliente/${id}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.message);
                window.location.reload();
            } else {
                alert('Error: ' + (data.error || 'Error desconocido'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error de conexi√≥n al eliminar el cliente');
        });
    }
}

// Funci√≥n para limpiar filtros
function limpiarFiltrosClientes() {
    document.getElementById('buscarCliente').value = '';
    document.getElementById('filtroTipoDoc').value = '';
    document.getElementById('filtroCondicionIva').value = '';
    // ‚úÖ Recargar la p√°gina para mostrar todos los clientes ordenados
    window.location.reload();
}

// Funci√≥n para aplicar filtros
function aplicarFiltrosClientes() {
    const buscar = document.getElementById('buscarCliente').value.trim();
    const tipoDoc = document.getElementById('filtroTipoDoc').value;
    const condicionIva = document.getElementById('filtroCondicionIva').value;
    
    // Construir URL con par√°metros
    const params = new URLSearchParams();
    if (buscar) params.append('buscar', buscar);
    if (tipoDoc) params.append('tipo_documento', tipoDoc);
    if (condicionIva) params.append('condicion_iva', condicionIva);
    
    fetch(`/buscar_clientes?${params.toString()}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                actualizarTablaClientes(data.clientes);
            } else {
                alert('Error en la b√∫squeda: ' + (data.error || 'Error desconocido'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error de conexi√≥n en la b√∫squeda');
        });
}

// ‚úÖ FUNCI√ìN CORREGIDA - Actualizar la tabla de clientes
function actualizarTablaClientes(clientes) {
    // Buscar el tbody de la tabla por el ID correcto
    const tbody = document.querySelector('#tablaClientes tbody');
    
    if (!tbody) {
        console.error('No se encontr√≥ el tbody de la tabla');
        return;
    }
    
    if (clientes.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="6" class="text-center text-muted">
                    <i class="fas fa-search"></i> No se encontraron clientes
                </td>
            </tr>
        `;
        return;
    }
    
    tbody.innerHTML = clientes.map(cliente => {
        const condicionBadge = getCondicionIvaBadge(cliente.condicion_iva);
        const listaBadge = getListaPrecioBadge(cliente.lista_precio);
        // Escapar comillas simples en el nombre para JavaScript
        const nombreEscapado = cliente.nombre.replace(/'/g, "\\'");
        
        return `
            <tr>
                <td>
                    <strong>${cliente.nombre}</strong>
                    ${cliente.direccion ? `<br><small class="text-muted">${cliente.direccion}</small>` : ''}
                </td>
                <td>
                    ${cliente.documento ? 
                        `<span class="badge bg-secondary">${cliente.tipo_documento}</span><br><code>${cliente.documento}</code>` : 
                        '<span class="text-muted">Sin documento</span>'
                    }
                </td>
                <td>
                    ${cliente.email ? `<i class="fas fa-envelope"></i> ${cliente.email}<br>` : ''}
                    ${cliente.telefono ? `<i class="fas fa-phone"></i> ${cliente.telefono}` : ''}
                    ${!cliente.email && !cliente.telefono ? '<span class="text-muted">Sin contacto</span>' : ''}
                </td>
                <td>${condicionBadge}</td>
                <td>${listaBadge}</td>
                <td>
                    <div class="btn-group btn-group-sm">
                        <button class="btn btn-warning" onclick="editarCliente(${cliente.id})" title="Editar">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-info" onclick="verFacturas(${cliente.id})" title="Ver Facturas">
                            <i class="fas fa-file-invoice"></i>
                        </button>
                        <button class="btn btn-success" onclick="nuevaVentaCliente(${cliente.id})" title="Nueva Venta">
                            <i class="fas fa-cash-register"></i>
                        </button>
                        <button class="btn btn-danger" onclick="eliminarCliente(${cliente.id}, '${nombreEscapado}')" title="Eliminar">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </td>
            </tr>
        `;
    }).join('');
}

// Funci√≥n auxiliar para obtener el badge de condici√≥n IVA
function getCondicionIvaBadge(condicion) {
    switch(condicion) {
        case 'IVA_RESPONSABLE_INSCRIPTO':
            return '<span class="badge bg-success">Responsable Inscripto</span>';
        case 'MONOTRIBUTISTA':
            return '<span class="badge bg-info">Monotributista</span>';
        case 'CONSUMIDOR_FINAL':
            return '<span class="badge bg-warning text-dark">Consumidor Final</span>';
        default:
            return `<span class="badge bg-secondary">${(condicion || '').replace(/_/g, ' ')}</span>`;
    }
}

// Funci√≥n auxiliar para obtener el badge de lista de precios
function getListaPrecioBadge(lista) {
    const l = lista || 1;
    switch(l) {
        case 1: return '<span class="badge bg-primary">L1 Minorista</span>';
        case 2: return '<span class="badge bg-success">L2 Mayorista</span>';
        case 3: return '<span class="badge bg-info">L3 Distribuidor</span>';
        case 4: return '<span class="badge bg-warning text-dark">L4 Especial</span>';
        case 5: return '<span class="badge bg-danger">L5 Promocional</span>';
        default: return `<span class="badge bg-secondary">L${l}</span>`;
    }
}

// Event listeners
document.addEventListener('DOMContentLoaded', function() {
    // Validaci√≥n autom√°tica de CUIT
    document.getElementById('documento').addEventListener('input', function() {
        const tipoDoc = document.getElementById('tipoDocumento').value;
        const doc = this.value;
        
        if (tipoDoc === 'CUIT' && doc.length > 0) {
            if (!/^\d{11}$/.test(doc)) {
                this.setCustomValidity('El CUIT debe tener 11 d√≠gitos');
                this.classList.add('is-invalid');
            } else {
                this.setCustomValidity('');
                this.classList.remove('is-invalid');
                this.classList.add('is-valid');
            }
        } else {
            this.setCustomValidity('');
            this.classList.remove('is-invalid', 'is-valid');
        }
    });
    
    // B√∫squeda en tiempo real
    const inputBuscar = document.getElementById('buscarCliente');
    let timeoutBusqueda;
    
    inputBuscar.addEventListener('input', function() {
        clearTimeout(timeoutBusqueda);
        timeoutBusqueda = setTimeout(() => {
            aplicarFiltrosClientes();
        }, 500); // Esperar 500ms despu√©s de que el usuario deje de escribir
    });
    
    // Aplicar filtros cuando cambien los selects
    document.getElementById('filtroTipoDoc').addEventListener('change', aplicarFiltrosClientes);
    document.getElementById('filtroCondicionIva').addEventListener('change', aplicarFiltrosClientes);
    
    // Validar formulario en tiempo real
    const form = document.getElementById('formCliente');
    const inputs = form.querySelectorAll('input, select, textarea');
    
    inputs.forEach(input => {
        input.addEventListener('blur', function() {
            if (this.checkValidity()) {
                this.classList.remove('is-invalid');
                this.classList.add('is-valid');
            } else {
                this.classList.remove('is-valid');
                this.classList.add('is-invalid');
            }
        });
    });
    
    // Enviar formulario con Enter
    form.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            guardarCliente();
        }
    });
});
</script>
{% endblock %}