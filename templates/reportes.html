{% extends "base.html" %}

{% block title %}Reportes - FactuFacil{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2"><i class="fas fa-chart-line"></i> Centro de Reportes</h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <button class="btn btn-outline-secondary" onclick="exportarReportes()" type="button">
            <i class="fas fa-download"></i> Exportar
        </button>
    </div>
</div>

<!-- Navegaci√≥n de pesta√±as -->
<ul class="nav nav-tabs" id="reportesTabs" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link" data-bs-target="#ventas-producto" data-bs-toggle="tab" id="ventas-producto-tab" role="tab" type="button">
            <i class="fas fa-box"></i> Ventas por Producto
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" data-bs-target="#medios-pago" data-bs-toggle="tab" id="medios-pago-tab" role="tab" type="button">
            <i class="fas fa-credit-card"></i> Medios de Pago
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" data-bs-target="#gastos" data-bs-toggle="tab" id="gastos-tab" role="tab" type="button">
            <i class="fas fa-money-bill-alt"></i> Gastos y Egresos
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link active" data-bs-target="#caja-diaria" data-bs-toggle="tab" id="caja-diaria-tab" role="tab" type="button">
            <i class="fas fa-calculator"></i> Caja Diaria
        </button>
    </li>
</ul>

<!-- Contenido de las pesta√±as -->
<div class="tab-content" id="reportesTabContent">
    <!-- PESTA√ëA 1: VENTAS POR PRODUCTO -->
    <div class="tab-pane fade" id="ventas-producto" role="tabpanel">
        <div class="card mt-3">
            <div class="card-header bg-primary text-white">
                <h5><i class="fas fa-chart-bar"></i> Reporte de Ventas por Producto</h5>
            </div>
            <div class="card-body p-0">
                <iframe src="/reporte_ventas_parcial" style="width:100%; height:900px; border:none;"></iframe>
            </div>
        </div>
    </div>

    <!-- PESTA√ëA 2: MEDIOS DE PAGO -->
    <div class="tab-pane fade" id="medios-pago" role="tabpanel">
        <div class="card mt-3">
            <div class="card-header bg-success text-white">
                <h5><i class="fas fa-credit-card"></i> Reporte de Medios de Pago</h5>
            </div>
            <div class="card-body">
                <!-- Filtros -->
                <div class="row mb-3">
                    <div class="col-md-3">
                        <label class="form-label" for="fecha_medios_desde">Desde:</label>
                        <input class="form-control" id="fecha_medios_desde" type="date"/>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label" for="fecha_medios_hasta">Hasta:</label>
                        <input class="form-control" id="fecha_medios_hasta" type="date"/>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label"> </label>
                        <button class="btn btn-success w-100" onclick="cargarReporteMediosPago()" type="button">
                            <i class="fas fa-search"></i> Generar Reporte
                        </button>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label"> </label>
                        <button class="btn btn-outline-secondary w-100" onclick="establecerFechasMediosHoy()" type="button">
                            <i class="fas fa-calendar-day"></i> Hoy
                        </button>
                    </div>
                </div>
                <!-- Resultados -->
                <div id="reporte_medios_pago">
                    <div class="text-center text-muted py-4">
                        <i class="fas fa-chart-pie fa-3x mb-3"></i>
                        <h6>Selecciona un rango de fechas para ver el reporte de medios de pago</h6>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- PESTA√ëA 3: GASTOS -->
    <div class="tab-pane fade" id="gastos" role="tabpanel">
        <div class="card mt-3">
            <div class="card-header bg-danger text-white d-flex justify-content-between align-items-center">
                <h5><i class="fas fa-money-bill-alt"></i> Reporte de Gastos y Egresos</h5>
                <button class="btn btn-light btn-sm" data-bs-target="#modalNuevoGasto" data-bs-toggle="modal" type="button">
                    <i class="fas fa-plus"></i> Nuevo Gasto
                </button>
            </div>
            <div class="card-body">
                <!-- Filtros -->
                <div class="row mb-3">
                    <div class="col-md-3">
                        <label class="form-label" for="fecha_gastos_desde">Desde:</label>
                        <input class="form-control" id="fecha_gastos_desde" type="date"/>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label" for="fecha_gastos_hasta">Hasta:</label>
                        <input class="form-control" id="fecha_gastos_hasta" type="date"/>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label"> </label>
                        <button class="btn btn-danger w-100" onclick="cargarReporteGastos()" type="button">
                            <i class="fas fa-search"></i> Generar Reporte
                        </button>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label"> </label>
                        <button class="btn btn-outline-secondary w-100" onclick="establecerFechasGastosHoy()" type="button">
                            <i class="fas fa-calendar-day"></i> Hoy
                        </button>
                    </div>
                </div>
                <!-- Resultados de gastos -->
                <div class="row">
                    <div class="col-md-8">
                        <h6><i class="fas fa-list"></i> Gastos del Per√≠odo</h6>
                        <div id="listaGastos">
                            <div class="text-center text-muted py-4">
                                <i class="fas fa-receipt fa-3x mb-3"></i>
                                <h6>Selecciona un per√≠odo para ver los gastos</h6>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <h6><i class="fas fa-chart-pie"></i> Categor√≠as de Gastos</h6>
                        <div id="categoriasGastos">
                            <div class="text-center text-muted py-4">
                                <i class="fas fa-tags fa-2x mb-3"></i>
                                <p>Sin datos de categor√≠as</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- PESTA√ëA 4: CAJA DIARIA CORREGIDA -->
    <div class="tab-pane fade show active" id="caja-diaria" role="tabpanel">
        <!-- Estado de la caja -->
        <div class="row mb-3">
            <div class="col-12">
                <div class="card" id="estadoCajaCard">
                    <div class="card-header bg-warning text-dark d-flex justify-content-between align-items-center">
                        <h6><i class="fas fa-cash-register"></i> Estado de Caja</h6>
                        <div>
                            <button class="btn btn-success btn-sm" id="btnApertura" onclick="mostrarModalApertura()">
                                <i class="fas fa-unlock"></i> Abrir Caja
                            </button>
                            <button class="btn btn-danger btn-sm d-none" id="btnCierre" onclick="mostrarModalCierre()">
                                <i class="fas fa-lock"></i> Cerrar Caja
                            </button>
                        </div>
                    </div>
                    <div class="card-body text-center">
                        <h5 id="estadoCaja">CARGANDO...</h5>
                        <p id="detalleCaja" class="mb-0">Verificando estado de caja...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Resumen mejorado -->
        <div class="row mb-4">
            <div class="col-md-2">
                <div class="card bg-secondary text-white">
                    <div class="card-body text-center">
                        <h6><i class="fas fa-play"></i> Apertura</h6>
                        <h4 id="montoApertura">$0.00</h4>
                        <small id="horaApertura">--:--</small>
                    </div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="card bg-success text-white">
                    <div class="card-body text-center">
                        <h6><i class="fas fa-shopping-cart"></i> Ventas</h6>
                        <h4 id="totalVentasCaja">$0.00</h4>
                        <small id="detalleVentas">0 ventas</small>
                    </div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="card bg-danger text-white">
                    <div class="card-body text-center">
                        <h6><i class="fas fa-receipt"></i> Gastos</h6>
                        <h4 id="totalGastosCaja">$0.00</h4>
                        <small id="detalleGastos">0 gastos</small>
                    </div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="card bg-primary text-white">
                    <div class="card-body text-center">
                        <h6><i class="fas fa-exchange-alt"></i> Movimientos</h6>
                        <h4 id="movimientosCaja">$0.00</h4>
                        <small id="detalleMovimientos">0 movimientos</small>
                    </div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="card bg-warning text-dark">
                    <div class="card-body text-center">
                        <h6><i class="fas fa-calculator"></i> Te√≥rico</h6>
                        <h4 id="efectivoCaja">$0.00</h4>
                        <small id="detalleEfectivo">Calculado</small>
                    </div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="card bg-dark text-white">
                    <div class="card-body text-center">
                        <h6><i class="fas fa-lock"></i> Cierre</h6>
                        <h4 id="montoCierre">$0.00</h4>
                        <small id="horaCierre">--:--</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Movimientos de caja -->
        <div class="row mb-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h6><i class="fas fa-list"></i> Movimientos Adicionales de Caja</h6>
                        <div>
                            <button class="btn btn-sm btn-outline-success" onclick="mostrarModalMovimiento('ingreso')" id="btnIngreso" disabled>
                                <i class="fas fa-plus"></i> Ingreso
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="mostrarModalMovimiento('egreso')" id="btnEgreso" disabled>
                                <i class="fas fa-minus"></i> Egreso
                            </button>
                            <button class="btn btn-sm btn-outline-info" onclick="mostrarDesgloseCaja()" id="btnDesglose" disabled>
                                <i class="fas fa-calculator"></i> Desglose
                            </button>
                            <button class="btn btn-sm btn-outline-primary" onclick="imprimirEstadoCaja()" id="btnImprimir" disabled>
                                <i class="fas fa-print"></i> Imprimir
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div id="listaMovimientosCaja" style="max-height: 250px; overflow-y: auto;">
                            <p class="text-muted text-center">Verificando movimientos...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Filtros hist√≥ricos -->
        <div class="card mt-3">
            <div class="card-header bg-info text-white">
                <h5><i class="fas fa-history"></i> Consulta Hist√≥rica</h5>
            </div>
            <div class="card-body">
                <div class="row mb-4">
                    <div class="col-md-3">
                        <label class="form-label" for="fecha_caja_desde">Desde:</label>
                        <input class="form-control" id="fecha_caja_desde" type="date"/>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label" for="fecha_caja_hasta">Hasta:</label>
                        <input class="form-control" id="fecha_caja_hasta" type="date"/>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label"> </label>
                        <button class="btn btn-info w-100" onclick="cargarHistorialCajas()" type="button">
                            <i class="fas fa-search"></i> Buscar
                        </button>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label"> </label>
                        <button class="btn btn-outline-secondary w-100" onclick="establecerFechasCajaHoy()" type="button">
                            <i class="fas fa-calendar-day"></i> Hoy
                        </button>
                    </div>
                </div>
                <div id="historialCajas">
                    <div class="text-center text-muted py-4">
                        <i class="fas fa-history fa-3x mb-3"></i>
                        <h6>Selecciona un per√≠odo para ver el historial</h6>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal para Nuevo Gasto -->
<div class="modal fade" id="modalNuevoGasto" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title"><i class="fas fa-plus"></i> Registrar Nuevo Gasto</h5>
                <button class="btn-close btn-close-white" data-bs-dismiss="modal" type="button"></button>
            </div>
            <div class="modal-body">
                <form id="formNuevoGasto">
                    <div class="row">
                        <div class="col-md-8">
                            <label class="form-label" for="descripcionGasto">Descripci√≥n del Gasto *</label>
                            <input class="form-control" id="descripcionGasto" placeholder="Ej: Compra de insumos, Pago de servicios, etc." required="" type="text"/>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label" for="montoGasto">Monto *</label>
                            <div class="input-group">
                                <span class="input-group-text">$</span>
                                <input class="form-control" id="montoGasto" min="0.01" placeholder="0.00" required="" step="0.01" type="number"/>
                            </div>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-md-4">
                            <label class="form-label" for="categoriaGasto">Categor√≠a</label>
                            <select class="form-control" id="categoriaGasto">
                                <option value="general">General</option>
                                <option value="insumos">Insumos y Materiales</option>
                                <option value="servicios">Servicios (Luz, Gas, Internet)</option>
                                <option value="transporte">Transporte y Combustible</option>
                                <option value="personal">Gastos de Personal</option>
                                <option value="mantenimiento">Mantenimiento</option>
                                <option value="impuestos">Impuestos y Tasas</option>
                                <option value="otros">Otros</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label" for="fechaGasto">Fecha</label>
                            <input class="form-control" id="fechaGasto" type="date"/>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label" for="metodoPagoGasto">M√©todo de Pago</label>
                            <select class="form-control" id="metodoPagoGasto">
                                <option value="efectivo">Efectivo</option>
                                <option value="credito">Tarjeta de Cr√©dito</option>
                                <option value="debito">Tarjeta de D√©bito</option>
                                <option value="transferencia">Transferencia</option>
                                <option value="cheque">Cheque</option>
                            </select>
                        </div>
                    </div>
                    <div class="mt-3">
                        <label class="form-label" for="notasGasto">Notas Adicionales</label>
                        <textarea class="form-control" id="notasGasto" placeholder="Informaci√≥n adicional sobre el gasto (opcional)" rows="2"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" data-bs-dismiss="modal" type="button">Cancelar</button>
                <button class="btn btn-danger" onclick="guardarNuevoGasto()" type="button">
                    <i class="fas fa-save"></i> Guardar Gasto
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Apertura de Caja -->
<div class="modal fade" id="modalAperturaCaja" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title"><i class="fas fa-unlock"></i> Apertura de Caja</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="formAperturaCaja">
                    <div class="mb-3">
                        <label for="montoInicialCaja" class="form-label">Monto Inicial en Efectivo *</label>
                        <div class="input-group">
                            <span class="input-group-text">$</span>
                            <input type="number" class="form-control" id="montoInicialCaja" 
                                   min="0" step="0.01" required placeholder="0.00">
                        </div>
                        <div class="form-text">Dinero en efectivo con el que inicia la caja</div>
                    </div>
                    <div class="mb-3">
                        <label for="observacionesAperturaCaja" class="form-label">Observaciones</label>
                        <textarea class="form-control" id="observacionesAperturaCaja" rows="2" 
                                  placeholder="Notas sobre la apertura (opcional)"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-success" onclick="procesarAperturaCaja()">
                    <i class="fas fa-unlock"></i> Abrir Caja
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Cierre de Caja -->
<div class="modal fade" id="modalCierreCaja" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title"><i class="fas fa-lock"></i> Cierre de Caja</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row mb-3">
                    <div class="col-md-6">
                        <div class="alert alert-info">
                            <h6>Efectivo Te√≥rico</h6>
                            <h4 id="efectivoTeoricoModal">$0.00</h4>
                            <small>Seg√∫n sistema</small>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="alert alert-warning">
                            <h6>Conteo Real *</h6>
                            <div class="input-group">
                                <span class="input-group-text">$</span>
                                <input type="number" class="form-control" id="conteoRealCaja" 
                                       min="0" step="0.01" required placeholder="0.00">
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-12">
                        <div class="alert" id="alertaDiferenciaCaja" style="display: none;">
                            <h6 id="textoDiferenciaCaja"></h6>
                        </div>
                    </div>
                </div>
                <form id="formCierreCaja">
                    <div class="mb-3">
                        <label for="observacionesCierreCaja" class="form-label">Observaciones del Cierre</label>
                        <textarea class="form-control" id="observacionesCierreCaja" rows="3" 
                                  placeholder="Notas sobre el cierre, diferencias encontradas, etc."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-danger" onclick="procesarCierreCaja()">
                    <i class="fas fa-lock"></i> Cerrar Caja
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Movimiento de Caja -->
<div class="modal fade" id="modalMovimientoCaja" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header" id="headerMovimientoCaja">
                <h5 class="modal-title" id="tituloMovimientoCaja"></h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="formMovimientoCaja">
                    <input type="hidden" id="tipoMovimientoCaja">
                    <div class="mb-3">
                        <label for="descripcionMovimientoCaja" class="form-label">Descripci√≥n *</label>
                        <input type="text" class="form-control" id="descripcionMovimientoCaja" required
                               placeholder="Ej: Cambio de billetes, Fondo adicional, etc.">
                    </div>
                    <div class="mb-3">
                        <label for="montoMovimientoCaja" class="form-label">Monto *</label>
                        <div class="input-group">
                            <span class="input-group-text">$</span>
                            <input type="number" class="form-control" id="montoMovimientoCaja" 
                                   min="0.01" step="0.01" required placeholder="0.00">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="notasMovimientoCaja" class="form-label">Notas Adicionales</label>
                        <textarea class="form-control" id="notasMovimientoCaja" rows="2"
                                  placeholder="Informaci√≥n adicional (opcional)"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn" id="btnGuardarMovimientoCaja" onclick="procesarMovimientoCaja()">
                    Guardar
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// Variables globales para el sistema de caja
let cajaActual = null;
let movimientosCajaActuales = [];

// Funci√≥n para establecer fechas de hoy para cada secci√≥n
function establecerFechasHoy(prefijo) {
    const hoy = new Date().toISOString().split('T')[0];
    const campoDesde = document.getElementById(`fecha_${prefijo}_desde`);
    const campoHasta = document.getElementById(`fecha_${prefijo}_hasta`);
    
    if (campoDesde) campoDesde.value = hoy;
    if (campoHasta) campoHasta.value = hoy;
}

function establecerFechasVentasHoy() { establecerFechasHoy('ventas'); }
function establecerFechasMediosHoy() { establecerFechasHoy('medios'); }
function establecerFechasGastosHoy() { 
    establecerFechasHoy('gastos'); 
    const fechaGasto = document.getElementById('fechaGasto');
    if (fechaGasto) fechaGasto.value = new Date().toISOString().split('T')[0];
}
function establecerFechasCajaHoy() { establecerFechasHoy('caja'); }

// Funci√≥n para formatear pesos
function formatearPesos(cantidad) {
    if (cantidad === null || cantidad === undefined || isNaN(cantidad)) {
        return '$0,00';
    }
    return '$' + parseFloat(cantidad).toLocaleString('es-AR', {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
    });
}

// ======= FUNCIONES DE CAJA CORREGIDAS =======

function verificarEstadoCaja() {
    console.log('üîç Verificando estado de caja...');
    
    fetch('/api/caja/estado')
        .then(response => {
            console.log('üì° Response status:', response.status);
            if (!response.ok) {
                throw new Error('No hay caja abierta');
            }
            return response.json();
        })
        .then(data => {
            console.log('üìä Datos de caja recibidos:', data);
            if (data.success && data.caja_abierta) {
                mostrarCajaAbierta(data.caja);
                cargarMovimientosCaja();
                setTimeout(() => actualizarEfectivoTeoricoEnTiempoReal(), 500);
            } else {
                cargarUltimaCajaCerrada();
            }
        })
        .catch(error => {
            console.log('‚ùå Error o no hay caja abierta:', error.message);
            cargarUltimaCajaCerrada();
        });
}

function cargarUltimaCajaCerrada() {
    console.log('üîç Buscando √∫ltima caja cerrada...');
    
    fetch('/api/caja/ultima')
        .then(response => {
            if (!response.ok) {
                throw new Error('No hay cajas registradas');
            }
            return response.json();
        })
        .then(data => {
            console.log('üìä √öltima caja encontrada:', data);
            if (data.success && data.caja && data.caja.estado === 'cerrada') {
                mostrarCajaCerradaConDatos(data.caja);
                cargarMovimientosCajaHistoricos(data.caja.id);
            } else {
                mostrarCajaCerrada();
            }
        })
        .catch(error => {
            console.log('‚ùå Error cargando √∫ltima caja:', error.message);
            mostrarCajaCerrada();
        });
}

function mostrarCajaAbierta(caja) {
    console.log('‚úÖ Mostrando caja abierta:', caja);
    
    const card = document.getElementById('estadoCajaCard');
    card.className = 'card border-success';
    
    const fechaApertura = new Date(caja.fecha_apertura);
    
    document.getElementById('btnImprimir').disabled = false;
    document.getElementById('estadoCaja').textContent = 'CAJA ABIERTA';
    document.getElementById('estadoCaja').className = 'h5 text-success mb-1';
    document.getElementById('detalleCaja').innerHTML = 
        `Abierta: ${fechaApertura.toLocaleString('es-AR')}<br>
         Monto inicial: ${formatearPesos(caja.monto_inicial)}`;
    
    // Habilitar botones
    document.getElementById('btnApertura').classList.add('d-none');
    document.getElementById('btnCierre').classList.remove('d-none');
    document.getElementById('btnIngreso').disabled = false;
    document.getElementById('btnEgreso').disabled = false;
    document.getElementById('btnDesglose').disabled = false;
    
    // Actualizar tarjetas
    document.getElementById('montoApertura').textContent = formatearPesos(caja.monto_inicial);
    document.getElementById('horaApertura').textContent = fechaApertura.toLocaleTimeString('es-AR');
    document.getElementById('efectivoCaja').textContent = formatearPesos(caja.efectivo_teorico || caja.monto_inicial);
    
    cajaActual = caja;
}

// Funci√≥n corregida para mostrar caja cerrada CON gastos
function mostrarCajaCerradaConDatos(cajaCerrada) {
    console.log('üìã Mostrando caja cerrada con datos:', cajaCerrada);
    
    const card = document.getElementById('estadoCajaCard');
    card.className = 'card border-secondary';
    
    const fechaApertura = new Date(cajaCerrada.fecha_apertura);
    const fechaCierre = cajaCerrada.fecha_cierre ? new Date(cajaCerrada.fecha_cierre) : null;
   
    // Habilitar/deshabilitar botones seg√∫n el estado
    document.getElementById('btnImprimir').disabled = false;
    document.getElementById('estadoCaja').textContent = 'CAJA CERRADA';
    document.getElementById('estadoCaja').className = 'h5 text-secondary mb-1';
    document.getElementById('detalleCaja').innerHTML = 
        `Cerrada: ${fechaCierre ? fechaCierre.toLocaleString('es-AR') : 'Fecha no disponible'}<br>
         Diferencia: ${formatearPesos(cajaCerrada.diferencia || 0)}`;
    
    // Configurar botones
    document.getElementById('btnApertura').classList.remove('d-none');
    document.getElementById('btnCierre').classList.add('d-none');
    document.getElementById('btnIngreso').disabled = true;
    document.getElementById('btnEgreso').disabled = true;
    document.getElementById('btnDesglose').disabled = true;
    
    // Mostrar datos hist√≥ricos
    document.getElementById('montoApertura').textContent = formatearPesos(cajaCerrada.monto_inicial);
    document.getElementById('horaApertura').textContent = fechaApertura.toLocaleTimeString('es-AR');
    document.getElementById('efectivoCaja').textContent = formatearPesos(cajaCerrada.efectivo_teorico);
    document.getElementById('montoCierre').textContent = formatearPesos(cajaCerrada.efectivo_real);
    document.getElementById('horaCierre').textContent = fechaCierre ? fechaCierre.toLocaleTimeString('es-AR') : '--:--';
    
    cajaActual = cajaCerrada;
    
    // ‚úÖ AGREGAR ESTAS L√çNEAS PARA CARGAR GASTOS Y VENTAS
    cargarMovimientosCajaHistoricos(cajaCerrada.id);
    cargarDatosHistoricosCaja(cajaCerrada.id); // Nueva funci√≥n para cargar gastos/ventas
}

function cargarDatosHistoricosCaja(cajaId) {
    console.log('üìä Cargando datos hist√≥ricos para caja:', cajaId);
    
    fetch(`/api/caja/${cajaId}/resumen`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const ventas = data.resumen.totales.ventas_sistema;
                const gastos = data.resumen.totales.gastos_sistema;
                const movimientos = data.resumen.totales.movimientos_manuales;
                
                // Actualizar tarjetas con datos hist√≥ricos
                document.getElementById('totalVentasCaja').textContent = formatearPesos(ventas.total_efectivo);
                document.getElementById('detalleVentas').textContent = `${ventas.cantidad_ventas} ventas`;
                
                document.getElementById('totalGastosCaja').textContent = formatearPesos(gastos.total_efectivo);
                document.getElementById('detalleGastos').textContent = `${gastos.cantidad_gastos} gastos`;
                
                const balanceMovimientos = movimientos.total_ingresos - movimientos.total_egresos;
                document.getElementById('movimientosCaja').textContent = formatearPesos(balanceMovimientos);
                document.getElementById('detalleMovimientos').textContent = `${movimientos.total_movimientos} movimientos`;
                
                console.log('‚úÖ Datos hist√≥ricos cargados exitosamente');
            } else {
                console.warn('‚ö†Ô∏è No se pudieron cargar datos hist√≥ricos:', data.error);
                // Mantener valores en 0 si no hay datos
                document.getElementById('totalVentasCaja').textContent = '$0.00';
                document.getElementById('detalleVentas').textContent = '0 ventas';
                document.getElementById('totalGastosCaja').textContent = '$0.00';
                document.getElementById('detalleGastos').textContent = '0 gastos';
                document.getElementById('movimientosCaja').textContent = '$0.00';
                document.getElementById('detalleMovimientos').textContent = '0 movimientos';
            }
        })
        .catch(error => {
            console.error('‚ùå Error cargando datos hist√≥ricos:', error);
            // En caso de error, mostrar valores en 0
            document.getElementById('totalVentasCaja').textContent = '$0.00';
            document.getElementById('detalleVentas').textContent = '0 ventas';
            document.getElementById('totalGastosCaja').textContent = '$0.00';
            document.getElementById('detalleGastos').textContent = '0 gastos';
            document.getElementById('movimientosCaja').textContent = '$0.00';
            document.getElementById('detalleMovimientos').textContent = '0 movimientos';
        });
}


function mostrarCajaCerrada() {
    console.log('üö´ Mostrando caja cerrada sin datos');
    
    const card = document.getElementById('estadoCajaCard');
    card.className = 'card border-warning';
    
    document.getElementById('estadoCaja').textContent = 'CAJA CERRADA';
    document.getElementById('estadoCaja').className = 'h5 text-warning mb-1';
    document.getElementById('detalleCaja').textContent = 'No hay una caja activa';
    
    // Configurar botones
    document.getElementById('btnApertura').classList.remove('d-none');
    document.getElementById('btnCierre').classList.add('d-none');
    document.getElementById('btnIngreso').disabled = true;
    document.getElementById('btnEgreso').disabled = true;
    document.getElementById('btnDesglose').disabled = true;
    document.getElementById('btnImprimir').disabled = true; // Tambi√©n deshabilitar imprimir si no hay datos
    
    // Limpiar TODOS los datos (incluir gastos y ventas)
    document.getElementById('montoApertura').textContent = '$0.00';
    document.getElementById('horaApertura').textContent = '--:--';
    document.getElementById('efectivoCaja').textContent = '$0.00';
    document.getElementById('montoCierre').textContent = '$0.00';
    document.getElementById('horaCierre').textContent = '--:--';
    
    // ‚úÖ LIMPIAR TAMBI√âN GASTOS Y VENTAS
    document.getElementById('totalVentasCaja').textContent = '$0.00';
    document.getElementById('detalleVentas').textContent = '0 ventas';
    document.getElementById('totalGastosCaja').textContent = '$0.00';
    document.getElementById('detalleGastos').textContent = '0 gastos';
    document.getElementById('movimientosCaja').textContent = '$0.00';
    document.getElementById('detalleMovimientos').textContent = '0 movimientos';
    
    document.getElementById('listaMovimientosCaja').innerHTML = 
        '<p class="text-muted text-center">Abra una caja para registrar movimientos</p>';
    
    cajaActual = null;
    movimientosCajaActuales = [];
}


function cargarMovimientosCaja() {
    if (!cajaActual) return;

    console.log('üìã Cargando movimientos de caja...');

    fetch(`/api/caja/${cajaActual.id}/movimientos`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                movimientosCajaActuales = data.movimientos;
                mostrarMovimientosCaja();
                actualizarTarjetasMovimientos();
            }
        })
        .catch(error => {
            console.log('‚ùå Error al cargar movimientos, usando array vac√≠o');
            movimientosCajaActuales = [];
            mostrarMovimientosCaja();
        });
}

function cargarMovimientosCajaHistoricos(cajaId) {
    console.log('üìã Cargando movimientos hist√≥ricos para caja:', cajaId);
    
    fetch(`/api/caja/${cajaId}/movimientos`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                movimientosCajaActuales = data.movimientos;
                mostrarMovimientosCajaHistoricos();
            } else {
                document.getElementById('listaMovimientosCaja').innerHTML = 
                    '<p class="text-muted text-center">No hay movimientos para mostrar</p>';
            }
        })
        .catch(error => {
            console.log('‚ùå Error cargando movimientos hist√≥ricos:', error);
            document.getElementById('listaMovimientosCaja').innerHTML = 
                '<p class="text-muted text-center">Error cargando movimientos</p>';
        });
}

function mostrarMovimientosCaja() {
    const container = document.getElementById('listaMovimientosCaja');
    
    if (movimientosCajaActuales.length === 0) {
        container.innerHTML = '<p class="text-muted text-center">No hay movimientos registrados</p>';
        return;
    }

    let html = '';
    movimientosCajaActuales.forEach(mov => {
        const clase = mov.tipo === 'ingreso' ? 'text-success' : 'text-danger';
        const icono = mov.tipo === 'ingreso' ? 'fa-plus' : 'fa-minus';
        const signo = mov.tipo === 'ingreso' ? '+' : '-';
        const fecha = new Date(mov.fecha).toLocaleString('es-AR');
        
        html += `
            <div class="border-bottom pb-2 mb-2">
                <div class="d-flex justify-content-between align-items-center">
                    <span><i class="fas ${icono} ${clase}"></i> ${mov.descripcion}</span>
                    <strong class="${clase}">${signo}${formatearPesos(mov.monto)}</strong>
                </div>
                <small class="text-muted">${fecha}</small>
                ${mov.notas ? `<br><small class="text-muted">${mov.notas}</small>` : ''}
            </div>
        `;
    });
    
    container.innerHTML = html;
}

function mostrarMovimientosCajaHistoricos() {
    const container = document.getElementById('listaMovimientosCaja');
    
    if (movimientosCajaActuales.length === 0) {
        container.innerHTML = `
            <div class="alert alert-info">
                <i class="fas fa-info-circle"></i> <strong>Caja Cerrada</strong> - Sin movimientos registrados
            </div>
        `;
        return;
    }

    let html = `
        <div class="alert alert-info mb-3">
            <i class="fas fa-info-circle"></i> <strong>Caja Cerrada</strong> - Consulta hist√≥rica
        </div>
    `;
    
    movimientosCajaActuales.forEach(mov => {
        const clase = mov.tipo === 'ingreso' ? 'text-success' : 'text-danger';
        const icono = mov.tipo === 'ingreso' ? 'fa-plus' : 'fa-minus';
        const signo = mov.tipo === 'ingreso' ? '+' : '-';
        const fecha = new Date(mov.fecha).toLocaleString('es-AR');
        
        html += `
            <div class="border-bottom pb-2 mb-2">
                <div class="d-flex justify-content-between align-items-center">
                    <span><i class="fas ${icono} ${clase}"></i> ${mov.descripcion}</span>
                    <strong class="${clase}">${signo}${formatearPesos(mov.monto)}</strong>
                </div>
                <small class="text-muted">${fecha}</small>
                ${mov.notas ? `<br><small class="text-muted">${mov.notas}</small>` : ''}
            </div>
        `;
    });
    
    container.innerHTML = html;
}

function actualizarTarjetasMovimientos() {
    const totalIngresos = movimientosCajaActuales
        .filter(m => m.tipo === 'ingreso')
        .reduce((sum, m) => sum + parseFloat(m.monto), 0);
    
    const totalEgresos = movimientosCajaActuales
        .filter(m => m.tipo === 'egreso')
        .reduce((sum, m) => sum + parseFloat(m.monto), 0);
    
    const balanceMovimientos = totalIngresos - totalEgresos;
    
    document.getElementById('movimientosCaja').textContent = formatearPesos(balanceMovimientos);
    document.getElementById('detalleMovimientos').textContent = `${movimientosCajaActuales.length} movimientos`;
}

function actualizarEfectivoTeoricoEnTiempoReal() {
    if (!cajaActual) return;
    
    console.log('üßÆ Actualizando efectivo te√≥rico desde backend...');
    
    fetch(`/api/caja/${cajaActual.id}/resumen`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const efectivoTeorico = data.resumen.totales.efectivo_teorico;
                const ventasEfectivo = data.resumen.totales.ventas_sistema.total_efectivo;
                const gastosEfectivo = data.resumen.totales.gastos_sistema.total_efectivo;
                
                document.getElementById('efectivoCaja').textContent = formatearPesos(efectivoTeorico);
                document.getElementById('totalVentasCaja').textContent = formatearPesos(ventasEfectivo);
                document.getElementById('totalGastosCaja').textContent = formatearPesos(gastosEfectivo);
                
                document.getElementById('detalleVentas').textContent = `${data.resumen.totales.ventas_sistema.cantidad_ventas} ventas`;
                document.getElementById('detalleGastos').textContent = `${data.resumen.totales.gastos_sistema.cantidad_gastos} gastos`;
                
                cajaActual.efectivo_teorico = efectivoTeorico;
                
                console.log('‚úÖ Efectivo te√≥rico actualizado:', efectivoTeorico);
            }
        })
        .catch(error => {
            console.error('‚ùå Error actualizando efectivo te√≥rico:', error);
        });
}

// ======= FUNCIONES DE MODALES =======

function mostrarModalApertura() {
    console.log('üîì Abriendo modal de apertura');
    
    document.getElementById('montoInicialCaja').value = '';
    document.getElementById('observacionesAperturaCaja').value = '';
    
    new bootstrap.Modal(document.getElementById('modalAperturaCaja')).show();
}

function procesarAperturaCaja() {
    const monto = parseFloat(document.getElementById('montoInicialCaja').value);
    const observaciones = document.getElementById('observacionesAperturaCaja').value.trim();

    if (!monto || monto < 0) {
        alert('Ingrese un monto inicial v√°lido');
        return;
    }

    console.log('üí∞ Procesando apertura de caja:', { monto, observaciones });

    const btnAbrir = document.querySelector('#modalAperturaCaja .btn-success');
    const textoOriginal = btnAbrir.innerHTML;
    btnAbrir.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Abriendo...';
    btnAbrir.disabled = true;

    const apertura = {
        monto_inicial: monto,
        observaciones: observaciones,
        fecha_apertura: new Date().toISOString()
    };

    fetch('/api/caja/abrir', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(apertura)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            console.log('‚úÖ Caja abierta exitosamente');
            
            bootstrap.Modal.getInstance(document.getElementById('modalAperturaCaja')).hide();
            mostrarCajaAbierta(data.caja);
            alert('Caja abierta exitosamente');
        } else {
            alert(`Error: ${data.error}`);
        }
    })
    .catch(error => {
        console.error('‚ùå Error al abrir caja:', error);
        alert(`Error de conexi√≥n: ${error.message}`);
    })
    .finally(() => {
        btnAbrir.innerHTML = textoOriginal;
        btnAbrir.disabled = false;
    });
}

function mostrarModalCierre() {
    if (!cajaActual) {
        alert('No hay una caja abierta');
        return;
    }

    console.log('üîí Abriendo modal de cierre');

    const efectivoTeorico = cajaActual.efectivo_teorico || cajaActual.monto_inicial || 0;
    document.getElementById('efectivoTeoricoModal').textContent = formatearPesos(efectivoTeorico);
    
    document.getElementById('conteoRealCaja').value = '';
    document.getElementById('observacionesCierreCaja').value = '';
    document.getElementById('alertaDiferenciaCaja').style.display = 'none';

    const inputConteo = document.getElementById('conteoRealCaja');
    inputConteo.oninput = function() {
        const conteo = parseFloat(this.value) || 0;
        const diferencia = conteo - efectivoTeorico;
        const alertaDiv = document.getElementById('alertaDiferenciaCaja');
        const textoDiv = document.getElementById('textoDiferenciaCaja');

        if (Math.abs(diferencia) > 0.01) {
            alertaDiv.style.display = 'block';
            if (diferencia > 0) {
                alertaDiv.className = 'alert alert-warning';
                textoDiv.innerHTML = `<i class="fas fa-exclamation-triangle"></i> Sobrante: ${formatearPesos(diferencia)}`;
            } else {
                alertaDiv.className = 'alert alert-danger';
                textoDiv.innerHTML = `<i class="fas fa-exclamation-circle"></i> Faltante: ${formatearPesos(Math.abs(diferencia))}`;
            }
        } else {
            alertaDiv.style.display = 'none';
        }
    };

    new bootstrap.Modal(document.getElementById('modalCierreCaja')).show();
}

function procesarCierreCaja() {
    const conteoReal = parseFloat(document.getElementById('conteoRealCaja').value);
    const observaciones = document.getElementById('observacionesCierreCaja').value.trim();
    const efectivoTeorico = cajaActual.efectivo_teorico || cajaActual.monto_inicial || 0;

    if (isNaN(conteoReal)) {
        alert('Ingrese el conteo real de efectivo');
        return;
    }

    console.log('üí∞ Procesando cierre de caja:', { conteoReal, efectivoTeorico, observaciones });

    const btnCerrar = document.querySelector('#modalCierreCaja .btn-danger');
    const textoOriginal = btnCerrar.innerHTML;
    btnCerrar.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Cerrando...';
    btnCerrar.disabled = true;

    const cierre = {
        caja_id: cajaActual.id,
        efectivo_teorico: efectivoTeorico,
        efectivo_real: conteoReal,
        diferencia: conteoReal - efectivoTeorico,
        observaciones: observaciones,
        fecha_cierre: new Date().toISOString()
    };

    fetch('/api/caja/cerrar', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(cierre)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            console.log('‚úÖ Caja cerrada exitosamente');
            
            bootstrap.Modal.getInstance(document.getElementById('modalCierreCaja')).hide();
            mostrarCajaCerrada();
            alert('Caja cerrada exitosamente');
        } else {
            alert(`Error: ${data.error}`);
        }
    })
    .catch(error => {
        console.error('‚ùå Error al cerrar caja:', error);
        alert(`Error de conexi√≥n: ${error.message}`);
    })
    .finally(() => {
        btnCerrar.innerHTML = textoOriginal;
        btnCerrar.disabled = false;
    });
}

function mostrarModalMovimiento(tipo) {
    if (!cajaActual) {
        alert('Debe abrir una caja primero');
        return;
    }

    console.log('üí∏ Abriendo modal de movimiento:', tipo);

    document.getElementById('tipoMovimientoCaja').value = tipo;
    document.getElementById('descripcionMovimientoCaja').value = '';
    document.getElementById('montoMovimientoCaja').value = '';
    document.getElementById('notasMovimientoCaja').value = '';

    const header = document.getElementById('headerMovimientoCaja');
    const titulo = document.getElementById('tituloMovimientoCaja');
    const btn = document.getElementById('btnGuardarMovimientoCaja');

    if (tipo === 'ingreso') {
        header.className = 'modal-header bg-success text-white';
        titulo.innerHTML = '<i class="fas fa-plus"></i> Ingreso a Caja';
        btn.className = 'btn btn-success';
        btn.innerHTML = '<i class="fas fa-plus"></i> Registrar Ingreso';
    } else {
        header.className = 'modal-header bg-danger text-white';
        titulo.innerHTML = '<i class="fas fa-minus"></i> Egreso de Caja';
        btn.className = 'btn btn-danger';
        btn.innerHTML = '<i class="fas fa-minus"></i> Registrar Egreso';
    }

    new bootstrap.Modal(document.getElementById('modalMovimientoCaja')).show();
}

function procesarMovimientoCaja() {
    const tipo = document.getElementById('tipoMovimientoCaja').value;
    const descripcion = document.getElementById('descripcionMovimientoCaja').value.trim();
    const monto = parseFloat(document.getElementById('montoMovimientoCaja').value);
    const notas = document.getElementById('notasMovimientoCaja').value.trim();

    if (!descripcion || !monto || monto <= 0) {
        alert('Complete todos los campos requeridos');
        return;
    }

    console.log('üí∏ Procesando movimiento:', { tipo, descripcion, monto, notas });

    const btnGuardar = document.getElementById('btnGuardarMovimientoCaja');
    const textoOriginal = btnGuardar.innerHTML;
    btnGuardar.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Guardando...';
    btnGuardar.disabled = true;

    const movimiento = {
        caja_id: cajaActual.id,
        tipo: tipo,
        descripcion: descripcion,
        monto: monto,
        notas: notas,
        fecha: new Date().toISOString()
    };

    fetch('/api/caja/movimiento', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(movimiento)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            console.log('‚úÖ Movimiento registrado exitosamente');
            
            bootstrap.Modal.getInstance(document.getElementById('modalMovimientoCaja')).hide();
            cargarMovimientosCaja();
            
            setTimeout(() => {
                actualizarEfectivoTeoricoEnTiempoReal();
            }, 200);
            
            alert(`${tipo === 'ingreso' ? 'Ingreso' : 'Egreso'} registrado: ${formatearPesos(monto)}`);
        } else {
            alert(`Error: ${data.error}`);
        }
    })
    .catch(error => {
        console.error('‚ùå Error al registrar movimiento:', error);
        alert(`Error de conexi√≥n: ${error.message}`);
    })
    .finally(() => {
        btnGuardar.innerHTML = textoOriginal;
        btnGuardar.disabled = false;
    });
}

function mostrarDesgloseCaja() {
    if (!cajaActual) {
        alert('No hay una caja abierta');
        return;
    }
    
    fetch(`/api/caja/${cajaActual.id}/resumen`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const desglose = data.resumen.totales.calculo_detallado;
                const movimientos = data.resumen.totales.movimientos_manuales;
                const ventas = data.resumen.totales.ventas_sistema;
                const gastos = data.resumen.totales.gastos_sistema;
                
                const mensaje = `
üßÆ DESGLOSE DETALLADO DE CAJA

üí∞ Apertura: ${formatearPesos(desglose.apertura)}
üìà Movimientos manuales:
   ‚Ä¢ Ingresos: +${formatearPesos(movimientos.total_ingresos)}
   ‚Ä¢ Egresos: -${formatearPesos(movimientos.total_egresos)}
üõí Ventas en efectivo: +${formatearPesos(ventas.total_efectivo)} (${ventas.cantidad_ventas} ventas)
üí∏ Gastos en efectivo: -${formatearPesos(gastos.total_efectivo)} (${gastos.cantidad_gastos} gastos)

üíé EFECTIVO TE√ìRICO: ${formatearPesos(desglose.total)}
                `;
                
                alert(mensaje);
                console.log('üìä Desglose completo:', data.resumen);
            } else {
                alert('Error obteniendo desglose: ' + data.error);
            }
        })
        .catch(error => {
            console.error('‚ùå Error:', error);
            alert('Error de conexi√≥n');
        });
}

function cargarHistorialCajas() {
    const fechaDesde = document.getElementById('fecha_caja_desde').value;
    const fechaHasta = document.getElementById('fecha_caja_hasta').value;
    
    if (!fechaDesde || !fechaHasta) {
        alert('Debe seleccionar ambas fechas');
        return;
    }
    
    console.log('üîç Buscando historial de cajas:', { fechaDesde, fechaHasta });
    
    // Simulaci√≥n de historial para demostraci√≥n
    const historial = `
        <div class="alert alert-info">
            <h6><i class="fas fa-info-circle"></i> Per√≠odo: ${fechaDesde} a ${fechaHasta}</h6>
            <p>Funcionalidad de historial en desarrollo. Conectar con endpoint /api/cajas/historial</p>
        </div>
    `;
    
    document.getElementById('historialCajas').innerHTML = historial;
}

// ======= OTRAS FUNCIONES ORIGINALES =======

function cargarReporteMediosPago() {
    console.log('Funcionalidad de medios de pago en desarrollo');
}

function cargarReporteGastos() {
    const fechaDesde = document.getElementById('fecha_gastos_desde').value;
    const fechaHasta = document.getElementById('fecha_gastos_hasta').value;
    
    if (!fechaDesde || !fechaHasta) {
        alert('Debe seleccionar ambas fechas para generar el reporte');
        return;
    }
    
    if (fechaDesde > fechaHasta) {
        alert('La fecha "desde" no puede ser mayor que la fecha "hasta"');
        return;
    }
    
    console.log('üìä Cargando reporte de gastos:', { fechaDesde, fechaHasta });
    
    // Mostrar indicador de carga
    const listaGastos = document.getElementById('listaGastos');
    const categoriasGastos = document.getElementById('categoriasGastos');
    
    listaGastos.innerHTML = `
        <div class="text-center py-4">
            <i class="fas fa-spinner fa-spin fa-2x mb-3"></i>
            <h6>Cargando gastos...</h6>
        </div>
    `;
    
    categoriasGastos.innerHTML = `
        <div class="text-center py-4">
            <i class="fas fa-spinner fa-spin fa-2x mb-3"></i>
            <p>Procesando categor√≠as...</p>
        </div>
    `;
    
    // Hacer petici√≥n al backend
    fetch(`/api/gastos?fecha_desde=${fechaDesde}&fecha_hasta=${fechaHasta}`)
        .then(response => {
            if (!response.ok) {
                throw new Error(`Error HTTP: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                console.log('‚úÖ Gastos cargados:', data);
                mostrarListaGastos(data.gastos);
                mostrarCategoriasGastos(data.categorias || agruparGastosPorCategoria(data.gastos));
                
                // Actualizar totales si existen
                if (data.totales) {
                    actualizarTotalesGastos(data.totales);
                }
            } else {
                throw new Error(data.error || 'Error desconocido al cargar gastos');
            }
        })
        .catch(error => {
            console.error('‚ùå Error al cargar gastos:', error);
            
            listaGastos.innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle"></i> 
                    <strong>Error al cargar gastos:</strong> ${error.message}
                </div>
            `;
            
            categoriasGastos.innerHTML = `
                <div class="text-center text-muted py-4">
                    <i class="fas fa-exclamation-triangle fa-2x mb-3"></i>
                    <p>Error cargando categor√≠as</p>
                </div>
            `;
        });
}


function mostrarCategoriasGastos(categorias) {
    const categoriasGastos = document.getElementById('categoriasGastos');
    
    if (!categorias || Object.keys(categorias).length === 0) {
        categoriasGastos.innerHTML = `
            <div class="text-center text-muted py-4">
                <i class="fas fa-tags fa-2x mb-3"></i>
                <p>Sin datos de categor√≠as</p>
            </div>
        `;
        return;
    }
    
    // Crear lista de categor√≠as ordenada por monto
    const categoriasArray = Object.entries(categorias)
        .map(([categoria, datos]) => ({
            categoria: categoria,
            total: datos.total || datos,
            cantidad: datos.cantidad || 1
        }))
        .sort((a, b) => b.total - a.total);
    
    const totalGeneral = categoriasArray.reduce((sum, cat) => sum + cat.total, 0);
    
    let html = `
        <div class="mb-3">
            <h6 class="text-center">Total: ${formatearPesos(totalGeneral)}</h6>
        </div>
    `;
    
    categoriasArray.forEach(cat => {
        const porcentaje = totalGeneral > 0 ? ((cat.total / totalGeneral) * 100).toFixed(1) : 0;
        const nombreCategoria = obtenerNombreCategoria(cat.categoria);
        
        html += `
            <div class="mb-2">
                <div class="d-flex justify-content-between align-items-center mb-1">
                    <small><strong>${nombreCategoria}</strong></small>
                    <small><strong>${formatearPesos(cat.total)}</strong></small>
                </div>
                <div class="progress" style="height: 20px;">
                    <div class="progress-bar bg-danger" 
                         style="width: ${porcentaje}%" 
                         title="${porcentaje}% del total">
                        <small>${porcentaje}%</small>
                    </div>
                </div>
                <small class="text-muted">${cat.cantidad} gasto${cat.cantidad !== 1 ? 's' : ''}</small>
            </div>
        `;
    });
    
    categoriasGastos.innerHTML = html;
}


function obtenerNombreCategoria(categoria) {
    const categorias = {
        'general': 'General',
        'insumos': 'Insumos y Materiales',
        'servicios': 'Servicios',
        'transporte': 'Transporte',
        'personal': 'Personal',
        'mantenimiento': 'Mantenimiento',
        'impuestos': 'Impuestos',
        'otros': 'Otros'
    };
    return categorias[categoria] || categoria;
}

function agruparGastosPorCategoria(gastos) {
    return gastos.reduce((acc, gasto) => {
        const categoria = gasto.categoria || 'general';
        if (!acc[categoria]) {
            acc[categoria] = { total: 0, cantidad: 0 };
        }
        acc[categoria].total += parseFloat(gasto.monto || 0);
        acc[categoria].cantidad += 1;
        return acc;
    }, {});
}

function mostrarListaGastos(gastos) {
    const listaGastos = document.getElementById('listaGastos');
    
    if (!gastos || gastos.length === 0) {
        listaGastos.innerHTML = `
            <div class="alert alert-info">
                <i class="fas fa-info-circle"></i> 
                No se encontraron gastos en el per√≠odo seleccionado
            </div>
        `;
        return;
    }
    
    // Calcular total
    const totalGastos = gastos.reduce((sum, gasto) => sum + parseFloat(gasto.monto || 0), 0);
    
    let html = `
        <div class="alert alert-success mb-3">
            <div class="d-flex justify-content-between align-items-center">
                <span><i class="fas fa-calculator"></i> <strong>Total del Per√≠odo:</strong></span>
                <strong class="h5 mb-0">${formatearPesos(totalGastos)}</strong>
            </div>
            <small>Total de ${gastos.length} gasto${gastos.length !== 1 ? 's' : ''}</small>
        </div>
        <div class="table-responsive">
            <table class="table table-sm table-striped">
                <thead class="table-dark">
                    <tr>
                        <th>Fecha</th>
                        <th>Descripci√≥n</th>
                        <th>Categor√≠a</th>
                        <th>M√©todo</th>
                        <th class="text-end">Monto</th>
                        <th>Estado Caja</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
    `;
    
    // Ordenar gastos por fecha descendente
    gastos.sort((a, b) => new Date(b.fecha) - new Date(a.fecha));
    
    gastos.forEach(gasto => {
        const fecha = gasto.fecha.split('T')[0].split('-').reverse().join('/');
        const categoria = obtenerNombreCategoria(gasto.categoria || 'general');
        const metodo = obtenerNombreMetodoPago(gasto.metodo_pago || 'efectivo');
        
        // Determinar si la caja est√° cerrada
        const cajaEsCerrada = gasto.caja_cerrada || false;
        const estadoCaja = cajaEsCerrada ? 'Cerrada' : 'Abierta';
        const claseBadge = cajaEsCerrada ? 'bg-secondary' : 'bg-success';
        
        // Determinar si se puede eliminar
        const puedeEliminar = !cajaEsCerrada && puedeEditarGasto(gasto);
        
        html += `
            <tr ${cajaEsCerrada ? 'class="table-secondary"' : ''}>
                <td><small>${fecha}</small></td>
                <td>
                    <strong>${gasto.descripcion || 'Sin descripci√≥n'}</strong>
                    ${gasto.notas ? `<br><small class="text-muted">${gasto.notas}</small>` : ''}
                </td>
                <td>
                    <span class="badge bg-secondary">${categoria}</span>
                </td>
                <td>
                    <small>${metodo}</small>
                </td>
                <td class="text-end">
                    <strong class="text-danger">${formatearPesos(gasto.monto)}</strong>
                </td>
                <td>
                    <span class="badge ${claseBadge}">${estadoCaja}</span>
                    ${gasto.caja_id ? `<br><small class="text-muted">Caja #${gasto.caja_id}</small>` : ''}
                </td>
                <td>
                    <button class="btn btn-sm btn-outline-primary" 
                            onclick="verDetalleGasto(${gasto.id})" 
                            title="Ver detalles">
                        <i class="fas fa-eye"></i>
                    </button>
                    ${puedeEliminar ? `
                        <button class="btn btn-sm btn-outline-danger" 
                                onclick="eliminarGasto(${gasto.id})" 
                                title="Eliminar gasto">
                            <i class="fas fa-trash"></i>
                        </button>
                    ` : `
                        <button class="btn btn-sm btn-outline-secondary" 
                                disabled
                                title="No se puede eliminar - Caja cerrada">
                            <i class="fas fa-lock"></i>
                        </button>
                    `}
                </td>
            </tr>
        `;
    });
    
    html += `
                </tbody>
            </table>
        </div>
        
        ${gastos.some(g => g.caja_cerrada) ? `
            <div class="alert alert-info mt-3">
                <i class="fas fa-info-circle"></i> 
                <strong>Nota:</strong> Los gastos marcados en gris pertenecen a cajas cerradas y no pueden eliminarse para mantener la integridad contable.
            </div>
        ` : ''}
    `;
    
    listaGastos.innerHTML = html;
}

// Funci√≥n para verificar si se puede editar un gasto
function puedeEditarGasto(gasto) {
    // Verificar si el gasto es muy antiguo (ejemplo: m√°s de 30 d√≠as)
    const fechaGasto = new Date(gasto.fecha);
    const hoy = new Date();
    const diasDiferencia = (hoy - fechaGasto) / (1000 * 60 * 60 * 24);
    
    // Otras reglas de negocio que puedas tener
    if (diasDiferencia > 30) {
        return false; // No permitir eliminar gastos muy antiguos
    }
    
    return true;
}

function verificarEstadoGastoAntesDeEliminar(gastoId, descripcion) {
    console.log('üîç Verificando estado del gasto antes de eliminar:', gastoId);
    
    fetch(`/api/gastos/${gastoId}/estado`)
        .then(response => {
            if (!response.ok) {
                throw new Error(`Error al verificar estado: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                if (data.caja_cerrada) {
                    alert(`‚ùå No se puede eliminar este gasto.\n\nEl gasto "${descripcion}" pertenece a una caja cerrada (Caja #${data.caja_id}).\n\nLos gastos de cajas cerradas no pueden modificarse para mantener la integridad contable.`);
                    return;
                }
                
                if (data.puede_eliminar) {
                    // Proceder con la confirmaci√≥n normal
                    mostrarConfirmacionEliminacion(gastoId, descripcion, data);
                } else {
                    alert(`‚ùå No se puede eliminar este gasto.\n\nMotivo: ${data.razon || 'Restricci√≥n del sistema'}`);
                }
            } else {
                throw new Error(data.error || 'Error verificando estado del gasto');
            }
        })
        .catch(error => {
            console.error('‚ùå Error verificando estado del gasto:', error);
            alert(`Error al verificar el estado del gasto: ${error.message}`);
        });
}

function mostrarConfirmacionEliminacion(gastoId, descripcion, estadoGasto) {
    const mensaje = `¬øEst√° seguro de eliminar este gasto?

üìÑ Descripci√≥n: ${descripcion}
üí∞ Monto: ${formatearPesos(estadoGasto.monto || 0)}
üìÖ Fecha: ${estadoGasto.fecha || 'No disponible'}
üè¶ Caja: ${estadoGasto.caja_id ? `#${estadoGasto.caja_id} (${estadoGasto.estado_caja})` : 'Sin caja asociada'}

‚ö†Ô∏è Esta acci√≥n no se puede deshacer.

${estadoGasto.advertencias ? `\n‚ö†Ô∏è Advertencias:\n${estadoGasto.advertencias.join('\n')}` : ''}`;

    if (confirm(mensaje)) {
        eliminarGasto(gastoId);
    }
}

function eliminarGasto(gastoId) {
    console.log('üóëÔ∏è Eliminando gasto:', gastoId);
    
    const confirmacionFinal = confirm('‚ö†Ô∏è CONFIRMACI√ìN FINAL\n\n¬øEst√° completamente seguro de eliminar este gasto?\n\nEsta acci√≥n es IRREVERSIBLE.');
    
    if (!confirmacionFinal) {
        return;
    }
    
    fetch(`/api/gastos/${gastoId}`, {
        method: 'DELETE',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => {
        if (response.status === 403) {
            throw new Error('CAJA_CERRADA');
        } else if (!response.ok) {
            throw new Error(`Error HTTP: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            alert('‚úÖ Gasto eliminado exitosamente');
            
            // Recargar lista
            cargarReporteGastos();
            
            // Si hay una caja abierta, actualizar efectivo te√≥rico
            if (cajaActual && cajaActual.estado === 'abierta') {
                setTimeout(() => {
                    actualizarEfectivoTeoricoEnTiempoReal();
                }, 500);
            }
        } else {
            throw new Error(data.error || 'Error al eliminar gasto');
        }
    })
    .catch(error => {
        console.error('‚ùå Error al eliminar gasto:', error);
        
        let mensajeError;
        switch(error.message) {
            case 'CAJA_CERRADA':
                mensajeError = 'No se puede eliminar: El gasto pertenece a una caja cerrada';
                break;
            default:
                mensajeError = `Error al eliminar: ${error.message}`;
        }
        
        alert(`‚ùå ${mensajeError}`);
    });
}

function verDetalleGasto(gastoId) {
    console.log('üëÅÔ∏è Ver detalle de gasto:', gastoId);
    // Implementar modal de detalles o redirecci√≥n
    alert(`Ver detalle de gasto ID: ${gastoId}\n(Funcionalidad por implementar)`);
}

function obtenerNombreMetodoPago(metodo) {
    const metodos = {
        'efectivo': 'Efectivo',
        'credito': 'T. Cr√©dito',
        'debito': 'T. D√©bito',
        'transferencia': 'Transferencia',
        'cheque': 'Cheque'
    };
    return metodos[metodo] || metodo;
}

function guardarNuevoGasto() {
    // Obtener valores del formulario
    const descripcion = document.getElementById('descripcionGasto').value.trim();
    const monto = parseFloat(document.getElementById('montoGasto').value);
    const categoria = document.getElementById('categoriaGasto').value;
    const fecha = document.getElementById('fechaGasto').value;
    const metodoPago = document.getElementById('metodoPagoGasto').value;
    const notas = document.getElementById('notasGasto').value.trim();

    // Validaciones
    if (!descripcion) {
        alert('La descripci√≥n del gasto es obligatoria');
        document.getElementById('descripcionGasto').focus();
        return;
    }

    if (!monto || monto <= 0) {
        alert('Ingrese un monto v√°lido mayor a 0');
        document.getElementById('montoGasto').focus();
        return;
    }

    if (!fecha) {
        alert('Seleccione una fecha para el gasto');
        document.getElementById('fechaGasto').focus();
        return;
    }

    console.log('üí∏ Guardando nuevo gasto:', { descripcion, monto, categoria, fecha, metodoPago, notas });

    // Cambiar estado del bot√≥n mientras procesa
    const btnGuardar = document.querySelector('#modalNuevoGasto .btn-danger');
    const textoOriginal = btnGuardar.innerHTML;
    btnGuardar.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Guardando...';
    btnGuardar.disabled = true;

    // Preparar datos para enviar
    const gastoData = {
        descripcion: descripcion,
        monto: monto,
        categoria: categoria,
        fecha: fecha,
        metodo_pago: metodoPago,
        notas: notas,
        fecha_registro: new Date().toISOString()
    };

    // Enviar al backend
    fetch('/api/gastos', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(gastoData)
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`Error HTTP: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            console.log('‚úÖ Gasto guardado exitosamente:', data);
            
            // Cerrar modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('modalNuevoGasto'));
            if (modal) {
                modal.hide();
            }
            
            // Limpiar formulario
            limpiarFormularioGasto();
            
            // Mostrar mensaje de √©xito
            alert(`Gasto registrado exitosamente:\n${descripcion}\nMonto: ${formatearPesos(monto)}`);
            
            // Recargar reporte de gastos si est√° activo
            const tabActiva = document.querySelector('.nav-link.active');
            if (tabActiva && tabActiva.getAttribute('data-bs-target') === '#gastos') {
                // Si hay fechas seleccionadas, recargar autom√°ticamente
                const fechaDesde = document.getElementById('fecha_gastos_desde').value;
                const fechaHasta = document.getElementById('fecha_gastos_hasta').value;
                if (fechaDesde && fechaHasta) {
                    setTimeout(() => cargarReporteGastos(), 500);
                }
            }
            
            // Si hay una caja abierta, actualizar el efectivo te√≥rico
            if (cajaActual && cajaActual.estado === 'abierta') {
                setTimeout(() => {
                    actualizarEfectivoTeoricoEnTiempoReal();
                }, 1000);
            }
            
        } else {
            throw new Error(data.error || 'Error desconocido al guardar el gasto');
        }
    })
    .catch(error => {
        console.error('‚ùå Error al guardar gasto:', error);
        alert(`Error al guardar el gasto: ${error.message}`);
    })
    .finally(() => {
        // Restaurar bot√≥n
        btnGuardar.innerHTML = textoOriginal;
        btnGuardar.disabled = false;
    });
}

function limpiarFormularioGasto() {
    document.getElementById('descripcionGasto').value = '';
    document.getElementById('montoGasto').value = '';
    document.getElementById('categoriaGasto').value = 'general';
    document.getElementById('fechaGasto').value = new Date().toISOString().split('T')[0];
    document.getElementById('metodoPagoGasto').value = 'efectivo';
    document.getElementById('notasGasto').value = '';
}


// ======= FUNCIONES DE IMPRESI√ìN Y EXPORTACI√ìN =======

function imprimirEstadoCaja() {
    if (!cajaActual) {
        alert('No hay datos de caja para imprimir');
        return;
    }
    
    console.log('üñ®Ô∏è Preparando impresi√≥n de estado de caja...');
    
    // Generar contenido para impresi√≥n
    const fechaImpresion = new Date().toLocaleString('es-AR');
    const fechaApertura = new Date(cajaActual.fecha_apertura).toLocaleString('es-AR');
    const fechaCierre = cajaActual.fecha_cierre ? 
        new Date(cajaActual.fecha_cierre).toLocaleString('es-AR') : 'Abierta';
    
    const contenidoImpresion = `
        <!DOCTYPE html>
        <html>
        <head>
            <title>Reporte de Caja - ${cajaActual.id}</title>
            <style>
                body { font-family: Arial, sans-serif; margin: 20px; }
                .header { text-align: center; border-bottom: 2px solid #333; padding-bottom: 20px; margin-bottom: 20px; }
                .section { margin-bottom: 20px; }
                .datos-caja { background: #f5f5f5; padding: 15px; border-radius: 5px; }
                .movimientos { margin-top: 20px; }
                .movimiento { padding: 5px 0; border-bottom: 1px solid #eee; }
                .totales { background: #e8f5e8; padding: 15px; border-radius: 5px; margin-top: 20px; }
                .footer { text-align: center; margin-top: 30px; font-size: 12px; color: #666; }
                @media print { body { margin: 10px; } }
            </style>
        </head>
        <body>
            <div class="header">
                <h1>REPORTE DE CAJA</h1>
                <h2>Caja #${cajaActual.id}</h2>
                <p><strong>Estado:</strong> ${cajaActual.estado.toUpperCase()}</p>
            </div>
            
            <div class="section datos-caja">
                <h3>Datos de la Caja</h3>
                <p><strong>Fecha Apertura:</strong> ${fechaApertura}</p>
                <p><strong>Fecha Cierre:</strong> ${fechaCierre}</p>
                <p><strong>Monto Inicial:</strong> ${formatearPesos(cajaActual.monto_inicial)}</p>
                ${cajaActual.estado === 'cerrada' ? `
                    <p><strong>Efectivo Te√≥rico:</strong> ${formatearPesos(cajaActual.efectivo_teorico)}</p>
                    <p><strong>Efectivo Real:</strong> ${formatearPesos(cajaActual.efectivo_real)}</p>
                    <p><strong>Diferencia:</strong> ${formatearPesos(cajaActual.diferencia)}</p>
                ` : `
                    <p><strong>Efectivo Te√≥rico Actual:</strong> ${formatearPesos(cajaActual.efectivo_teorico)}</p>
                `}
            </div>
            
            <div class="section">
                <h3>Movimientos Adicionales</h3>
                ${movimientosCajaActuales.length === 0 ? 
                    '<p>No hay movimientos adicionales registrados.</p>' :
                    movimientosCajaActuales.map(mov => `
                        <div class="movimiento">
                            <strong>${mov.descripcion}</strong> - 
                            <span style="color: ${mov.tipo === 'ingreso' ? 'green' : 'red'}">
                                ${mov.tipo === 'ingreso' ? '+' : '-'}${formatearPesos(mov.monto)}
                            </span>
                            <br><small>${new Date(mov.fecha).toLocaleString('es-AR')}</small>
                            ${mov.notas ? `<br><small>Notas: ${mov.notas}</small>` : ''}
                        </div>
                    `).join('')
                }
            </div>
            
            <div class="totales">
                <h3>Resumen de Totales</h3>
                <p><strong>Ingresos Manuales:</strong> ${formatearPesos(
                    movimientosCajaActuales
                        .filter(m => m.tipo === 'ingreso')
                        .reduce((sum, m) => sum + parseFloat(m.monto), 0)
                )}</p>
                <p><strong>Egresos Manuales:</strong> ${formatearPesos(
                    movimientosCajaActuales
                        .filter(m => m.tipo === 'egreso')
                        .reduce((sum, m) => sum + parseFloat(m.monto), 0)
                )}</p>
                <p><strong>Balance Movimientos:</strong> ${formatearPesos(
                    movimientosCajaActuales
                        .filter(m => m.tipo === 'ingreso')
                        .reduce((sum, m) => sum + parseFloat(m.monto), 0) -
                    movimientosCajaActuales
                        .filter(m => m.tipo === 'egreso')
                        .reduce((sum, m) => sum + parseFloat(m.monto), 0)
                )}</p>
            </div>
            
            ${cajaActual.observaciones_apertura ? `
                <div class="section">
                    <h3>Observaciones de Apertura</h3>
                    <p>${cajaActual.observaciones_apertura}</p>
                </div>
            ` : ''}
            
            ${cajaActual.observaciones_cierre ? `
                <div class="section">
                    <h3>Observaciones de Cierre</h3>
                    <p>${cajaActual.observaciones_cierre}</p>
                </div>
            ` : ''}
            
            <div class="footer">
                <p>Reporte generado el ${fechaImpresion}</p>
                <p>Sistema FactuFacil - Gesti√≥n de Caja</p>
            </div>
        </body>
        </html>
    `;
    
    // Crear nueva ventana para impresi√≥n
    const ventanaImpresion = window.open('', '_blank');
    ventanaImpresion.document.write(contenidoImpresion);
    ventanaImpresion.document.close();
    
    // Esperar que cargue y luego imprimir
    ventanaImpresion.onload = function() {
        ventanaImpresion.print();
        // Opcional: cerrar la ventana despu√©s de imprimir
        // ventanaImpresion.close();
    };
}

function exportarReportes() {
    const activeTab = document.querySelector('.nav-link.active');
    const tabId = activeTab ? activeTab.getAttribute('data-bs-target') : '#caja-diaria';
    
    console.log('üìä Exportando reportes para:', tabId);
    
    switch(tabId) {
        case '#caja-diaria':
            exportarDatosCaja();
            break;
        case '#ventas-producto':
            exportarVentasProducto();
            break;
        case '#medios-pago':
            exportarMediosPago();
            break;
        case '#gastos':
            exportarGastos();
            break;
        default:
            alert('Selecciona una pesta√±a espec√≠fica para exportar');
    }
}

function exportarDatosCaja() {
    if (!cajaActual) {
        alert('No hay datos de caja para exportar');
        return;
    }
    
    console.log('üìä Exportando datos de caja...');
    
    // Preparar datos para CSV
    const datosCaja = {
        'ID Caja': cajaActual.id,
        'Estado': cajaActual.estado,
        'Fecha Apertura': new Date(cajaActual.fecha_apertura).toLocaleString('es-AR'),
        'Fecha Cierre': cajaActual.fecha_cierre ? new Date(cajaActual.fecha_cierre).toLocaleString('es-AR') : 'Abierta',
        'Monto Inicial': cajaActual.monto_inicial,
        'Efectivo Te√≥rico': cajaActual.efectivo_teorico,
        'Efectivo Real': cajaActual.efectivo_real || 0,
        'Diferencia': cajaActual.diferencia || 0,
        'Observaciones Apertura': cajaActual.observaciones_apertura || '',
        'Observaciones Cierre': cajaActual.observaciones_cierre || ''
    };
    
    // Crear CSV
    let csvContent = 'Campo,Valor\n';
    Object.entries(datosCaja).forEach(([key, value]) => {
        csvContent += `"${key}","${value}"\n`;
    });
    
    // Agregar movimientos si existen
    if (movimientosCajaActuales.length > 0) {
        csvContent += '\n\nMovimientos\n';
        csvContent += 'Fecha,Tipo,Descripci√≥n,Monto,Notas\n';
        
        movimientosCajaActuales.forEach(mov => {
            const fecha = new Date(mov.fecha).toLocaleString('es-AR');
            csvContent += `"${fecha}","${mov.tipo}","${mov.descripcion}","${mov.monto}","${mov.notas || ''}"\n`;
        });
    }
    
    // Descargar archivo
    descargarCSV(csvContent, `caja_${cajaActual.id}_${new Date().toISOString().split('T')[0]}.csv`);
}

function exportarVentasProducto() {
    alert('Exportaci√≥n de ventas por producto en desarrollo.\nConectar con el endpoint /api/reporte_ventas');
}

function exportarMediosPago() {
    alert('Exportaci√≥n de medios de pago en desarrollo.\nConectar con el endpoint /api/reporte_medios_pago');
}

function exportarGastos() {
    alert('Exportaci√≥n de gastos en desarrollo.\nConectar con el endpoint /api/gastos');
}

// Funci√≥n auxiliar para descargar CSV
function descargarCSV(contenido, nombreArchivo) {
    const blob = new Blob([contenido], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    
    if (link.download !== undefined) {
        const url = URL.createObjectURL(blob);
        link.setAttribute('href', url);
        link.setAttribute('download', nombreArchivo);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        console.log(`‚úÖ Archivo descargado: ${nombreArchivo}`);
    } else {
        alert('Tu navegador no soporta descarga de archivos');
    }
}



// ======= INICIALIZACI√ìN =======

document.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ Inicializando sistema de reportes...');
    
    // Establecer fechas iniciales
    establecerFechasVentasHoy();
    establecerFechasMediosHoy();
    establecerFechasGastosHoy();
    establecerFechasCajaHoy();
    
    // Verificar estado de caja despu√©s de un breve delay
    setTimeout(() => {
        verificarEstadoCaja();
    }, 1000);
});
</script>

<style>
.nav-tabs .nav-link {
    color: #6c757d;
    border: 1px solid transparent;
    border-top-left-radius: 0.375rem;
    border-top-right-radius: 0.375rem;
}

.nav-tabs .nav-link:hover {
    border-color: #e9ecef #e9ecef #dee2e6;
    isolation: isolate;
}

.nav-tabs .nav-link.active {
    color: #495057;
    background-color: #fff;
    border-color: #dee2e6 #dee2e6 #fff;
}

.card.bg-success, .card.bg-danger, .card.bg-primary, .card.bg-info, .card.bg-warning, .card.bg-secondary, .card.bg-dark {
    border: none;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    transition: transform 0.2s ease;
}

.card.bg-success:hover, .card.bg-danger:hover, .card.bg-primary:hover, .card.bg-info:hover, .card.bg-warning:hover, .card.bg-secondary:hover, .card.bg-dark:hover {
    transform: translateY(-2px);
}

.border-success {
    border-color: #28a745 !important;
    border-width: 2px !important;
}

.border-secondary {
    border-color: #6c757d !important;
    border-width: 2px !important;
}

.border-warning {
    border-color: #ffc107 !important;
    border-width: 2px !important;
}

.fa-spin {
    animation: fa-spin 2s infinite linear;
}

@keyframes fa-spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

@media (max-width: 768px) {
    .nav-tabs {
        flex-wrap: wrap;
    }
    
    .nav-tabs .nav-link {
        font-size: 0.9em;
        padding: 0.5rem 0.75rem;
    }
    
    .card h4 {
        font-size: 1.5rem;
    }
}
</style>
{% endblock %}