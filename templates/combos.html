<!-- templates/combos.html -->
{% extends "base.html" %}

{% block title %}Combos y Ofertas - POS Argentina{% endblock %}

{% block head %}
    <style>
    /* Estilos para búsqueda de productos en combos */
    .producto-search-container {
        position: relative;
    }

    .producto-search-dropdown {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        border: 1px solid #dee2e6;
        border-top: none;
        border-radius: 0 0 6px 6px;
        max-height: 250px;
        overflow-y: auto;
        z-index: 1050;
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }

    .producto-search-item {
        padding: 12px 16px;
        cursor: pointer;
        border-bottom: 1px solid #f8f9fa;
        transition: background-color 0.2s;
    }

    .producto-search-item:hover, 
    .producto-search-item.active {
        background-color: #e3f2fd;
    }

    .producto-search-item:last-child {
        border-bottom: none;
    }

    .producto-codigo {
        font-weight: bold;
        color: #0066cc;
        font-size: 0.9em;
    }

    .producto-nombre {
        color: #333;
        margin: 2px 0;
    }

    .producto-precio {
        color: #28a745;
        font-weight: 600;
        font-size: 0.9em;
    }

    .no-results {
        padding: 16px;
        text-align: center;
        color: #6c757d;
        font-style: italic;
    }

    .loading-spinner {
        padding: 16px;
        text-align: center;
        color: #007bff;
    }

    .search-icon {
        position: absolute;
        right: 12px;
        top: 50%;
        transform: translateY(-50%);
        color: #6c757d;
        pointer-events: none;
    }

    .producto-search-input {
        padding-right: 40px;
    }

    .producto-seleccionado {
        background-color: #d4edda;
        border-color: #c3e6cb;
    }
    </style>
{% endblock %}

{% block content %}

<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2"><i class="fas fa-tags"></i> Gestión de Combos y Ofertas</h1>
    <div class="btn-group">
        <button class="btn btn-info me-2" onclick="mostrarAyudaCombos()">
            <i class="fas fa-question-circle"></i> ¿Cómo funcionan?
        </button>
        <button class="btn btn-success" onclick="mostrarModalCrearCombo()">
            <i class="fas fa-plus"></i> Crear Nueva Oferta
        </button>
    </div>
</div>


<!-- Estadísticas rápidas -->
<!-- Estadísticas rápidas CORREGIDAS - Compatible Jinja2 - VERSIÓN SEGURA -->
<!-- Estadísticas rápidas CORREGIDAS - Compatible Jinja2 - VERSIÓN SEGURA -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card bg-warning text-dark">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h5 class="card-title mb-0">Total Ofertas</h5>
                        <h3 class="mb-0">
                            {% set total_combos = combos|selectattr('es_combo')|list|length %}
                            {{ total_combos }}
                        </h3>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-tags fa-2x opacity-75"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-success text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h5 class="card-title mb-0">Ofertas Activas</h5>
                        <h3 class="mb-0">
                            {% set ofertas_activas = combos|selectattr('es_combo')|selectattr('activo')|list|length %}
                            {{ ofertas_activas }}
                        </h3>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-check-circle fa-2x opacity-75"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-info text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h5 class="card-title mb-0">Descuento Promedio</h5>
                        <h3 class="mb-0">
                            {% set descuentos_validos = [] %}
                            
                            {% for combo in combos %}
                                {% if combo.es_combo and combo.producto_base and combo.cantidad_combo and combo.activo %}
                                    {% set precio_normal = combo.producto_base.precio * combo.cantidad_combo %}
                                    {% if precio_normal > 0 and combo.precio < precio_normal %}
                                        {% set descuento_porcentaje = ((precio_normal - combo.precio) / precio_normal * 100) %}
                                        {% if descuentos_validos.append(descuento_porcentaje) %}{% endif %}
                                    {% endif %}
                                {% endif %}
                            {% endfor %}
                            
                            {% if descuentos_validos|length > 0 %}
                                {% set suma_descuentos = descuentos_validos|sum %}
                                {{ "%.1f"|format(suma_descuentos / descuentos_validos|length) }}%
                            {% else %}
                                0.0%
                            {% endif %}
                        </h3>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-percentage fa-2x opacity-75"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-danger text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h5 class="card-title mb-0">Ahorro Total</h5>
                        <h3 class="mb-0">
                            {% set ahorros_validos = [] %}
                            
                            {% for combo in combos %}
                                {% if combo.es_combo and combo.producto_base and combo.cantidad_combo and combo.activo %}
                                    {% set precio_normal = combo.producto_base.precio * combo.cantidad_combo %}
                                    {% if precio_normal > 0 and combo.precio < precio_normal %}
                                        {% set ahorro_total = precio_normal - combo.precio %}
                                        {% if ahorros_validos.append(ahorro_total) %}{% endif %}
                                    {% endif %}
                                {% endif %}
                            {% endfor %}
                            
                            {% if ahorros_validos|length > 0 %}
                                ${{ "%.0f"|format(ahorros_validos|sum) }}
                            {% else %}
                                $0
                            {% endif %}
                        </h3>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-dollar-sign fa-2x opacity-75"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Filtros -->
<div class="card mb-3">
    <div class="card-body">
        <div class="row">
            <div class="col-md-4">
                <label class="form-label">Buscar combos</label>
                <input type="text" class="form-control" id="buscarCombo" placeholder="Código, nombre o producto base...">
            </div>
            <div class="col-md-2">
                <label class="form-label">Estado</label>
                <select class="form-select" id="filtroEstado">
                    <option value="">Todos</option>
                    <option value="activo">Activos</option>
                    <option value="inactivo">Inactivos</option>
                </select>
            </div>
            <div class="col-md-2">
                <label class="form-label">Descuento</label>
                <select class="form-select" id="filtroDescuento">
                    <option value="">Todos</option>
                    <option value="alto">Alto (>30%)</option>
                    <option value="medio">Medio (15-30%)</option>
                    <option value="bajo">Bajo (<15%)</option>
                </select>
            </div>
            <div class="col-md-2">
                <label class="form-label">&nbsp;</label>
                <div class="d-grid gap-2">
                    <button class="btn btn-primary" onclick="aplicarFiltrosCombos()">
                        <i class="fas fa-search"></i> Buscar
                    </button>
                </div>
            </div>
            <div class="col-md-2">
                <label class="form-label">&nbsp;</label>
                <div class="d-grid gap-2">
                    <button class="btn btn-secondary" onclick="limpiarFiltrosCombos()">
                        <i class="fas fa-eraser"></i> Limpiar
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Lista de combos -->
<div class="card">
    <div class="card-header bg-warning text-dark">
        <h5><i class="fas fa-list"></i> Listado de Combos y Ofertas</h5>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-striped table-hover" id="tablaCombos">
                <thead class="table-warning">
                    <tr>
                        <th>Código</th>
                        <th>Nombre de la Oferta</th>
                        <th>Producto Base</th>
                        <th>Cantidad</th>
                        <th>Precio Normal</th>
                        <th>Precio Oferta</th>
                        <th>Descuento</th>
                        <th>Ahorro</th>
                        <th>Stock</th>
                        <th>Estado</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    {% for combo in combos %}
                    <tr>
                        <td><code>{{ combo.codigo }}</code></td>
                        <td>
                            <strong>{{ combo.nombre }}</strong>
                            <br><span class="badge bg-warning text-dark">OFERTA</span>
                            {% if combo.descripcion %}
                                <br><small class="text-muted">{{ combo.descripcion[:50] }}{% if combo.descripcion|length > 50 %}...{% endif %}</small>
                            {% endif %}
                        </td>
                        <td>
                            {% if combo.producto_base %}
                                <strong>{{ combo.producto_base.codigo }}</strong><br>
                                <small class="text-muted">{{ combo.producto_base.nombre }}</small><br>
                                <span class="badge bg-info">${{ "%.2f"|format(combo.producto_base.precio) }}</span>
                            {% else %}
                                <span class="text-muted">Sin base</span>
                            {% endif %}
                        </td>
                        <td class="text-center">
                            <span class="badge bg-info">{{ combo.cantidad_combo }}x</span>
                        </td>
                        <td class="text-end">
                            {% if combo.producto_base %}
                                {% set precio_normal = combo.producto_base.precio * combo.cantidad_combo %}
                                <span class="text-muted">${{ "%.2f"|format(precio_normal) }}</span>
                            {% else %}
                                <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                        <td class="text-end">
                            <strong class="text-success">${{ "%.2f"|format(combo.precio) }}</strong>
                        </td>
                        <td class="text-center">
                            {% if combo.producto_base %}
                                {% set precio_normal = combo.producto_base.precio * combo.cantidad_combo %}
                                {% set descuento = ((precio_normal - combo.precio) / precio_normal * 100) %}
                                {% if descuento > 30 %}
                                    <span class="badge bg-danger">-{{ "%.1f"|format(descuento) }}%</span>
                                {% elif descuento > 15 %}
                                    <span class="badge bg-warning text-dark">-{{ "%.1f"|format(descuento) }}%</span>
                                {% else %}
                                    <span class="badge bg-secondary">-{{ "%.1f"|format(descuento) }}%</span>
                                {% endif %}
                            {% else %}
                                <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                        <td class="text-center">
                            {% if combo.producto_base %}
                                {% set precio_normal = combo.producto_base.precio * combo.cantidad_combo %}
                                {% set ahorro = precio_normal - combo.precio %}
                                <span class="text-success"><strong>${{ "%.0f"|format(ahorro) }}</strong></span>
                            {% else %}
                                <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                        <td class="text-center">
                            {% if combo.stock <= 0 %}
                                <span class="badge bg-danger">{{ combo.stock }}</span>
                            {% elif combo.stock < 10 %}
                                <span class="badge bg-warning text-dark">{{ combo.stock }}</span>
                            {% else %}
                                <span class="badge bg-success">{{ combo.stock }}</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if combo.activo %}
                                <span class="badge bg-success">Activo</span>
                            {% else %}
                                <span class="badge bg-secondary">Inactivo</span>
                            {% endif %}
                        </td>
                        <td>
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-warning" onclick="editarCombo({{ combo.id }})" title="Editar">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-info" onclick="ajustarStock({{ combo.id }})" title="Ajustar Stock">
                                    <i class="fas fa-boxes"></i>
                                </button>
                                <button class="btn btn-{% if combo.activo %}danger{% else %}success{% endif %}" onclick="toggleCombo({{ combo.id }})" title="{% if combo.activo %}Desactivar{% else %}Activar{% endif %}">
                                    <i class="fas fa-power-off"></i>
                                </button>
                                <button class="btn btn-secondary" onclick="duplicarCombo({{ combo.id }})" title="Duplicar">
                                    <i class="fas fa-copy"></i>
                                </button>
                                <button class="btn btn-outline-danger" onclick="eliminarCombo({{ combo.id }})" title="Eliminar Definitivamente">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            
            <!-- Mensaje cuando no hay combos -->
            {% if not combos %}
            <div class="text-center text-muted py-5">
                <i class="fas fa-tags fa-3x mb-3 opacity-50"></i>
                <h5>No hay combos/ofertas creados</h5>
                <p>Haz clic en "Crear Nueva Oferta" para comenzar</p>
                <button class="btn btn-success btn-lg" onclick="mostrarModalCrearCombo()">
                    <i class="fas fa-plus"></i> Crear Mi Primera Oferta
                </button>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Modal para crear/editar combo MULTI-PRODUCTO -->
<div class="modal fade" id="modalCrearCombo" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title" id="tituloModalCombo">
                    <i class="fas fa-tags"></i> Crear Nueva Oferta/Combo
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="formCrearCombo">
                    <input type="hidden" id="combo_id_edit">
                    
                    <!-- Información inicial -->
                    <div class="alert alert-info">
                        <h6><i class="fas fa-lightbulb"></i> Combo Multi-Producto</h6>
                        <p class="mb-0">Puedes crear combos con 1, 2 o 3 productos diferentes. El <strong>Producto 1 es obligatorio</strong>, los otros son opcionales.</p>
                    </div>
                    
                    <!-- PRODUCTO 1 (OBLIGATORIO) -->
                    <div class="card mb-3">
                        <div class="card-header bg-primary text-white">
                            <h6 class="mb-0"><i class="fas fa-star"></i> Producto 1 (Obligatorio)</h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-8">
                                    <div class="mb-3">
                                        <label class="form-label">Buscar Producto *</label>
                                        <div class="producto-search-container">
                                            <input 
                                                type="text" 
                                                class="form-control producto-search-input" 
                                                id="buscar_producto_1" 
                                                placeholder="Escribe para buscar producto..."
                                                autocomplete="off"
                                                required>
                                            <i class="fas fa-search search-icon"></i>
                                            <input type="hidden" id="producto_base_1" required>
                                            <div class="producto-search-dropdown" id="dropdown_productos_1" style="display: none;"></div>
                                        </div>
                                    </div>
                                    <div id="info_producto_1" class="alert alert-light" style="display: none;">
                                        <!-- Información del producto seleccionado -->
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label class="form-label">Cantidad *</label>
                                        <input type="number" class="form-control" id="cantidad_1" 
                                               step="0.001" min="0.001" required 
                                               onchange="calcularPrecioComboMulti()">
                                        <small class="form-text text-muted">Cantidad del producto 1</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- PRODUCTO 2 (OPCIONAL) -->
                    <div class="card mb-3">
                        <div class="card-header bg-secondary text-white">
                            <h6 class="mb-0">
                                <i class="fas fa-plus-circle"></i> Producto 2 (Opcional)
                                <button type="button" class="btn btn-sm btn-outline-light float-end" onclick="limpiarProducto(2)">
                                    <i class="fas fa-times"></i> Quitar
                                </button>
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-8">
                                    <div class="mb-3">
                                        <label class="form-label">Buscar Producto</label>
                                        <div class="producto-search-container">
                                            <input 
                                                type="text" 
                                                class="form-control producto-search-input" 
                                                id="buscar_producto_2" 
                                                placeholder="Escribe para buscar segundo producto..."
                                                autocomplete="off">
                                            <i class="fas fa-search search-icon"></i>
                                            <input type="hidden" id="producto_base_2">
                                            <div class="producto-search-dropdown" id="dropdown_productos_2" style="display: none;"></div>
                                        </div>
                                    </div>
                                    <div id="info_producto_2" class="alert alert-light" style="display: none;">
                                        <!-- Información del producto seleccionado -->
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label class="form-label">Cantidad</label>
                                        <input type="number" class="form-control" id="cantidad_2" 
                                               step="0.001" min="0.001" 
                                               onchange="calcularPrecioComboMulti()">
                                        <small class="form-text text-muted">Cantidad del producto 2</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- PRODUCTO 3 (OPCIONAL) -->
                    <div class="card mb-3">
                        <div class="card-header bg-secondary text-white">
                            <h6 class="mb-0">
                                <i class="fas fa-plus-circle"></i> Producto 3 (Opcional)
                                <button type="button" class="btn btn-sm btn-outline-light float-end" onclick="limpiarProducto(3)">
                                    <i class="fas fa-times"></i> Quitar
                                </button>
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-8">
                                    <div class="mb-3">
                                        <label class="form-label">Buscar Producto</label>
                                        <div class="producto-search-container">
                                            <input 
                                                type="text" 
                                                class="form-control producto-search-input" 
                                                id="buscar_producto_3" 
                                                placeholder="Escribe para buscar tercer producto..."
                                                autocomplete="off">
                                            <i class="fas fa-search search-icon"></i>
                                            <input type="hidden" id="producto_base_3">
                                            <div class="producto-search-dropdown" id="dropdown_productos_3" style="display: none;"></div>
                                        </div>
                                    </div>
                                    <div id="info_producto_3" class="alert alert-light" style="display: none;">
                                        <!-- Información del producto seleccionado -->
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label class="form-label">Cantidad</label>
                                        <input type="number" class="form-control" id="cantidad_3" 
                                               step="0.001" min="0.001" 
                                               onchange="calcularPrecioComboMulti()">
                                        <small class="form-text text-muted">Cantidad del producto 3</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- RESUMEN DEL COMBO -->
                    <div class="card mb-3" id="resumen_combo" style="display: none;">
                        <div class="card-header bg-success text-white">
                            <h6 class="mb-0"><i class="fas fa-calculator"></i> Resumen del Combo</h6>
                        </div>
                        <div class="card-body" id="contenido_resumen">
                            <!-- Se llena dinámicamente -->
                        </div>
                    </div>
                    
                    <!-- INFORMACIÓN BÁSICA DEL COMBO -->
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Código del Combo</label>
                                <input type="text" class="form-control" id="codigo_combo" placeholder="Se genera automáticamente">
                                <small class="form-text text-muted">Dejar vacío para generar automáticamente</small>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Nombre del Combo</label>
                                <input type="text" class="form-control" id="nombre_combo" placeholder="Se genera automáticamente">
                                <small class="form-text text-muted">Dejar vacío para generar automáticamente</small>
                            </div>
                        </div>
                    </div>
                    
                    <!-- PRECIOS -->
                    <div class="row">
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label class="form-label">Precio Normal Total</label>
                                <div class="input-group">
                                    <span class="input-group-text">$</span>
                                    <input type="text" class="form-control" id="precio_normal_combo" readonly>
                                </div>
                                <small class="form-text text-muted">Suma de precios normales</small>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label class="form-label">Precio de Oferta *</label>
                                <div class="input-group">
                                    <span class="input-group-text">$</span>
                                    <input type="number" class="form-control" id="precio_combo" 
                                           step="0.01" min="0.01" max="99999999.99" required 
                                           onchange="calcularDescuentoMulti()">
                                </div>
                                <small class="form-text text-muted">Precio final del combo</small>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label class="form-label">Descuento</label>
                                <div class="input-group">
                                    <input type="text" class="form-control" id="descuento_combo" readonly>
                                    <span class="input-group-text">%</span>
                                </div>
                                <small class="form-text text-muted">Porcentaje de descuento</small>
                            </div>
                        </div>
                    </div>
                    
                    <!-- INFORMACIÓN DEL DESCUENTO -->
                    <div id="info_descuento" class="alert alert-success" style="display: none;">
                        <!-- Se llena dinámicamente -->
                    </div>
                    
                    <!-- DESCRIPCIÓN -->
                    <div class="mb-3">
                        <label class="form-label">Descripción</label>
                        <textarea class="form-control" id="descripcion_combo" rows="3" 
                                  placeholder="Descripción opcional del combo"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times"></i> Cancelar
                </button>
                <button type="button" class="btn btn-warning" onclick="crearComboMulti()">
                    <i class="fas fa-save"></i> <span id="btnComboTexto">Crear Oferta</span>
                </button>
            </div>
        </div>
    </div>
</div>




<!-- Modal Ajustar Stock -->
<div class="modal fade" id="modalStock" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title">
                    <i class="fas fa-boxes"></i> Ajustar Stock del Combo
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="infoComboStock"></div>
                <form id="formStock">
                    <input type="hidden" id="stockComboId">
                    <div class="mb-3">
                        <label for="tipoMovimiento" class="form-label">Tipo de movimiento</label>
                        <select class="form-select" id="tipoMovimiento">
                            <option value="entrada">Entrada (Agregar stock)</option>
                            <option value="salida">Salida (Quitar stock)</option>
                            <option value="ajuste">Ajuste (Establecer cantidad exacta)</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="cantidadStock" class="form-label">Cantidad</label>
                        <input type="number" class="form-control" id="cantidadStock" min="0" required>
                        <div class="form-text" id="ayudaCantidad">Ingrese la cantidad a agregar</div>
                    </div>
                    <div class="mb-3">
                        <label for="motivo" class="form-label">Motivo</label>
                        <input type="text" class="form-control" id="motivo" placeholder="Ej: Compra, Inventario, etc.">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-info" onclick="guardarStock()">
                    <i class="fas fa-save"></i> Aplicar Cambio
                </button>
            </div>
        </div>
    </div>
</div>


<!-- Modal de Ayuda/Explicación de Combos Multi-Producto -->
<div class="modal fade" id="modalAyudaCombos" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title">
                    <i class="fas fa-lightbulb"></i> ¿Cómo Funcionan los Combos Multi-Producto?
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- Introducción -->
                <div class="alert alert-info">
                    <h6><i class="fas fa-info-circle"></i> ¿Qué es un Combo Multi-Producto?</h6>
                    <p class="mb-0">Un combo es una <strong>oferta especial</strong> que permite combinar <strong>1, 2 o 3 productos diferentes</strong> en una sola oferta con un <strong>precio con descuento</strong>. Ideal para promociones, packs temáticos o ofertas por volumen.</p>
                </div>

                <!-- NUEVO: Sistema de Stock Dinámico -->
                <div class="alert alert-success">
                    <h6><i class="fas fa-sync-alt"></i> NUEVO: Sistema de Stock Dinámico</h6>
                    <p class="mb-0">Los combos ahora usan <strong>stock calculado automáticamente</strong> basado en la disponibilidad de los productos base. No necesitas gestionar stock de combos manualmente.</p>
                </div>

                <!-- Proceso paso a paso -->
                <h6><i class="fas fa-list-ol"></i> Proceso de Creación (Paso a Paso)</h6>
                <div class="row">
                    <div class="col-md-6">
                        <div class="card mb-3">
                            <div class="card-header bg-light">
                                <strong>1. Seleccionar Productos Base</strong>
                            </div>
                            <div class="card-body">
                                <ul class="mb-0">
                                    <li><strong>Producto 1:</strong> Obligatorio</li>
                                    <li><strong>Producto 2:</strong> Opcional</li>
                                    <li><strong>Producto 3:</strong> Opcional</li>
                                    <li>Solo productos activos y NO combos</li>
                                    <li>Pueden ser productos completamente diferentes</li>
                                </ul>
                            </div>
                        </div>
                        
                        <div class="card mb-3">
                            <div class="card-header bg-light">
                                <strong>2. Definir Cantidades</strong>
                            </div>
                            <div class="card-body">
                                <ul class="mb-0">
                                    <li>Cantidad independiente para cada producto</li>
                                    <li>Acepta decimales (ej: 2.5kg)</li>
                                    <li>Ejemplo: 3 x Arroz + 1 x Aceite + 2 x Azúcar</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <div class="card mb-3">
                            <div class="card-header bg-light">
                                <strong>3. Generación Automática</strong>
                            </div>
                            <div class="card-body">
                                <ul class="mb-0">
                                    <li><strong>Código:</strong> ARR001-ACE002-AZU003-COMBO</li>
                                    <li><strong>Nombre:</strong> Pack: 3x Arroz + 1x Aceite + 2x Azúcar (Oferta)</li>
                                    <li><strong>Precio Normal:</strong> $1,500 + $300 + $400 = $2,200</li>
                                </ul>
                            </div>
                        </div>
                        
                        <div class="card mb-3">
                            <div class="card-header bg-light">
                                <strong>4. Definir Precio de Oferta</strong>
                            </div>
                            <div class="card-body">
                                <ul class="mb-0">
                                    <li>Precio especial (menor al normal total)</li>
                                    <li>Ejemplo: $1,800</li>
                                    <li><strong>Ahorro:</strong> $400 (18.2% descuento)</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- NUEVO: Cómo Funciona el Stock Dinámico -->
                <h6><i class="fas fa-sync-alt text-success"></i> Sistema de Stock Dinámico</h6>
                <div class="alert alert-primary">
                    <h6><i class="fas fa-calculator"></i> ¿Cómo se Calcula el Stock?</h6>
                    <p>El stock de combos se calcula automáticamente basado en la disponibilidad de los productos base:</p>
                    <div class="bg-light p-3 rounded">
                        <strong>Ejemplo:</strong> Combo "Pack Asado" (3kg carne + 2 chorizos)<br>
                        • <strong>Carne disponible:</strong> 15kg<br>
                        • <strong>Chorizos disponibles:</strong> 8 unidades<br>
                        • <strong>Stock del combo:</strong> 4 (limitado por: 8 ÷ 2 = 4)<br>
                        <small class="text-muted">El stock siempre está limitado por el producto que menos stock tiene</small>
                    </div>
                </div>

                <!-- NUEVO: Descuento de Stock al Vender -->
                <h6><i class="fas fa-shopping-cart text-primary"></i> Al Realizar una Venta</h6>
                <div class="row">
                    <div class="col-md-6">
                        <div class="alert alert-danger">
                            <h6><i class="fas fa-times"></i> Antes (Sistema Anterior)</h6>
                            <ul class="mb-0">
                                <li>Se descontaba stock del combo únicamente</li>
                                <li>Productos base no se actualizaban</li>
                                <li>Discrepancias entre stock real y mostrado</li>
                            </ul>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="alert alert-success">
                            <h6><i class="fas fa-check"></i> Ahora (Sistema Dinámico)</h6>
                            <ol class="mb-0">
                                <li><strong>Al vender 1 combo</strong> se descuenta automáticamente de productos base</li>
                                <li><strong>El stock del combo se recalcula</strong> automáticamente</li>
                                <li><strong>No se toca el stock físico del combo</strong></li>
                            </ol>
                        </div>
                    </div>
                </div>

                <!-- Ejemplos prácticos actualizados -->
                <h6><i class="fas fa-chart-line"></i> Ejemplos Prácticos Multi-Producto</h6>
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead class="table-primary">
                            <tr>
                                <th>Tipo de Combo</th>
                                <th>Productos</th>
                                <th>Precio Normal</th>
                                <th>Precio Oferta</th>
                                <th>Ahorro</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><strong>Simple</strong><br><small>1 producto</small></td>
                                <td>3 x Detergente 1L</td>
                                <td>$900</td>
                                <td>$750</td>
                                <td class="text-success"><strong>$150 (16.7%)</strong></td>
                            </tr>
                            <tr>
                                <td><strong>Doble</strong><br><small>2 productos</small></td>
                                <td>2 x Arroz 1kg + 1 x Aceite 1L</td>
                                <td>$1,000 + $300 = $1,300</td>
                                <td>$1,100</td>
                                <td class="text-success"><strong>$200 (15.4%)</strong></td>
                            </tr>
                            <tr>
                                <td><strong>Triple</strong><br><small>3 productos</small></td>
                                <td>2 x Shampoo + 1 x Jabón + 3 x Papel</td>
                                <td>$1,600 + $200 + $600 = $2,400</td>
                                <td>$2,000</td>
                                <td class="text-success"><strong>$400 (16.7%)</strong></td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Características importantes -->
                <h6><i class="fas fa-star"></i> Características del Sistema Multi-Producto</h6>
                <div class="row">
                    <div class="col-md-6">
                        <div class="alert alert-success">
                            <h6><i class="fas fa-check-circle"></i> Ventajas</h6>
                            <ul class="mb-0">
                                <li><strong>Flexibilidad:</strong> 1, 2 o 3 productos diferentes</li>
                                <li><strong>Automatización:</strong> Códigos y nombres automáticos</li>
                                <li><strong>Stock Dinámico:</strong> Cálculo automático en tiempo real</li>
                                <li><strong>Cantidades Flexibles:</strong> Decimales permitidos</li>
                                <li><strong>Validaciones:</strong> Impide ofertas sin descuento real</li>
                                <li><strong>Packs Temáticos:</strong> Combina productos relacionados</li>
                            </ul>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="alert alert-warning">
                            <h6><i class="fas fa-exclamation-triangle"></i> Consideraciones</h6>
                            <ul class="mb-0">
                                <li><strong>Producto 1:</strong> Siempre obligatorio</li>
                                <li><strong>Stock:</strong> Calculado automáticamente desde productos base</li>
                                <li><strong>Precio:</strong> Debe ser menor al precio normal total</li>
                                <li><strong>Eliminación:</strong> Solo si no tiene ventas</li>
                                <li><strong>Productos Base:</strong> Deben existir y estar activos</li>
                                <li><strong>No Duplicados:</strong> No repetir productos en el mismo combo</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- Casos de uso -->
                <h6><i class="fas fa-lightbulb"></i> Casos de Uso Ideales</h6>
                <div class="row">
                    <div class="col-md-4">
                        <div class="card text-center mb-2">
                            <div class="card-body py-2">
                                <h6 class="card-title text-primary">Pack Limpieza</h6>
                                <small>Detergente + Lavandina + Jabón</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card text-center mb-2">
                            <div class="card-body py-2">
                                <h6 class="card-title text-primary">Pack Desayuno</h6>
                                <small>Pan + Mermelada + Manteca</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card text-center mb-2">
                            <div class="card-body py-2">
                                <h6 class="card-title text-primary">Pack Asado</h6>
                                <small>3kg Carne + 2x Chorizos</small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ACTUALIZADO: Gestión de Stock Simplificada -->
                <h6><i class="fas fa-boxes"></i> Gestión de Stock Simplificada</h6>
                <div class="alert alert-info">
                    <div class="row">
                        <div class="col-md-4">
                            <strong><i class="fas fa-box text-success"></i> Para Productos Base:</strong><br>
                            <small>• <strong>Entrada:</strong> Agregar stock (compras)<br>
                            • <strong>Salida:</strong> Se descuenta automáticamente al vender combos<br>
                            • <strong>Ajuste:</strong> Inventario manual</small>
                        </div>
                        <div class="col-md-4">
                            <strong><i class="fas fa-layer-group text-primary"></i> Para Combos:</strong><br>
                            <small>• <strong>Stock:</strong> Calculado automáticamente<br>
                            • <strong>No requiere gestión manual</strong><br>
                            • <strong>Se actualiza en tiempo real</strong></small>
                        </div>
                        <div class="col-md-4">
                            <strong><i class="fas fa-sync-alt text-info"></i> Ventajas:</strong><br>
                            <small>• <strong>Stock siempre preciso</strong><br>
                            • <strong>Gestión automática</strong><br>
                            • <strong>Consistencia total</strong></small>
                        </div>
                    </div>
                </div>

                <!-- Código de colores -->
                <h6><i class="fas fa-palette"></i> Códigos de Estado</h6>
                <div class="d-flex justify-content-around text-center">
                    <div>
                        <span class="badge bg-danger fs-6">0</span><br>
                        <small>Sin Stock</small>
                    </div>
                    <div>
                        <span class="badge bg-warning text-dark fs-6">1-5</span><br>
                        <small>Stock Bajo</small>
                    </div>
                    <div>
                        <span class="badge bg-success fs-6">6+</span><br>
                        <small>Stock Bueno</small>
                    </div>
                    <div>
                        <span class="badge bg-success">Activo</span><br>
                        <small>Disponible</small>
                    </div>
                    <div>
                        <span class="badge bg-secondary">Inactivo</span><br>
                        <small>Oculto</small>
                    </div>
                </div>

                <!-- ACTUALIZADO: Tips adicionales -->
                <div class="alert alert-primary mt-3">
                    <h6><i class="fas fa-lightbulb"></i> Consejos Prácticos</h6>
                    <ul class="mb-0">
                        <li><strong>Productos Relacionados:</strong> Combina productos que se compran juntos habitualmente</li>
                        <li><strong>Márgenes Equilibrados:</strong> Asegúrate de mantener rentabilidad en el descuento</li>
                        <li><strong>Stock de Productos Base:</strong> Mantén stock suficiente de todos los productos base</li>
                        <li><strong>Monitoreo:</strong> El sistema te alertará automáticamente cuando algún producto base esté bajo</li>
                        <li><strong>Nombres Claros:</strong> Los nombres automáticos son descriptivos pero puedes personalizarlos</li>
                    </ul>
                </div>

                <!-- NUEVO: Diferencia entre Stock Físico y Dinámico -->
                <div class="alert alert-warning">
                    <h6><i class="fas fa-info-circle"></i> Importante: Stock Dinámico vs Stock Físico</h6>
                    <ul class="mb-0">
                        <li><strong>Stock Físico del Combo:</strong> Permanece sin cambios en la base de datos</li>
                        <li><strong>Stock Dinámico:</strong> Se calcula y muestra en tiempo real</li>
                        <li><strong>Ventas:</strong> Descontarán automáticamente de los productos base correctos</li>
                        <li><strong>Reportes:</strong> Reflejarán movimientos reales de productos base</li>
                    </ul>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times"></i> Cerrar
                </button>
                <button type="button" class="btn btn-success" data-bs-dismiss="modal" onclick="mostrarModalCrearCombo()">
                    <i class="fas fa-plus"></i> Crear Mi Primer Combo Multi-Producto
                </button>
            </div>
        </div>
    </div>
</div>


{% endblock %}

{% block scripts %}
<script>
// Variables globales
let productosBase = [];
let stockActual = 0;

// ===== FUNCIONES PARA COMBOS =====





function mostrarModalCrearCombo() {
    console.log('🎯 Abriendo modal crear combo...');
    
    // Limpiar eventos anteriores primero
    limpiarEventosBusqueda();
    
    document.getElementById('formCrearCombo').reset();
    document.getElementById('combo_id_edit').value = '';
    limpiarSeleccion();
    
    // Resetear título
    document.getElementById('tituloModalCombo').innerHTML = '<i class="fas fa-tags"></i> Crear Nueva Oferta/Combo';
    document.getElementById('btnComboTexto').textContent = 'Crear Oferta';
    
    const modal = new bootstrap.Modal(document.getElementById('modalCrearCombo'));
    modal.show();
    
    // ✅ IMPORTANTE: Inicializar búsqueda DESPUÉS de que el modal esté completamente visible
    modal._element.addEventListener('shown.bs.modal', function() {
        inicializarBusquedaProductos();
    }, { once: true }); // once: true para que solo se ejecute una vez
    
    console.log('✅ Modal combo abierto');
}


let busquedaTimeout = null;
let selectedIndex = -1;
let isDropdownVisible = false;

function inicializarBusquedaProductos() {
    const inputBusqueda = document.getElementById('buscar_producto_base');
    const dropdown = document.getElementById('dropdown_productos');
    
    if (!inputBusqueda || !dropdown) {
        console.warn('⚠️ Elementos de búsqueda no encontrados');
        return;
    }
    
    // ✅ LIMPIAR eventos anteriores para evitar duplicados
    inputBusqueda.removeEventListener('input', buscarEnInput);
    inputBusqueda.removeEventListener('keydown', manejarTeclas);
    
    // ✅ AGREGAR eventos limpios
    inputBusqueda.addEventListener('input', buscarEnInput);
    inputBusqueda.addEventListener('keydown', manejarTeclas);
    
    console.log('✅ Sistema de búsqueda inicializado correctamente');
}

// ✅ FUNCIÓN SEPARADA para el evento input
function buscarEnInput() {
    const termino = this.value.trim();
    
    console.log('🔍 Escribiendo:', termino);
    
    // Limpiar timeout anterior
    clearTimeout(busquedaTimeout);
    
    if (termino.length < 2) {
        ocultarDropdown();
        if (termino.length === 0) {
            limpiarSeleccion();
        }
        return;
    }
    
    // Buscar con debounce de 300ms
    busquedaTimeout = setTimeout(() => {
        buscarProductosBase(termino);
    }, 300);
}

// ✅ FUNCIÓN SEPARADA para manejar teclas
function manejarTeclas(e) {
    if (!isDropdownVisible) return;
    
    const dropdown = document.getElementById('dropdown_productos');
    const items = dropdown.querySelectorAll('.producto-search-item');
    
    switch(e.key) {
        case 'ArrowDown':
            e.preventDefault();
            selectedIndex = Math.min(selectedIndex + 1, items.length - 1);
            actualizarSeleccionVisual(items);
            break;
            
        case 'ArrowUp':
            e.preventDefault();
            selectedIndex = Math.max(selectedIndex - 1, -1);
            actualizarSeleccionVisual(items);
            break;
            
        case 'Enter':
            e.preventDefault();
            if (selectedIndex >= 0 && items[selectedIndex]) {
                items[selectedIndex].click();
            }
            break;
            
        case 'Escape':
            e.preventDefault();
            ocultarDropdown();
            break;
    }
}

// ✅ FUNCIÓN para limpiar eventos cuando se cierra el modal
function limpiarEventosBusqueda() {
    const inputBusqueda = document.getElementById('buscar_producto_base');
    if (inputBusqueda) {
        inputBusqueda.removeEventListener('input', buscarEnInput);
        inputBusqueda.removeEventListener('keydown', manejarTeclas);
    }
}

function buscarProductosBase(termino) {
   const dropdown = document.getElementById('dropdown_productos');
   
   dropdown.innerHTML = `
       <div class="loading-spinner">
           <i class="fas fa-spinner fa-spin"></i> Buscando productos...
       </div>
   `;
   dropdown.style.display = 'block';
   isDropdownVisible = true;
   
   console.log(`🔍 Buscando productos: "${termino}"`);
   
   fetch(`/buscar_productos_admin?buscar=${encodeURIComponent(termino)}&solo_combos=false`)
       .then(response => response.json())
       .then(data => {
           if (data.success) {
               const productos = data.productos.filter(p => p.activo && !p.es_combo);
               mostrarResultadosBusqueda(productos, termino);
           } else {
               mostrarError('Error: ' + (data.error || 'Error desconocido'));
           }
       })
       .catch(error => {
           console.error('❌ Error en búsqueda:', error);
           mostrarError('Error de conexión');
       });
}

function mostrarResultadosBusqueda(productos, termino) {
   const dropdown = document.getElementById('dropdown_productos');
   selectedIndex = -1;
   
   if (productos.length === 0) {
       dropdown.innerHTML = `
           <div class="no-results">
               <i class="fas fa-search"></i> No se encontraron productos para "${termino}"
           </div>
       `;
       return;
   }
   
   console.log(`📦 Mostrando ${productos.length} productos`);
   
   const html = productos.map((producto) => {
       const codigoResaltado = resaltarTexto(producto.codigo, termino);
       const nombreResaltado = resaltarTexto(producto.nombre, termino);
       
       return `
           <div class="producto-search-item" 
                onclick="seleccionarProducto(${producto.id}, '${producto.codigo}', '${escapeHtml(producto.nombre)}', ${producto.precio})">
               <div class="producto-codigo">${codigoResaltado}</div>
               <div class="producto-nombre">${nombreResaltado}</div>
               <div class="producto-precio">$${producto.precio.toFixed(2)}</div>
           </div>
       `;
   }).join('');
   
   dropdown.innerHTML = html;
}

function resaltarTexto(texto, termino) {
   if (!termino) return texto;
   
   const regex = new RegExp(`(${escapeRegExp(termino)})`, 'gi');
   return texto.replace(regex, '<strong style="background-color: #fff3cd;">$1</strong>');
}

function escapeRegExp(string) {
   return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
}

function escapeHtml(text) {
   return String(text).replace(/[&<>"']/g, function (s) {
       return {
           '&': '&amp;',
           '<': '&lt;',
           '>': '&gt;',
           '"': '&quot;',
           "'": '&#39;'
       }[s];
   });
}

function seleccionarProducto(id, codigo, nombre, precio) {
   console.log(`✅ Seleccionado: ${codigo} - ${nombre} ($${precio})`);
   
   document.getElementById('buscar_producto_base').value = `${codigo} - ${nombre}`;
   document.getElementById('producto_base_combo').value = id;
   
   const input = document.getElementById('buscar_producto_base');
   input.classList.add('producto-seleccionado');
   
   ocultarDropdown();
   actualizarInfoProductoBase(id, codigo, nombre, precio);
   calcularPrecioCombo();
}

function actualizarSeleccionVisual(items) {
   items.forEach(item => item.classList.remove('active'));
   
   if (selectedIndex >= 0 && items[selectedIndex]) {
       items[selectedIndex].classList.add('active');
       items[selectedIndex].scrollIntoView({ block: 'nearest' });
   }
}

function ocultarDropdown() {
   const dropdown = document.getElementById('dropdown_productos');
   if (dropdown) {
       dropdown.style.display = 'none';
   }
   isDropdownVisible = false;
   selectedIndex = -1;
}

function mostrarError(mensaje) {
   const dropdown = document.getElementById('dropdown_productos');
   dropdown.innerHTML = `
       <div class="no-results text-danger">
           <i class="fas fa-exclamation-triangle"></i> ${mensaje}
       </div>
   `;
}

function limpiarSeleccion() {
   document.getElementById('producto_base_combo').value = '';
   
   const input = document.getElementById('buscar_producto_base');
   if (input) {
       input.value = '';
       input.classList.remove('producto-seleccionado');
   }
   
   document.getElementById('info_producto_base').style.display = 'none';
   document.getElementById('precio_normal_combo').value = '';
   document.getElementById('info_descuento').style.display = 'none';
}


function actualizarInfoProductoBase(id, codigo, nombre, precio) {
   const infoDiv = document.getElementById('info_producto_base');
   
   infoDiv.innerHTML = `
       <h6><i class="fas fa-info-circle"></i> Producto Base Seleccionado</h6>
       <div class="row">
           <div class="col-md-4"><strong>Código:</strong> ${codigo}</div>
           <div class="col-md-4"><strong>Producto:</strong> ${nombre}</div>
           <div class="col-md-4"><strong>Precio unitario:</strong> $${precio.toFixed(2)}</div>
       </div>
   `;
   infoDiv.style.display = 'block';
}

function calcularPrecioCombo() {
    const productId = document.getElementById('producto_base_combo').value;
    const cantidad = parseFloat(document.getElementById('cantidad_combo').value);
    
    if (!productId || !cantidad || cantidad <= 0) {
        document.getElementById('precio_normal_combo').value = '';
        return;
    }
    
    // ✅ MÉTODO MEJORADO: Obtener precio del producto seleccionado
    const inputText = document.getElementById('buscar_producto_base').value;
    
    // Buscar precio en el formato $123.45 o $1,234.56 o $1.234.567,89
    const precioRegex = /\$([0-9]{1,3}(?:[.,][0-9]{3})*(?:[.,][0-9]{1,2})?)/;
    const precioMatch = inputText.match(precioRegex);
    
    if (precioMatch) {
        // Limpiar formato de precio (quitar puntos de miles, convertir coma decimal a punto)
        let precioTexto = precioMatch[1];
        
        // Si tiene coma como separador decimal (formato argentino)
        if (precioTexto.includes(',')) {
            // Separar parte entera de decimal
            const partes = precioTexto.split(',');
            if (partes.length === 2) {
                // Quitar puntos de miles de la parte entera
                const parteEntera = partes[0].replace(/\./g, '');
                const parteDecimal = partes[1];
                precioTexto = parteEntera + '.' + parteDecimal;
            }
        } else {
            // Formato con punto decimal - solo quitar puntos de miles (mantener último punto como decimal)
            const puntos = precioTexto.split('.');
            if (puntos.length > 2) {
                // Hay puntos de miles
                const parteDecimal = puntos.pop(); // Última parte es decimal
                const parteEntera = puntos.join(''); // Unir el resto sin puntos
                precioTexto = parteEntera + '.' + parteDecimal;
            }
        }
        
        const precioUnitario = parseFloat(precioTexto);
        
        if (!isNaN(precioUnitario)) {
            const precioNormal = precioUnitario * cantidad;
            
            // ✅ FORMATEAR precio normal con separadores de miles
            document.getElementById('precio_normal_combo').value = formatearPrecio(precioNormal);
            
            console.log('💰 Cálculo exitoso:');
            console.log(`   Precio unitario: $${precioUnitario}`);
            console.log(`   Cantidad: ${cantidad}`);
            console.log(`   Precio normal: $${precioNormal}`);
            
            generarCodigoNombreAutomatico();
            calcularDescuento();
        } else {
            console.warn('⚠️ No se pudo parsear el precio:', precioTexto);
        }
    } else {
        console.warn('⚠️ No se encontró precio en el texto:', inputText);
    }
}

// ✅ FUNCIÓN AUXILIAR para formatear precios con separadores de miles
function formatearPrecio(numero) {
    if (isNaN(numero)) return '0.00';
    
    return numero.toLocaleString('es-AR', {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
    });
}

// ✅ FUNCIÓN AUXILIAR para limpiar formato de precio antes de enviar al servidor
function limpiarFormatoPrecio(precioFormateado) {
    if (!precioFormateado) return 0;
    
    // Quitar todos los separadores y convertir coma decimal a punto
    return parseFloat(
        precioFormateado
            .replace(/[^\d,-]/g, '') // Quitar todo excepto dígitos, coma y guión
            .replace(/\./g, '')      // Quitar puntos de miles
            .replace(/,/g, '.')      // Convertir coma decimal a punto
    );
}

// ✅ FUNCIÓN MEJORADA para generar código y nombre automáticamente
function generarCodigoNombreAutomatico() {
    const inputText = document.getElementById('buscar_producto_base').value;
    const cantidad = parseFloat(document.getElementById('cantidad_combo').value);
    
    if (!inputText || !cantidad) {
        console.log('⚠️ No hay texto o cantidad para generar código/nombre');
        return;
    }
    
    console.log('🏷️ Generando código y nombre automático...');
    console.log(`   Input: "${inputText}"`);
    console.log(`   Cantidad: ${cantidad}`);
    
    // ✅ EXTRAER CÓDIGO del formato: "ABC123 - Nombre del producto"
    const codigoMatch = inputText.match(/^([A-Z0-9\-_]+)/i);
    if (!codigoMatch) {
        console.warn('⚠️ No se pudo extraer código del texto');
        return;
    }
    
    const codigoBase = codigoMatch[1].toUpperCase();
    
    // ✅ EXTRAER NOMBRE del formato: "CODIGO - Nombre del producto"
    const nombreMatch = inputText.match(/^[^-]+-\s*(.+?)(?:\s*\$|$)/);
    if (!nombreMatch) {
        console.warn('⚠️ No se pudo extraer nombre del texto');
        return;
    }
    
    const nombreBase = nombreMatch[1].trim();
    
    // ✅ GENERAR CÓDIGO del combo
    const cantidadStr = cantidad.toString().replace('.', '').replace(',', '');
    const codigoCombo = `${codigoBase}-${cantidadStr}UN`;
    
    // ✅ GENERAR NOMBRE del combo
    const cantidadFormat = cantidad % 1 === 0 ? 
        cantidad.toString() : 
        cantidad.toFixed(3).replace(/\.?0+$/, ''); // Eliminar ceros innecesarios
    
    const nombreCombo = `${cantidadFormat} x ${nombreBase} (Oferta)`;
    
    // ✅ APLICAR solo si los campos están vacíos
    const campoCodigo = document.getElementById('codigo_combo');
    const campoNombre = document.getElementById('nombre_combo');
    
    if (!campoCodigo.value.trim()) {
        campoCodigo.value = codigoCombo;
        console.log(`   ✅ Código generado: ${codigoCombo}`);
    } else {
        console.log(`   ℹ️ Código ya tiene valor: ${campoCodigo.value}`);
    }
    
    if (!campoNombre.value.trim()) {
        campoNombre.value = nombreCombo;
        console.log(`   ✅ Nombre generado: ${nombreCombo}`);
    } else {
        console.log(`   ℹ️ Nombre ya tiene valor: ${campoNombre.value}`);
    }
}


function calcularDescuento() {
    const precioNormalTexto = document.getElementById('precio_normal_combo').value;
    const precioOferta = parseFloat(document.getElementById('precio_combo').value);
    const infoDiv = document.getElementById('info_descuento');
    
    // ✅ LIMPIAR formato del precio normal
    const precioNormal = limpiarFormatoPrecio(precioNormalTexto);
    
    if (!precioNormal || !precioOferta || precioOferta <= 0) {
        document.getElementById('descuento_combo').value = '';
        infoDiv.style.display = 'none';
        return;
    }
    
    if (precioOferta >= precioNormal) {
        document.getElementById('descuento_combo').value = '0.00';
        infoDiv.innerHTML = '<i class="fas fa-exclamation-triangle"></i> <strong>¡Atención!</strong> El precio de oferta es igual o mayor al precio normal.';
        infoDiv.className = 'alert alert-warning';
        infoDiv.style.display = 'block';
        return;
    }
    
    const descuento = ((precioNormal - precioOferta) / precioNormal) * 100;
    const ahorro = precioNormal - precioOferta;
    
    document.getElementById('descuento_combo').value = descuento.toFixed(2);
    
    infoDiv.innerHTML = `
        <i class="fas fa-check-circle"></i> <strong>¡Excelente oferta!</strong><br>
        <div class="row mt-2">
            <div class="col-md-4"><strong>Precio normal:</strong> $${formatearPrecio(precioNormal)}</div>
            <div class="col-md-4"><strong>Precio oferta:</strong> $${formatearPrecio(precioOferta)}</div>
            <div class="col-md-4"><strong>Ahorro:</strong> $${formatearPrecio(ahorro)} (${descuento.toFixed(1)}%)</div>
        </div>
    `;
    infoDiv.className = 'alert alert-success';
    infoDiv.style.display = 'block';
}


function crearCombo() {
    console.log('🚀 Creando/editando combo...');
    const form = document.getElementById('formCrearCombo');
    
    if (!form.checkValidity()) {
        form.reportValidity();
        return;
    }
    
    const comboId = document.getElementById('combo_id_edit').value;
    const esEdicion = !!comboId;
    
    const datos = {
        producto_base_id: parseInt(document.getElementById('producto_base_combo').value),
        cantidad_combo: parseFloat(document.getElementById('cantidad_combo').value),
        precio_combo: limpiarFormatoPrecio(document.getElementById('precio_combo').value),
        codigo_combo: document.getElementById('codigo_combo').value.trim(),
        nombre_combo: document.getElementById('nombre_combo').value.trim(),
        descripcion_combo: document.getElementById('descripcion_combo').value.trim()
    };
    
    // ✅ SI ES EDICIÓN, AGREGAR EL ID AL OBJETO DE DATOS
    if (esEdicion) {
        datos.id = parseInt(comboId);
    }
    
    if (datos.cantidad_combo <= 0) {
        alert('La cantidad debe ser mayor a 0');
        return;
    }
    
    if (datos.precio_combo <= 0) {
        alert('El precio de oferta debe ser mayor a 0');
        return;
    }
    
    console.log('📤 Enviando datos:', datos);
    console.log('🔧 Modo:', esEdicion ? 'EDICIÓN' : 'CREACIÓN');
    
    const btnCrear = document.querySelector('#modalCrearCombo .btn-warning');
    const textoOriginal = btnCrear.innerHTML;
    btnCrear.innerHTML = `<i class="fas fa-spinner fa-spin"></i> ${esEdicion ? 'Actualizando' : 'Creando'}...`;
    btnCrear.disabled = true;
    
    // ✅ USAR SIEMPRE EL MISMO ENDPOINT PERO CON ID EN LOS DATOS
    const url = '/api/crear_combo';
    
    fetch(url, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(datos)
    })
    .then(response => response.json())
    .then(result => {
        console.log('📥 Respuesta del servidor:', result);
        
        if (result.success) {
            alert(`✅ Oferta ${esEdicion ? 'actualizada' : 'creada'} exitosamente: ${datos.codigo_combo}`);
            
            const modal = bootstrap.Modal.getInstance(document.getElementById('modalCrearCombo'));
            modal.hide();
            
            // Recargar página para mostrar cambios
            window.location.reload();
            
        } else {
            alert(`❌ Error al ${esEdicion ? 'actualizar' : 'crear'} oferta: ${result.error}`);
        }
    })
    .catch(error => {
        console.error('❌ Error:', error);
        alert(`❌ Error de conexión al ${esEdicion ? 'actualizar' : 'crear'} la oferta`);
    })
    .finally(() => {
        btnCrear.innerHTML = textoOriginal;
        btnCrear.disabled = false;
    });
}


function editarCombo(comboId) {
    console.log(`✏️ Editando combo ID: ${comboId}`);
    
    fetch(`/api/producto_detalle/${comboId}`)
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                alert('Error: ' + data.error);
                return;
            }
            
            if (!data.es_combo) {
                alert('Este producto no es un combo');
                return;
            }
            
            // Cargar datos básicos
            document.getElementById('combo_id_edit').value = comboId;
            document.getElementById('codigo_combo').value = data.codigo;
            document.getElementById('nombre_combo').value = data.nombre;
            document.getElementById('descripcion_combo').value = data.descripcion || '';
            document.getElementById('precio_combo').value = data.precio;
            
            // CORREGIDO: Cargar producto 1 (obligatorio)
            if (data.producto_base_id) {
                const input1 = document.getElementById('buscar_producto_1');
                const hidden1 = document.getElementById('producto_base_1');
                const cantidad1 = document.getElementById('cantidad_1');
                
                if (data.producto_base) {
                    input1.value = `${data.producto_base.codigo} - ${data.producto_base.nombre}`;
                    input1.classList.add('producto-seleccionado');
                    hidden1.value = data.producto_base_id;
                    cantidad1.value = data.cantidad_combo || 1;
                    
                    // Actualizar info del producto
                    actualizarInfoProductoEspecifico(1, 
                        data.producto_base.id,
                        data.producto_base.codigo,
                        data.producto_base.nombre,
                        data.producto_base.precio
                    );
                    
                    // Guardar en variable global
                    productosSeleccionados[1] = {
                        id: data.producto_base.id,
                        codigo: data.producto_base.codigo,
                        nombre: data.producto_base.nombre,
                        precio: data.producto_base.precio
                    };
                }
            }
            
            // Cargar producto 2 (opcional)
            if (data.producto_base_2_id && data.producto_base_2) {
                const input2 = document.getElementById('buscar_producto_2');
                const hidden2 = document.getElementById('producto_base_2');
                const cantidad2 = document.getElementById('cantidad_2');
                
                input2.value = `${data.producto_base_2.codigo} - ${data.producto_base_2.nombre}`;
                input2.classList.add('producto-seleccionado');
                hidden2.value = data.producto_base_2_id;
                cantidad2.value = data.cantidad_combo_2 || 0;
                
                actualizarInfoProductoEspecifico(2,
                    data.producto_base_2.id,
                    data.producto_base_2.codigo,
                    data.producto_base_2.nombre,
                    data.producto_base_2.precio
                );
                
                productosSeleccionados[2] = {
                    id: data.producto_base_2.id,
                    codigo: data.producto_base_2.codigo,
                    nombre: data.producto_base_2.nombre,
                    precio: data.producto_base_2.precio
                };
            }
            
            // Cargar producto 3 (opcional)
            if (data.producto_base_3_id && data.producto_base_3) {
                const input3 = document.getElementById('buscar_producto_3');
                const hidden3 = document.getElementById('producto_base_3');
                const cantidad3 = document.getElementById('cantidad_3');
                
                input3.value = `${data.producto_base_3.codigo} - ${data.producto_base_3.nombre}`;
                input3.classList.add('producto-seleccionado');
                hidden3.value = data.producto_base_3_id;
                cantidad3.value = data.cantidad_combo_3 || 0;
                
                actualizarInfoProductoEspecifico(3,
                    data.producto_base_3.id,
                    data.producto_base_3.codigo,
                    data.producto_base_3.nombre,
                    data.producto_base_3.precio
                );
                
                productosSeleccionados[3] = {
                    id: data.producto_base_3.id,
                    codigo: data.producto_base_3.codigo,
                    nombre: data.producto_base_3.nombre,
                    precio: data.producto_base_3.precio
                };
            }
            
            // Recalcular precios
            calcularPrecioComboMulti();
            calcularDescuentoMulti();
            
            // Cambiar título del modal
            document.getElementById('tituloModalCombo').innerHTML = '<i class="fas fa-edit"></i> Editar Oferta/Combo';
            document.getElementById('btnComboTexto').textContent = 'Actualizar Oferta';
            
            // Mostrar modal
            const modal = new bootstrap.Modal(document.getElementById('modalCrearCombo'));
            modal.show();
            
            // Inicializar búsqueda después de mostrar el modal
            modal._element.addEventListener('shown.bs.modal', function() {
                inicializarBusquedaMultiProducto();
            }, { once: true });
            
        })
        .catch(error => {
            console.error('❌ Error:', error);
            alert('Error al cargar los datos del combo');
        });
}

function toggleCombo(id) {
    if (confirm('¿Cambiar el estado del combo?')) {
        fetch(`/toggle_producto/${id}`, {
            method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.message);
                window.location.reload();
            } else {
                alert('Error: ' + (data.error || 'Error desconocido'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error de conexión al cambiar estado del combo');
        });
    }
}

function duplicarCombo(id) {
    if (confirm('¿Duplicar este combo?')) {
        fetch(`/api/duplicar_combo/${id}`, {
            method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(`✅ Combo duplicado exitosamente: ${data.nuevo_codigo}`);
                window.location.reload();
            } else {
                alert('Error: ' + (data.error || 'Error desconocido'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error de conexión al duplicar combo');
        });
    }
}

function ajustarStock(id) {
    // Primero obtener información del combo
    fetch(`/api/producto_detalle/${id}`)
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                alert('Error: ' + data.error);
                return;
            }
            
            stockActual = data.stock;
            
            document.getElementById('stockComboId').value = id;
            document.getElementById('infoComboStock').innerHTML = `
                <div class="alert alert-info">
                    <strong>Combo:</strong> ${data.codigo} - ${data.nombre}<br>
                    <strong>Stock actual:</strong> <span class="badge bg-primary">${data.stock} unidades</span><br>
                    <strong>Producto base:</strong> ${data.producto_base ? data.producto_base.nombre : 'Sin base'}
                </div>
            `;
            
            // Limpiar formulario
            document.getElementById('formStock').reset();
            document.getElementById('tipoMovimiento').value = 'entrada';
            document.getElementById('cantidadStock').min = '1';
            document.getElementById('ayudaCantidad').textContent = 'Ingrese la cantidad a agregar';
            
            // Mostrar modal
            new bootstrap.Modal(document.getElementById('modalStock')).show();
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error al cargar información del combo');
        });
}

function guardarStock() {
    const form = document.getElementById('formStock');
    
    if (!form.checkValidity()) {
        form.reportValidity();
        return;
    }
    
    const formData = {
        producto_id: document.getElementById('stockComboId').value,
        tipo_movimiento: document.getElementById('tipoMovimiento').value,
        cantidad: parseInt(document.getElementById('cantidadStock').value),
        motivo: document.getElementById('motivo').value.trim()
    };
    
    // Validaciones adicionales
    if (formData.cantidad <= 0 && formData.tipo_movimiento !== 'ajuste') {
        alert('La cantidad debe ser mayor a 0');
        return;
    }
    
    if (formData.tipo_movimiento === 'ajuste' && formData.cantidad < 0) {
        alert('La cantidad para ajuste no puede ser negativa');
        return;
    }
    
    // Mostrar indicador de carga
    const btnGuardar = document.querySelector('#modalStock .btn-info');
    const textoOriginal = btnGuardar.innerHTML;
    btnGuardar.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Procesando...';
    btnGuardar.disabled = true;
    
    // Enviar datos al servidor
    fetch('/ajustar_stock', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(formData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(`${data.message}\n\nStock anterior: ${data.stock_anterior}\nStock nuevo: ${data.stock_nuevo}`);
            
            // Cerrar modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('modalStock'));
            modal.hide();
            
            // Recargar la página para mostrar los cambios
            window.location.reload();
        } else {
            alert('Error: ' + (data.error || 'Error desconocido'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error de conexión al ajustar stock');
    })
    .finally(() => {
        // Restaurar botón
        btnGuardar.innerHTML = textoOriginal;
        btnGuardar.disabled = false;
    });
}

// ===== FUNCIONES DE FILTRADO =====

function aplicarFiltrosCombos() {
    const buscar = document.getElementById('buscarCombo').value.trim();
    const estado = document.getElementById('filtroEstado').value;
    const descuento = document.getElementById('filtroDescuento').value;
    
    console.log('🔍 Aplicando filtros combos:');
    console.log('   Buscar:', buscar);
    console.log('   Estado:', estado);
    console.log('   Descuento:', descuento);
    
    // Construir URL con parámetros
    const params = new URLSearchParams();
    if (buscar) params.append('buscar', buscar);
    if (estado) params.append('estado', estado);
    if (descuento) params.append('descuento', descuento);
    
    // ✅ IMPORTANTE: Siempre agregar el filtro solo_combos=true
    params.append('solo_combos', 'true');
    
    console.log('📤 URL de búsqueda:', `/buscar_productos_admin?${params.toString()}`);
    
    // Mostrar indicador de carga
    const tbody = document.querySelector('#tablaCombos tbody');
    tbody.innerHTML = `
        <tr>
            <td colspan="11" class="text-center py-4">
                <i class="fas fa-spinner fa-spin fa-2x"></i><br>
                <span class="text-muted">Buscando combos...</span>
            </td>
        </tr>
    `;
    
    fetch(`/buscar_productos_admin?${params.toString()}`)
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('📥 Respuesta recibida:', data);
            
            if (data.success) {
                actualizarTablaCombos(data.productos);
                console.log(`✅ Filtros aplicados: ${data.total} combos encontrados`);
            } else {
                console.error('❌ Error en respuesta:', data.error);
                alert('Error en la búsqueda: ' + (data.error || 'Error desconocido'));
                
                // Mostrar mensaje de error en la tabla
                tbody.innerHTML = `
                    <tr>
                        <td colspan="11" class="text-center text-danger py-4">
                            <i class="fas fa-exclamation-triangle fa-2x mb-2"></i><br>
                            Error en la búsqueda: ${data.error || 'Error desconocido'}
                        </td>
                    </tr>
                `;
            }
        })
        .catch(error => {
            console.error('❌ Error de conexión:', error);
            alert('Error de conexión en la búsqueda: ' + error.message);
            
            // Mostrar mensaje de error en la tabla
            tbody.innerHTML = `
                <tr>
                    <td colspan="11" class="text-center text-danger py-4">
                        <i class="fas fa-wifi fa-2x mb-2"></i><br>
                        Error de conexión: ${error.message}
                    </td>
                </tr>
            `;
        });
}


function limpiarFiltrosCombos() {
    console.log('🧹 Limpiando filtros');
    
    document.getElementById('buscarCombo').value = '';
    document.getElementById('filtroEstado').value = '';
    document.getElementById('filtroDescuento').value = '';
    
    // Aplicar filtros vacíos (mostrará todos los combos)
    aplicarFiltrosCombos();
}

function actualizarTablaCombos(combos) {
    const tbody = document.querySelector('#tablaCombos tbody');
    
    console.log(`📊 Actualizando tabla con ${combos.length} combos`);
    
    if (combos.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="11" class="text-center text-muted py-4">
                    <i class="fas fa-search fa-2x mb-2"></i><br>
                    No se encontraron combos con los criterios especificados
                </td>
            </tr>
        `;
        return;
    }
    
    tbody.innerHTML = combos.map(combo => {
        // Guardar el ID para posible uso en toggleCombo desde eliminar
        window.lastComboId = combo.id;
        
        const stockBadge = getStockBadge(combo.stock);
        const estadoBadge = combo.activo ? 
            '<span class="badge bg-success">Activo</span>' : 
            '<span class="badge bg-secondary">Inactivo</span>';
        
        // Calcular descuento y ahorro
        let descuentoHtml = '<span class="text-muted">-</span>';
        let ahorroHtml = '<span class="text-muted">-</span>';
        let precioNormalHtml = '<span class="text-muted">-</span>';
        
        if (combo.producto_base && combo.cantidad_combo) {
            const precioNormal = combo.producto_base.precio * combo.cantidad_combo;
            const descuento = ((precioNormal - combo.precio) / precioNormal * 100);
            const ahorro = precioNormal - combo.precio;
            
            let badgeClass = 'bg-secondary';
            if (descuento > 30) badgeClass = 'bg-danger';
            else if (descuento > 15) badgeClass = 'bg-warning text-dark';
            
            descuentoHtml = `<span class="badge ${badgeClass}">-${descuento.toFixed(1)}%</span>`;
            ahorroHtml = `<span class="text-success"><strong>$${ahorro.toFixed(0)}</strong></span>`;
            precioNormalHtml = `<span class="text-muted">$${precioNormal.toFixed(2)}</span>`;
        }
        
        return `
            <tr>
                <td><code>${combo.codigo}</code></td>
                <td>
                    <strong>${combo.nombre}</strong>
                    <br><span class="badge bg-warning text-dark">OFERTA</span>
                    ${combo.descripcion ? 
                        `<br><small class="text-muted">${combo.descripcion.substring(0, 50)}${combo.descripcion.length > 50 ? '...' : ''}</small>` : 
                        ''
                    }
                </td>
                <td>
                    ${combo.producto_base ? 
                        `<strong>${combo.producto_base.codigo}</strong><br>
                         <small class="text-muted">${combo.producto_base.nombre}</small><br>
                         <span class="badge bg-info">$${combo.producto_base.precio.toFixed(2)}</span>` :
                        '<span class="text-muted">Sin base</span>'
                    }
                </td>
                <td class="text-center">
                    <span class="badge bg-info">${combo.cantidad_combo || 1}x</span>
                </td>
                <td class="text-end">${precioNormalHtml}</td>
                <td class="text-end">
                    <strong class="text-success">$${combo.precio.toFixed(2)}</strong>
                </td>
                <td class="text-center">${descuentoHtml}</td>
                <td class="text-center">${ahorroHtml}</td>
                <td class="text-center">${stockBadge}</td>
                <td>${estadoBadge}</td>
                <td>
                    <div class="btn-group btn-group-sm">
                        <button class="btn btn-warning" onclick="editarCombo(${combo.id})" title="Editar">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-info" onclick="ajustarStock(${combo.id})" title="Ajustar Stock">
                            <i class="fas fa-boxes"></i>
                        </button>
                        <button class="btn btn-${combo.activo ? 'danger' : 'success'}" onclick="toggleCombo(${combo.id})" title="${combo.activo ? 'Desactivar' : 'Activar'}">
                            <i class="fas fa-power-off"></i>
                        </button>
                        <button class="btn btn-secondary" onclick="duplicarCombo(${combo.id})" title="Duplicar">
                            <i class="fas fa-copy"></i>
                        </button>
                        <button class="btn btn-outline-danger" onclick="eliminarCombo(${combo.id})" title="Eliminar Definitivamente">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </td>
            </tr>
        `;
    }).join('');
    
    console.log('✅ Tabla actualizada correctamente con botón eliminar');
}

// Función auxiliar para obtener el badge de stock
function getStockBadge(stock) {
    if (stock <= 0) {
        return `<span class="badge bg-danger">${stock}</span>`;
    } else if (stock < 10) {
        return `<span class="badge bg-warning text-dark">${stock}</span>`;
    } else {
        return `<span class="badge bg-success">${stock}</span>`;
    }
}

// ===== EVENT LISTENERS =====

document.addEventListener('DOMContentLoaded', function() {
    console.log('🚀 Inicializando página de combos...');
    
       
    // ✅ APLICAR FILTROS INICIAL PARA MOSTRAR SOLO COMBOS
    console.log('🔄 Cargando combos iniciales...');
    aplicarFiltrosCombos();
    
    // Cambiar ayuda según tipo de movimiento de stock
    document.getElementById('tipoMovimiento').addEventListener('change', function() {
        const tipo = this.value;
        const cantidadInput = document.getElementById('cantidadStock');
        const ayuda = document.getElementById('ayudaCantidad');
        
        switch(tipo) {
            case 'entrada':
                cantidadInput.min = '1';
                ayuda.textContent = 'Ingrese la cantidad a agregar';
                break;
            case 'salida':
                cantidadInput.min = '1';
                ayuda.textContent = `Ingrese la cantidad a quitar (máximo: ${stockActual})`;
                break;
            case 'ajuste':
                cantidadInput.min = '0';
                ayuda.textContent = 'Ingrese la cantidad final que debe quedar';
                break;
        }
    });
    
    // Búsqueda en tiempo real con debounce
    const inputBuscar = document.getElementById('buscarCombo');
    let timeoutBusqueda;
    
    inputBuscar.addEventListener('input', function() {
        clearTimeout(timeoutBusqueda);
        timeoutBusqueda = setTimeout(() => {
            console.log('🔍 Búsqueda en tiempo real activada');
            aplicarFiltrosCombos();
        }, 500);
    });
    
    // Aplicar filtros cuando cambien los selects
    document.getElementById('filtroEstado').addEventListener('change', function() {
        console.log('📊 Filtro estado cambiado:', this.value);
        aplicarFiltrosCombos();
    });
    
    document.getElementById('filtroDescuento').addEventListener('change', function() {
        console.log('💰 Filtro descuento cambiado:', this.value);
        aplicarFiltrosCombos();
    });
    
    console.log('✅ Página de combos inicializada correctamente');
});

function eliminarCombo(comboId) {
    console.log(`🗑️ Solicitando eliminación de combo ID: ${comboId}`);
    
    // Primero verificar si se puede eliminar
    fetch(`/api/verificar_eliminacion_combo/${comboId}`)
        .then(response => response.json())
        .then(data => {
            if (data.puede_eliminar) {
                // Es seguro eliminar - mostrar confirmación
                mostrarConfirmacionEliminacion(comboId, data);
            } else {
                // No se puede eliminar - mostrar por qué
                mostrarRazonNoEliminacion(data);
            }
        })
        .catch(error => {
            console.error('Error verificando eliminación:', error);
            alert('Error al verificar si el combo puede eliminarse');
        });
}

function mostrarConfirmacionEliminacion(comboId, data) {
    const mensaje = `¿Estás seguro de que quieres ELIMINAR DEFINITIVAMENTE este combo?

📦 Combo: ${data.codigo} - ${data.nombre}
📊 Stock actual: ${data.stock}
💡 Esta acción NO se puede deshacer

Si solo quieres ocultarlo temporalmente, usa el botón "Desactivar" en su lugar.`;

    if (confirm(mensaje)) {
        ejecutarEliminacionCombo(comboId, data);
    }
}

function mostrarRazonNoEliminacion(data) {
    let mensaje = `❌ No se puede eliminar el combo "${data.codigo}":\n\n`;
    
    if (data.motivo === 'tiene_ventas') {
        mensaje += `🛒 El combo tiene ${data.ventas_count} ventas registradas.\n`;
        mensaje += `💡 Para preservar el historial de ventas, solo puedes DESACTIVARLO.\n\n`;
        mensaje += `¿Quieres desactivar el combo en su lugar?`;
        
        if (confirm(mensaje)) {
            // Si acepta, desactivar en lugar de eliminar
            toggleCombo(data.id || parseInt(window.lastComboId));
        }
    } else if (data.motivo === 'facturas_pendientes') {
        mensaje += `📄 El combo está en ${data.facturas_pendientes} facturas pendientes de autorización.\n`;
        mensaje += `💡 Espera a que se procesen las facturas pendientes e intenta nuevamente.`;
        alert(mensaje);
    } else {
        mensaje += `🤔 Motivo: ${data.mensaje || 'Motivo desconocido'}`;
        alert(mensaje);
    }
}

function ejecutarEliminacionCombo(comboId, data) {
    console.log(`🗑️ Ejecutando eliminación de combo ${data.codigo}...`);
    
    fetch(`/api/eliminar_combo/${comboId}`, {
        method: 'DELETE',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            alert(`✅ ${result.message}`);
            
            // Recargar la página para mostrar cambios
            window.location.reload();
        } else {
            console.error('Error del servidor:', result.error);
            
            // Si el error es que tiene ventas, ofrecer desactivar
            if (result.motivo === 'tiene_ventas') {
                const mensaje = `${result.error}\n\n¿Quieres desactivar el combo en su lugar?`;
                if (confirm(mensaje)) {
                    toggleCombo(comboId);
                }
            } else {
                alert(`❌ ${result.error}`);
            }
        }
    })
    .catch(error => {
        console.error('Error de conexión:', error);
        alert('❌ Error de conexión al eliminar combo');
    });
}

// Función para mostrar el modal de ayuda
function mostrarAyudaCombos() {
    console.log('📚 Mostrando ayuda de combos...');
    const modal = new bootstrap.Modal(document.getElementById('modalAyudaCombos'));
    modal.show();
}


// ===== FUNCIONES PARA COMBOS MULTI-PRODUCTO =====

// Variables globales para cada producto
let productosSeleccionados = {
    1: null,
    2: null,
    3: null
};

let timeoutsBusqueda = {
    1: null,
    2: null,
    3: null
};

// Inicializar sistema de búsqueda multi-producto
function inicializarBusquedaMultiProducto() {
    console.log('🔧 Inicializando búsqueda multi-producto...');
    
    // Inicializar para cada producto (1, 2, 3)
    for (let i = 1; i <= 3; i++) {
        const inputBusqueda = document.getElementById(`buscar_producto_${i}`);
        const dropdown = document.getElementById(`dropdown_productos_${i}`);
        
        if (inputBusqueda && dropdown) {
            // Limpiar eventos anteriores
            inputBusqueda.removeEventListener('input', inputBusqueda._buscarHandler);
            inputBusqueda.removeEventListener('keydown', inputBusqueda._teclasHandler);
            
            // Crear handlers específicos para este producto
            inputBusqueda._buscarHandler = crearBuscarHandler(i);
            inputBusqueda._teclasHandler = crearTeclasHandler(i);
            
            // Agregar eventos
            inputBusqueda.addEventListener('input', inputBusqueda._buscarHandler);
            inputBusqueda.addEventListener('keydown', inputBusqueda._teclasHandler);
            
            console.log(`✅ Producto ${i} inicializado`);
        }
    }
}

// Crear handler específico para búsqueda de cada producto
function crearBuscarHandler(numeroProducto) {
    return function() {
        const termino = this.value.trim();
        
        console.log(`🔍 Producto ${numeroProducto} - Escribiendo:`, termino);
        
        // Limpiar timeout anterior
        clearTimeout(timeoutsBusqueda[numeroProducto]);
        
        if (termino.length < 2) {
            ocultarDropdownProducto(numeroProducto);
            if (termino.length === 0) {
                limpiarSeleccionProducto(numeroProducto);
            }
            return;
        }
        
        // Buscar con debounce
        timeoutsBusqueda[numeroProducto] = setTimeout(() => {
            buscarProductoEspecifico(numeroProducto, termino);
        }, 300);
    };
}

// Crear handler específico para teclas de cada producto
function crearTeclasHandler(numeroProducto) {
    return function(e) {
        const dropdown = document.getElementById(`dropdown_productos_${numeroProducto}`);
        if (!dropdown || dropdown.style.display === 'none') return;
        
        const items = dropdown.querySelectorAll('.producto-search-item');
        
        switch(e.key) {
            case 'ArrowDown':
                e.preventDefault();
                // Lógica de navegación
                break;
            case 'ArrowUp':
                e.preventDefault();
                // Lógica de navegación
                break;
            case 'Enter':
                e.preventDefault();
                // Seleccionar item activo
                break;
            case 'Escape':
                e.preventDefault();
                ocultarDropdownProducto(numeroProducto);
                break;
        }
    };
}

// Buscar productos para un número específico de producto
function buscarProductoEspecifico(numeroProducto, termino) {
    const dropdown = document.getElementById(`dropdown_productos_${numeroProducto}`);
    
    dropdown.innerHTML = `
        <div class="loading-spinner">
            <i class="fas fa-spinner fa-spin"></i> Buscando productos...
        </div>
    `;
    dropdown.style.display = 'block';
    
    console.log(`🔍 Buscando para producto ${numeroProducto}: "${termino}"`);
    
    // Obtener productos ya seleccionados para excluirlos
    const productosExcluir = [];
    for (let i = 1; i <= 3; i++) {
        if (i !== numeroProducto && productosSeleccionados[i]) {
            productosExcluir.push(productosSeleccionados[i].id);
        }
    }
    
    const params = new URLSearchParams({
        buscar: termino,
        solo_combos: 'false',
        excluir: productosExcluir.join(',')
    });
    
    fetch(`/buscar_productos_admin?${params.toString()}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const productos = data.productos.filter(p => p.activo && !p.es_combo);
                mostrarResultadosProducto(numeroProducto, productos, termino);
            } else {
                mostrarErrorProducto(numeroProducto, 'Error: ' + (data.error || 'Error desconocido'));
            }
        })
        .catch(error => {
            console.error(`❌ Error en búsqueda producto ${numeroProducto}:`, error);
            mostrarErrorProducto(numeroProducto, 'Error de conexión');
        });
}

// Mostrar resultados para un producto específico
function mostrarResultadosProducto(numeroProducto, productos, termino) {
    const dropdown = document.getElementById(`dropdown_productos_${numeroProducto}`);
    
    if (productos.length === 0) {
        dropdown.innerHTML = `
            <div class="no-results">
                <i class="fas fa-search"></i> No se encontraron productos para "${termino}"
            </div>
        `;
        return;
    }
    
    console.log(`📦 Producto ${numeroProducto} - Mostrando ${productos.length} productos`);
    
    const html = productos.map((producto) => {
        const codigoResaltado = resaltarTexto(producto.codigo, termino);
        const nombreResaltado = resaltarTexto(producto.nombre, termino);
        
        return `
            <div class="producto-search-item" 
                 onclick="seleccionarProductoEspecifico(${numeroProducto}, ${producto.id}, '${producto.codigo}', '${escapeHtml(producto.nombre)}', ${producto.precio}, ${producto.iva || 21})">
                <div class="producto-codigo">${codigoResaltado}</div>
                <div class="producto-nombre">${nombreResaltado}</div>
                <div class="producto-precio">$${producto.precio.toFixed(2)}</div>
            </div>
        `;
    }).join('');
    
    dropdown.innerHTML = html;
}

// Seleccionar un producto específico
function seleccionarProductoEspecifico(numeroProducto, id, codigo, nombre, precio, iva = 21) {
    console.log(`✅ Producto ${numeroProducto} seleccionado: ${codigo} - ${nombre} ($${precio}) IVA: ${iva}%`);
    
    // Guardar información del producto incluyendo IVA
    productosSeleccionados[numeroProducto] = { id, codigo, nombre, precio, iva };
    
    // Actualizar interfaz
    document.getElementById(`buscar_producto_${numeroProducto}`).value = `${codigo} - ${nombre}`;
    document.getElementById(`producto_base_${numeroProducto}`).value = id;
    
    // Agregar clase visual
    const input = document.getElementById(`buscar_producto_${numeroProducto}`);
    input.classList.add('producto-seleccionado');
    
    // Ocultar dropdown
    ocultarDropdownProducto(numeroProducto);
    
    // Actualizar información del producto
    actualizarInfoProductoEspecifico(numeroProducto, id, codigo, nombre, precio);
    
    // Recalcular precio combo
    calcularPrecioComboMulti();
}

// Actualizar información de un producto específico
function actualizarInfoProductoEspecifico(numeroProducto, id, codigo, nombre, precio) {
    const infoDiv = document.getElementById(`info_producto_${numeroProducto}`);
    
    infoDiv.innerHTML = `
        <div class="row">
            <div class="col-md-4"><strong>Código:</strong> ${codigo}</div>
            <div class="col-md-4"><strong>Producto:</strong> ${nombre}</div>
            <div class="col-md-4"><strong>Precio unit:</strong> $${precio.toFixed(2)}</div>
        </div>
    `;
    infoDiv.style.display = 'block';
}

// Ocultar dropdown de un producto específico
function ocultarDropdownProducto(numeroProducto) {
    const dropdown = document.getElementById(`dropdown_productos_${numeroProducto}`);
    if (dropdown) {
        dropdown.style.display = 'none';
    }
}

// Mostrar error para un producto específico
function mostrarErrorProducto(numeroProducto, mensaje) {
    const dropdown = document.getElementById(`dropdown_productos_${numeroProducto}`);
    dropdown.innerHTML = `
        <div class="no-results text-danger">
            <i class="fas fa-exclamation-triangle"></i> ${mensaje}
        </div>
    `;
}

// Limpiar selección de un producto específico
function limpiarSeleccionProducto(numeroProducto) {
    productosSeleccionados[numeroProducto] = null;
    
    document.getElementById(`producto_base_${numeroProducto}`).value = '';
    document.getElementById(`cantidad_${numeroProducto}`).value = '';
    
    const input = document.getElementById(`buscar_producto_${numeroProducto}`);
    if (input) {
        input.value = '';
        input.classList.remove('producto-seleccionado');
    }
    
    const infoDiv = document.getElementById(`info_producto_${numeroProducto}`);
    if (infoDiv) {
        infoDiv.style.display = 'none';
    }
    
    calcularPrecioComboMulti();
}

// Función para limpiar un producto completo (llamada desde el botón)
function limpiarProducto(numeroProducto) {
    console.log(`🧹 Limpiando producto ${numeroProducto}`);
    limpiarSeleccionProducto(numeroProducto);
    ocultarDropdownProducto(numeroProducto);
}

// Calcular precio total del combo multi-producto
function calcularPrecioComboMulti() {
    console.log('💰 Calculando precio combo multi-producto...');
    
    let precioTotal = 0;
    let productosEnCombo = [];
    let hayProductos = false;
    
    // Calcular precio para cada producto
    for (let i = 1; i <= 3; i++) {
        const producto = productosSeleccionados[i];
        const cantidad = parseFloat(document.getElementById(`cantidad_${i}`).value) || 0;
        
        if (producto && cantidad > 0) {
            const subtotal = producto.precio * cantidad;
            precioTotal += subtotal;
            
            productosEnCombo.push({
                numero: i,
                producto: producto,
                cantidad: cantidad,
                subtotal: subtotal
            });
            
            hayProductos = true;
        }
    }
    
    console.log(`   Precio total calculado: $${precioTotal}`);
    console.log(`   Productos en combo: ${productosEnCombo.length}`);
    
    // Actualizar campo precio normal
    if (hayProductos) {
        document.getElementById('precio_normal_combo').value = formatearPrecio(precioTotal);
        mostrarResumenCombo(productosEnCombo, precioTotal);
        generarCodigoNombreMulti(productosEnCombo);
    } else {
        document.getElementById('precio_normal_combo').value = '';
        ocultarResumenCombo();
    }
    
    calcularDescuentoMulti();
}

// Mostrar resumen del combo
function mostrarResumenCombo(productosEnCombo, precioTotal) {
    const resumenDiv = document.getElementById('resumen_combo');
    const contenidoDiv = document.getElementById('contenido_resumen');
    
    let html = '<div class="row">';
    
    productosEnCombo.forEach((item, index) => {
        html += `
            <div class="col-md-4 mb-2">
                <div class="border p-2 rounded">
                    <strong>${item.producto.codigo}</strong><br>
                    <small>${item.producto.nombre}</small><br>
                    <span class="text-primary">${item.cantidad}x $${item.producto.precio.toFixed(2)} = $${item.subtotal.toFixed(2)}</span>
                </div>
            </div>
        `;
    });
    
    html += '</div>';
    html += `<div class="row mt-2">
                <div class="col-md-12 text-end">
                    <h5>Total Normal: <span class="text-success">$${formatearPrecio(precioTotal)}</span></h5>
                </div>
             </div>`;
    
    contenidoDiv.innerHTML = html;
    resumenDiv.style.display = 'block';
}

// Ocultar resumen del combo
function ocultarResumenCombo() {
    const resumenDiv = document.getElementById('resumen_combo');
    resumenDiv.style.display = 'none';
}

// Generar código y nombre automático para multi-producto
function generarCodigoNombreMulti(productosEnCombo) {
    if (productosEnCombo.length === 0) return;
    
    console.log('🏷️ Generando código y nombre automático multi-producto...');
    
    // Generar código (ej: ARR001-ACE002-AZU003-COMBO)
    const codigosBase = productosEnCombo.map(item => item.producto.codigo).join('-');
    const codigoCombo = `${codigosBase}-COMBO`;
    
    // Generar nombre (ej: "Pack: Arroz + Aceite + Azúcar (Oferta)")
    const nombresBase = productosEnCombo.map(item => {
        const cantidadFormat = item.cantidad % 1 === 0 ? 
            item.cantidad.toString() : 
            item.cantidad.toFixed(3).replace(/\.?0+$/, '');
        return `${cantidadFormat}x ${item.producto.nombre}`;
    }).join(' + ');
    
    const nombreCombo = `Pack: ${nombresBase} (Oferta)`;
    
    // Aplicar solo si los campos están vacíos
    const campoCodigo = document.getElementById('codigo_combo');
    const campoNombre = document.getElementById('nombre_combo');
    
    if (!campoCodigo.value.trim()) {
        campoCodigo.value = codigoCombo;
        console.log(`   ✅ Código generado: ${codigoCombo}`);
    }
    
    if (!campoNombre.value.trim()) {
        campoNombre.value = nombreCombo;
        console.log(`   ✅ Nombre generado: ${nombreCombo}`);
    }
}

// Calcular descuento para multi-producto
function calcularDescuentoMulti() {
    const precioNormalTexto = document.getElementById('precio_normal_combo').value;
    const precioOferta = parseFloat(document.getElementById('precio_combo').value);
    const infoDiv = document.getElementById('info_descuento');
    
    const precioNormal = limpiarFormatoPrecio(precioNormalTexto);
    
    if (!precioNormal || !precioOferta || precioOferta <= 0) {
        document.getElementById('descuento_combo').value = '';
        infoDiv.style.display = 'none';
        return;
    }
    
    if (precioOferta >= precioNormal) {
        document.getElementById('descuento_combo').value = '0.00';
        infoDiv.innerHTML = '<i class="fas fa-exclamation-triangle"></i> <strong>¡Atención!</strong> El precio de oferta es igual o mayor al precio normal.';
        infoDiv.className = 'alert alert-warning';
        infoDiv.style.display = 'block';
        return;
    }
    
    const descuento = ((precioNormal - precioOferta) / precioNormal) * 100;
    const ahorro = precioNormal - precioOferta;
    
    document.getElementById('descuento_combo').value = descuento.toFixed(2);
    
    infoDiv.innerHTML = `
        <i class="fas fa-check-circle"></i> <strong>¡Excelente oferta multi-producto!</strong><br>
        <div class="row mt-2">
            <div class="col-md-4"><strong>Precio normal:</strong> $${formatearPrecio(precioNormal)}</div>
            <div class="col-md-4"><strong>Precio oferta:</strong> $${formatearPrecio(precioOferta)}</div>
            <div class="col-md-4"><strong>Ahorro:</strong> $${formatearPrecio(ahorro)} (${descuento.toFixed(1)}%)</div>
        </div>
    `;
    infoDiv.className = 'alert alert-success';
    infoDiv.style.display = 'block';
}

// Crear combo multi-producto
function crearComboMulti() {
    console.log('🚀 Creando combo multi-producto...');
    const form = document.getElementById('formCrearCombo');
    
    if (!form.checkValidity()) {
        form.reportValidity();
        return;
    }
    
    // Validar que al menos el producto 1 esté seleccionado
    if (!productosSeleccionados[1] || !document.getElementById('cantidad_1').value) {
        alert('❌ El Producto 1 es obligatorio para crear el combo');
        return;
    }
    
    const comboId = document.getElementById('combo_id_edit').value;
    const esEdicion = !!comboId;
    
    const datos = {
        // Producto 1 (obligatorio)
        producto_base_id: parseInt(document.getElementById('producto_base_1').value),
        cantidad_combo: parseFloat(document.getElementById('cantidad_1').value),
        
        // Producto 2 (opcional)
        producto_base_2_id: document.getElementById('producto_base_2').value ? 
            parseInt(document.getElementById('producto_base_2').value) : null,
        cantidad_combo_2: document.getElementById('cantidad_2').value ? 
            parseFloat(document.getElementById('cantidad_2').value) : 0,
        
        // Producto 3 (opcional)
        producto_base_3_id: document.getElementById('producto_base_3').value ? 
            parseInt(document.getElementById('producto_base_3').value) : null,
        cantidad_combo_3: document.getElementById('cantidad_3').value ? 
            parseFloat(document.getElementById('cantidad_3').value) : 0,
        
        // Información general
        precio_combo: limpiarFormatoPrecio(document.getElementById('precio_combo').value),
        codigo_combo: document.getElementById('codigo_combo').value.trim(),
        nombre_combo: document.getElementById('nombre_combo').value.trim(),
        descripcion_combo: document.getElementById('descripcion_combo').value.trim(),

        // IVA del producto principal (el más relevante)
        iva: productosSeleccionados[1]?.iva || 21
    };
    
    if (esEdicion) {
        datos.id = parseInt(comboId);
    }
    
    // Validaciones adicionales
    if (datos.cantidad_combo <= 0) {
        alert('❌ La cantidad del Producto 1 debe ser mayor a 0');
        return;
    }
    
    if (datos.precio_combo <= 0) {
        alert('❌ El precio de oferta debe ser mayor a 0');
        return;
    }
    
    console.log('📤 Enviando datos:', datos);
    
    const btnCrear = document.querySelector('#modalCrearCombo .btn-warning');
    const textoOriginal = btnCrear.innerHTML;
    btnCrear.innerHTML = `<i class="fas fa-spinner fa-spin"></i> ${esEdicion ? 'Actualizando' : 'Creando'}...`;
    btnCrear.disabled = true;
    
    // Usar el mismo endpoint que antes
    fetch('/api/crear_combo', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(datos)
    })
    .then(response => response.json())
    .then(result => {
        console.log('📥 Respuesta del servidor:', result);
        
        if (result.success) {
            alert(`✅ Combo multi-producto ${esEdicion ? 'actualizado' : 'creado'} exitosamente: ${datos.codigo_combo}`);
            
            const modal = bootstrap.Modal.getInstance(document.getElementById('modalCrearCombo'));
            modal.hide();
            
            window.location.reload();
        } else {
            alert(`❌ Error al ${esEdicion ? 'actualizar' : 'crear'} combo: ${result.error}`);
        }
    })
    .catch(error => {
        console.error('❌ Error:', error);
        alert(`❌ Error de conexión al ${esEdicion ? 'actualizar' : 'crear'} el combo`);
    })
    .finally(() => {
        btnCrear.innerHTML = textoOriginal;
        btnCrear.disabled = false;
    });
}

// Mostrar modal crear combo multi-producto (versión actualizada)
function mostrarModalCrearCombo() {
    console.log('🎯 Abriendo modal crear combo multi-producto...');
    
    // Limpiar estado
    productosSeleccionados = { 1: null, 2: null, 3: null };
    
    document.getElementById('formCrearCombo').reset();
    document.getElementById('combo_id_edit').value = '';
    
    // Limpiar todas las selecciones
    for (let i = 1; i <= 3; i++) {
        limpiarSeleccionProducto(i);
    }
    
    ocultarResumenCombo();
    
    // Resetear título
    document.getElementById('tituloModalCombo').innerHTML = '<i class="fas fa-tags"></i> Crear Nueva Oferta/Combo';
    document.getElementById('btnComboTexto').textContent = 'Crear Oferta';
    
    const modal = new bootstrap.Modal(document.getElementById('modalCrearCombo'));
    modal.show();
    
    // Inicializar búsqueda después de que el modal esté visible
    modal._element.addEventListener('shown.bs.modal', function() {
        inicializarBusquedaMultiProducto();
    }, { once: true });
    
    console.log('✅ Modal combo multi-producto abierto');
}



</script>
{% endblock %}