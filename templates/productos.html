<!-- templates/productos.html -->
{% extends "base.html" %}

{% block title %}Productos - POS Argentina{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2"><i class="fas fa-box"></i> Gesti칩n de Productos</h1>
    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modalProducto" onclick="limpiarFormProducto()">
        <i class="fas fa-plus"></i> Nuevo Producto
    </button>
</div>

<!-- Filtros -->
<div class="card mb-3">
    <div class="card-body">
        <div class="row">
            <div class="col-md-3">
                <label class="form-label">Buscar productos</label>
                <input type="text" class="form-control" id="buscarProducto" placeholder="C칩digo o nombre...">
            </div>
            <div class="col-md-2">
                <label class="form-label">Categor칤a</label>
                <select class="form-select" id="filtroCategoria">
                    <option value="">Todas las categor칤as</option>
                </select>
            </div>
            <div class="col-md-2">
                <label class="form-label">Stock</label>
                <select class="form-select" id="filtroStock">
                    <option value="">Todo el stock</option>
                    <option value="bajo">Stock bajo (< 10)</option>
                    <option value="sin_stock">Sin stock</option>
                </select>
            </div>
            <!-- NUEVO FILTRO DE ESTADO -->
            <div class="col-md-2">
                <label class="form-label">Estado</label>
                <select class="form-select" id="filtroEstado">
                    <option value="">Todos los estados</option>
                    <option value="activo" selected>Solo activos</option>
                    <option value="inactivo">Solo inactivos</option>
                </select>
            </div>
            <div class="col-md-2">
                <label class="form-label">&nbsp;</label>
                <div class="d-grid gap-2">
                    <button class="btn btn-primary" onclick="aplicarFiltrosProductos()">
                        <i class="fas fa-search"></i> Buscar
                    </button>
                </div>
            </div>
            <div class="col-md-2">
                <label class="form-label">&nbsp;</label>
                <div class="d-grid gap-2">
                    <button class="btn btn-secondary" onclick="limpiarFiltros()">
                        <i class="fas fa-eraser"></i> Limpiar
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Lista de productos -->
<div class="card">
    <div class="card-header">
        <h5><i class="fas fa-list"></i> Listado de Productos</h5>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-striped table-hover" id="tablaProductos">
                <thead class="table-dark">
                    <tr>
                        <th>C칩digo</th>
                        <th>Nombre</th>
                        <th>Categor칤a</th>
                        <th>Costo</th>
                        <th>Margen %</th>
                        <th>Precio Venta</th>
                        <th>Stock</th>
                        <th>IVA %</th>
                        <th>Estado</th>
                        <th><i class="fas fa-bolt" title="Acceso R치pido"></i></th> <!-- Nueva columna -->
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    {% for producto in productos %}
                    <tr>
                        <td><code>{{ producto.codigo }}</code></td>
                        <td>
                            <strong>{{ producto.nombre }}</strong>
                            {% if producto.es_combo %}
                                <br><span class="badge bg-warning text-dark">OFERTA</span>
                            {% endif %}
                            {% if producto.descripcion %}
                                <br><small class="text-muted">{{ producto.descripcion[:50] }}{% if producto.descripcion|length > 50 %}...{% endif %}</small>
                            {% endif %}
                        </td>
                        <td>
                            <span class="badge bg-info">{{ producto.categoria or 'Sin categor칤a' }}</span>
                        </td>
                        <td class="text-end">
                            <small class="text-muted">$</small><strong>{{ "%.2f"|format(producto.costo or 0) }}</strong>
                        </td>
                        <td class="text-center">
                            <span class="badge bg-warning text-dark">{{ "%.1f"|format(producto.margen or 0) }}%</span>
                        </td>
                        <td class="text-end">
                            <strong>${{ "%.2f"|format(producto.precio) }}</strong>
                            {% if producto.es_combo and producto.producto_base %}
                                {% set precio_normal = producto.producto_base.precio * producto.cantidad_combo %}
                                {% set descuento = ((precio_normal - producto.precio) / precio_normal * 100) %}
                                <br><small class="text-danger">-{{ "%.1f"|format(descuento) }}%</small>
                            {% endif %}
                        </td>
                        <td class="text-center">
                            {% if producto.stock <= 0 %}
                                <span class="badge bg-danger">{{ producto.stock }}</span>
                            {% elif producto.stock < 10 %}
                                <span class="badge bg-warning text-dark">{{ producto.stock }}</span>
                            {% else %}
                                <span class="badge bg-success">{{ producto.stock }}</span>
                            {% endif %}
                        </td>
                        <td class="text-center">{{ "%g"|format(producto.iva) }}%</td>
                        <td>
                            {% if producto.activo %}
                                <span class="badge bg-success">Activo</span>
                            {% else %}
                                <span class="badge bg-secondary">Inactivo</span>
                            {% endif %}
                        </td>
                        <!-- Nueva columna de Acceso R치pido -->
                        <!-- Nueva columna de Acceso R치pido CORREGIDA -->
                        <td class="text-center">
                            {% if hasattr(producto, 'acceso_rapido') and producto.acceso_rapido %}
                                <div class="text-center">
                                    <span class="badge bg-warning text-dark mb-1" title="Producto en acceso r치pido (posici칩n {{ producto.orden_acceso_rapido or 0 }})">
                                        <i class="fas fa-bolt"></i> #{{ producto.orden_acceso_rapido or 0 }}
                                    </span>
                                    <br>
                                    <button class="btn btn-outline-danger btn-sm" onclick="toggleAccesoRapidoDirecto({{ producto.id }})" title="Quitar de acceso r치pido">
                                        <i class="fas fa-minus"></i>
                                    </button>
                                </div>
                            {% else %}
                                <button class="btn btn-outline-warning btn-sm" onclick="toggleAccesoRapidoDirecto({{ producto.id }})" title="Agregar a acceso r치pido">
                                    <i class="fas fa-plus"></i>
                                </button>
                            {% endif %}
                        </td>
                        <td>
                            <div class="btn-group btn-group-sm">
                                {% if producto.es_combo %}
                                    <button class="btn btn-warning" onclick="editarCombo({{ producto.id }})" title="Editar Combo">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                {% else %}
                                    <button class="btn btn-warning" onclick="editarProducto({{ producto.id }})" title="Editar">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                {% endif %}
                                <button class="btn btn-info" onclick="ajustarStock({{ producto.id }})" title="Ajustar Stock">
                                    <i class="fas fa-boxes"></i>
                                </button>
                                <button class="btn btn-{% if producto.activo %}danger{% else %}success{% endif %}" onclick="toggleProducto({{ producto.id }})" title="{% if producto.activo %}Desactivar{% else %}Activar{% endif %}">
                                    <i class="fas fa-power-off"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>


<!-- Modal Producto - MODIFICADO PARA 5 LISTAS DE PRECIOS -->
<div class="modal fade" id="modalProducto" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="tituloModal">
                    <i class="fas fa-plus"></i> Nuevo Producto
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="formProducto">
                    <input type="hidden" id="productoId">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="codigo" class="form-label">C칩digo *</label>
                                <input type="text" class="form-control" id="codigo" required>
                                <div class="form-text">C칩digo 칰nico del producto</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="categoria" class="form-label">Categor칤a</label>
                                <input type="text" class="form-control" id="categoria" list="categorias">
                                <datalist id="categorias">
                                    <!-- Se cargar치n din치micamente -->
                                </datalist>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="nombre" class="form-label">Nombre *</label>
                        <input type="text" class="form-control" id="nombre" required>
                    </div>
                    <div class="mb-3">
                        <label for="descripcion" class="form-label">Descripci칩n</label>
                        <textarea class="form-control" id="descripcion" rows="2"></textarea>
                    </div>
                    
                    <!-- ========== COSTOS Y 5 LISTAS DE PRECIOS ========== -->
                    <div class="card mb-3 bg-light">
                        <div class="card-header bg-info text-white">
                            <h6 class="mb-0"><i class="fas fa-calculator"></i> Costos y Listas de Precios</h6>
                        </div>
                        <div class="card-body">
                            <!-- Precio de Costo -->
                            <div class="row mb-3">
                                <div class="col-md-4">
                                    <label for="costo" class="form-label fw-bold">Precio de Costo *</label>
                                    <div class="input-group">
                                        <span class="input-group-text">$</span>
                                        <input type="number" class="form-control form-control-lg" id="costo" step="0.01" min="0.01" required>
                                    </div>
                                    <small class="form-text text-muted">Costo sin IVA - Base para calcular todos los precios</small>
                                </div>
                            </div>
                            
                            <hr>
                            
                            <!-- LISTAS DE PRECIOS -->
                            <h6 class="text-primary mb-3"><i class="fas fa-tags"></i> Listas de Precios (Margen sobre costo)</h6>
                            
                            <div class="row">
                                <!-- Lista 1 - Mostrador -->
                                <div class="col-md-4 col-lg mb-3">
                                    <div class="card h-100 border-primary">
                                        <div class="card-header bg-primary text-white py-2">
                                            <small class="fw-bold"><i class="fas fa-user"></i> Lista 1 - Mostrador</small>
                                        </div>
                                        <div class="card-body p-2">
                                            <div class="mb-2">
                                                <label class="form-label small mb-1">Margen %</label>
                                                <div class="input-group input-group-sm">
                                                    <input type="number" class="form-control" id="margen" step="0.01" min="0" value="30">
                                                    <span class="input-group-text">%</span>
                                                </div>
                                            </div>
                                            <div>
                                                <label class="form-label small mb-1">Precio</label>
                                                <div class="input-group input-group-sm">
                                                    <span class="input-group-text">$</span>
                                                    <input type="number" class="form-control bg-warning" id="precio" step="0.01" readonly>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Lista 2 - Mayorista -->
                                <div class="col-md-4 col-lg mb-3">
                                    <div class="card h-100 border-success">
                                        <div class="card-header bg-success text-white py-2">
                                            <small class="fw-bold"><i class="fas fa-store"></i> Lista 2 - Mayorista</small>
                                        </div>
                                        <div class="card-body p-2">
                                            <div class="mb-2">
                                                <label class="form-label small mb-1">Margen %</label>
                                                <div class="input-group input-group-sm">
                                                    <input type="number" class="form-control" id="margen2" step="0.01" min="0" placeholder="Opcional">
                                                    <span class="input-group-text">%</span>
                                                </div>
                                            </div>
                                            <div>
                                                <label class="form-label small mb-1">Precio</label>
                                                <div class="input-group input-group-sm">
                                                    <span class="input-group-text">$</span>
                                                    <input type="number" class="form-control bg-light" id="precio2" step="0.01" readonly>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Lista 3 - Distribuidor -->
                                <div class="col-md-4 col-lg mb-3">
                                    <div class="card h-100 border-info">
                                        <div class="card-header bg-info text-white py-2">
                                            <small class="fw-bold"><i class="fas fa-truck"></i> Lista 3 - Distribuidor</small>
                                        </div>
                                        <div class="card-body p-2">
                                            <div class="mb-2">
                                                <label class="form-label small mb-1">Margen %</label>
                                                <div class="input-group input-group-sm">
                                                    <input type="number" class="form-control" id="margen3" step="0.01" min="0" placeholder="Opcional">
                                                    <span class="input-group-text">%</span>
                                                </div>
                                            </div>
                                            <div>
                                                <label class="form-label small mb-1">Precio</label>
                                                <div class="input-group input-group-sm">
                                                    <span class="input-group-text">$</span>
                                                    <input type="number" class="form-control bg-light" id="precio3" step="0.01" readonly>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Lista 4 - Especial -->
                                <div class="col-md-6 col-lg mb-3">
                                    <div class="card h-100 border-warning">
                                        <div class="card-header bg-warning text-dark py-2">
                                            <small class="fw-bold"><i class="fas fa-star"></i> Lista 4 - Especial</small>
                                        </div>
                                        <div class="card-body p-2">
                                            <div class="mb-2">
                                                <label class="form-label small mb-1">Margen %</label>
                                                <div class="input-group input-group-sm">
                                                    <input type="number" class="form-control" id="margen4" step="0.01" min="0" placeholder="Opcional">
                                                    <span class="input-group-text">%</span>
                                                </div>
                                            </div>
                                            <div>
                                                <label class="form-label small mb-1">Precio</label>
                                                <div class="input-group input-group-sm">
                                                    <span class="input-group-text">$</span>
                                                    <input type="number" class="form-control bg-light" id="precio4" step="0.01" readonly>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Lista 5 - Promocional -->
                                <div class="col-md-6 col-lg mb-3">
                                    <div class="card h-100 border-danger">
                                        <div class="card-header bg-danger text-white py-2">
                                            <small class="fw-bold"><i class="fas fa-percentage"></i> Lista 5 - Promocional</small>
                                        </div>
                                        <div class="card-body p-2">
                                            <div class="mb-2">
                                                <label class="form-label small mb-1">Margen %</label>
                                                <div class="input-group input-group-sm">
                                                    <input type="number" class="form-control" id="margen5" step="0.01" min="0" placeholder="Opcional">
                                                    <span class="input-group-text">%</span>
                                                </div>
                                            </div>
                                            <div>
                                                <label class="form-label small mb-1">Precio</label>
                                                <div class="input-group input-group-sm">
                                                    <span class="input-group-text">$</span>
                                                    <input type="number" class="form-control bg-light" id="precio5" step="0.01" readonly>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Indicador visual -->
                            <div class="alert alert-info mb-0 mt-2">
                                <i class="fas fa-info-circle"></i> 
                                <strong>C치lculo:</strong> Precio = Costo 칑 (1 + Margen/100)
                                <br>
                                <small id="formulaEjemplo">Las listas opcionales que no completes usar치n el precio de Lista 1</small>
                            </div>
                        </div>
                    </div>
                    <!-- ========== FIN LISTAS DE PRECIOS ========== -->
                    
                    <div class="row">
                        <div class="col-md-4" id="stockInicialContainer">
                            <div class="mb-3">
                                <label for="stock" class="form-label">Stock Inicial</label>
                                <input type="number" class="form-control" id="stock" value="0" min="0">
                                <small class="form-text text-muted">Solo para productos nuevos</small>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="iva" class="form-label">IVA %</label>
                                <select class="form-select" id="iva">
                                    <option value="0">0% (Exento)</option>
                                    <option value="10.5">10.5%</option>
                                    <option value="21" selected>21%</option>
                                    <option value="27">27%</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-check mt-4">
                                <input class="form-check-input" type="checkbox" id="activo" checked>
                                <label class="form-check-label" for="activo">
                                    Producto activo
                                </label>
                            </div>
                            <div class="form-check mt-2">
                                <input class="form-check-input" type="checkbox" id="esPesable">
                                <label class="form-check-label" for="esPesable">
                                    <i class="fas fa-weight"></i> Producto pesable (por KG)
                                </label>
                                <div class="form-text">Marcar si se vende por peso</div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times"></i> Cancelar
                </button>
                <button type="button" class="btn btn-primary" onclick="guardarProducto()">
                    <i class="fas fa-save"></i> Guardar
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Ajustar Stock -->
<div class="modal fade" id="modalStock" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title">
                    <i class="fas fa-boxes"></i> Ajustar Stock
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="infoProductoStock"></div>
                <form id="formStock">
                    <input type="hidden" id="stockProductoId">
                    <div class="mb-3">
                        <label for="tipoMovimiento" class="form-label">Tipo de movimiento</label>
                        <select class="form-select" id="tipoMovimiento">
                            <option value="entrada">Entrada (Agregar stock)</option>
                            <option value="salida">Salida (Quitar stock)</option>
                            <option value="ajuste">Ajuste (Establecer cantidad exacta)</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="cantidadStock" class="form-label">Cantidad</label>
                        <input type="number" class="form-control" id="cantidadStock" min="0" step="0.001" required>
                        <div class="form-text" id="ayudaCantidad">Ingrese la cantidad a agregar (puede usar decimales: ej. 10.300)</div>
                    </div>
                    <div class="mb-3">
                        <label for="motivo" class="form-label">Motivo</label>
                        <input type="text" class="form-control" id="motivo" placeholder="Ej: Compra, Inventario, etc.">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-info" onclick="guardarStock()">
                    <i class="fas fa-save"></i> Aplicar Cambio
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
// Variables globales
let productoActual = null;
let stockActual = 0;
let productosBase = [];

// ===== FUNCIONES PARA PRODUCTOS =====

// Variables para controlar el comportamiento del c치lculo
let modoEdicion = false;
let calculoManual = false;

// ========== FUNCI칍N CALCULAR PRECIO - MODIFICADA PARA 5 LISTAS ==========
function calcularPrecio() {
    const costo = parseFloat(document.getElementById('costo').value) || 0;
    
    // Calcular precio Lista 1 (principal)
    const margen1 = parseFloat(document.getElementById('margen').value) || 0;
    const precio1 = costo * (1 + (margen1 / 100));
    document.getElementById('precio').value = precio1.toFixed(2);
    
    // Calcular precios Listas 2-5 (solo si tienen margen definido)
    for (let i = 2; i <= 5; i++) {
        const margenInput = document.getElementById(`margen${i}`);
        const precioInput = document.getElementById(`precio${i}`);
        
        if (margenInput && precioInput) {
            const margenValor = parseFloat(margenInput.value);
            if (!isNaN(margenValor) && margenValor >= 0 && margenInput.value !== '') {
                const precioCalculado = costo * (1 + (margenValor / 100));
                precioInput.value = precioCalculado.toFixed(2);
            } else {
                precioInput.value = ''; // Limpiar si no hay margen
            }
        }
    }
    
    // Actualizar ejemplo visual
    const formulaEjemplo = document.getElementById('formulaEjemplo');
    if (formulaEjemplo && costo > 0) {
        formulaEjemplo.innerHTML = `
            <strong>Lista 1:</strong> $${costo.toFixed(2)} 칑 (1 + ${margen1}%/100) = <span class="text-primary fw-bold">$${precio1.toFixed(2)}</span>
        `;
    }
    
    console.log(`游늵 Precios calculados - Costo: $${costo.toFixed(2)}, Lista1: $${precio1.toFixed(2)}`);
    
    // Resetear flag de c치lculo manual
    calculoManual = false;
}


// Funci칩n para calcular margen basado en precio
function calcularMargen() {
    const costo = parseFloat(document.getElementById('costo').value) || 0;
    const precio = parseFloat(document.getElementById('precio').value) || 0;
    
    if (costo > 0 && precio > 0) {
        const margen = ((precio / costo) - 1) * 100;
        document.getElementById('margen').value = margen.toFixed(2);
        
        // Actualizar ejemplo visual
        const formulaEjemplo = document.getElementById('formulaEjemplo');
        if (formulaEjemplo) {
            formulaEjemplo.textContent = `Margen calculado: (($${precio.toFixed(2)} / $${costo.toFixed(2)}) - 1) 칑 100 = ${margen.toFixed(2)}%`;
        }
        
        console.log(`游늳 Margen recalculado: Costo=$${costo.toFixed(2)}, Precio=$${precio.toFixed(2)}, Margen=${margen.toFixed(2)}%`);
    }
}

// ========== FUNCI칍N LIMPIAR FORM - MODIFICADA PARA 5 LISTAS ==========
function limpiarFormProducto() {
    modoEdicion = false;
    calculoManual = false;
    
    document.getElementById('formProducto').reset();
    document.getElementById('productoId').value = '';
    document.getElementById('tituloModal').innerHTML = '<i class="fas fa-plus"></i> Nuevo Producto';
    document.getElementById('stock').value = '0';
    document.getElementById('iva').value = '21';
    document.getElementById('activo').checked = true;
    document.getElementById('esPesable').checked = false;
    
    // Valores por defecto para costo y margen Lista 1
    document.getElementById('costo').value = '';
    document.getElementById('margen').value = '30';
    document.getElementById('precio').value = '0.00';
    
    // Limpiar m치rgenes y precios adicionales (Listas 2-5)
    for (let i = 2; i <= 5; i++) {
        const margenInput = document.getElementById(`margen${i}`);
        const precioInput = document.getElementById(`precio${i}`);
        if (margenInput) margenInput.value = '';
        if (precioInput) precioInput.value = '';
    }
    
    productoActual = null;
    
    // Mostrar campo de stock inicial solo para productos nuevos
    document.getElementById('stockInicialContainer').style.display = 'block';
    
    // Limpiar validaciones
    const inputs = document.querySelectorAll('#formProducto input, #formProducto select, #formProducto textarea');
    inputs.forEach(input => {
        input.setCustomValidity('');
        input.classList.remove('is-invalid', 'is-valid');
    });
    
    // Calcular precio inicial
    calcularPrecio();
}

// ========== FUNCI칍N CARGAR PRODUCTO - MODIFICADA PARA 5 LISTAS ==========
function cargarProductoEnFormulario(producto) {
    modoEdicion = true;
    calculoManual = false;
    productoActual = producto;

    console.log('Producto completo:', producto);
    
    document.getElementById('productoId').value = producto.id;
    document.getElementById('codigo').value = producto.codigo;
    document.getElementById('nombre').value = producto.nombre;
    document.getElementById('descripcion').value = producto.descripcion || '';
    document.getElementById('categoria').value = producto.categoria || '';
    document.getElementById('iva').value = producto.iva;
    document.getElementById('activo').checked = producto.activo;
    document.getElementById('esPesable').checked = producto.es_pesable || false;
    
    // Cargar costo
    document.getElementById('costo').value = producto.costo || 0;
    
    // Cargar margen y precio Lista 1
    document.getElementById('margen').value = producto.margen || 30;
    document.getElementById('precio').value = producto.precio || 0;
    
    // Cargar m치rgenes y precios Listas 2-5
    for (let i = 2; i <= 5; i++) {
        const margenInput = document.getElementById(`margen${i}`);
        const precioInput = document.getElementById(`precio${i}`);
        
        if (margenInput && precioInput) {
            const margenKey = `margen${i}`;
            const precioKey = `precio${i}`;
            
            if (producto[margenKey] !== null && producto[margenKey] !== undefined) {
                margenInput.value = producto[margenKey];
                precioInput.value = producto[precioKey] || '';
            } else {
                margenInput.value = '';
                precioInput.value = '';
            }
        }
    }
    
    // Ocultar campo de stock inicial en edici칩n
    document.getElementById('stockInicialContainer').style.display = 'none';
    
    // Actualizar t칤tulo del modal
    document.getElementById('tituloModal').innerHTML = '<i class="fas fa-edit"></i> Editar Producto';
    
    console.log(`游닇 Producto cargado: ${producto.codigo} - ${producto.nombre}`);
}

// Funci칩n para editar producto
function editarProducto(id) {
    fetch(`/api/producto_detalle/${id}`)
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                alert('Error: ' + data.error);
                return;
            }
            
            cargarProductoEnFormulario(data);
            
            // Mostrar el modal
            const modal = new bootstrap.Modal(document.getElementById('modalProducto'));
            modal.show();
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error al cargar los datos del producto');
        });
}

// ========== FUNCI칍N GUARDAR PRODUCTO - MODIFICADA PARA 5 LISTAS ==========
function guardarProducto() {
    const form = document.getElementById('formProducto');
    
    // Validar formulario
    if (!form.checkValidity()) {
        form.reportValidity();
        return;
    }
    
    // Validaciones adicionales
    const costo = parseFloat(document.getElementById('costo').value);
    const margen = parseFloat(document.getElementById('margen').value);
    
    if (costo <= 0) {
        alert('El costo debe ser mayor a 0');
        document.getElementById('costo').focus();
        return;
    }
    
    if (margen < 0) {
        alert('El margen de Lista 1 no puede ser negativo');
        document.getElementById('margen').focus();
        return;
    }
    
    // Recalcular precios antes de enviar
    calcularPrecio();
    
    // Recopilar datos del formulario
    const formData = {
        id: document.getElementById('productoId').value || null,
        codigo: document.getElementById('codigo').value.trim().toUpperCase(),
        nombre: document.getElementById('nombre').value.trim(),
        descripcion: document.getElementById('descripcion').value.trim(),
        costo: costo,
        margen: margen,
        precio: parseFloat(document.getElementById('precio').value),
        categoria: document.getElementById('categoria').value.trim(),
        iva: parseFloat(document.getElementById('iva').value),
        activo: document.getElementById('activo').checked,
        es_pesable: document.getElementById('esPesable').checked
    };
    
    // Agregar m치rgenes de listas 2-5 (solo si tienen valor)
    for (let i = 2; i <= 5; i++) {
        const margenInput = document.getElementById(`margen${i}`);
        if (margenInput && margenInput.value !== '') {
            const margenValor = parseFloat(margenInput.value);
            if (!isNaN(margenValor) && margenValor >= 0) {
                formData[`margen${i}`] = margenValor;
            }
        }
    }
    
    // Solo incluir stock si es producto nuevo
    if (!formData.id) {
        formData.stock = parseInt(document.getElementById('stock').value) || 0;
    }
    
    // Validaciones adicionales
    if (!formData.codigo) {
        alert('El c칩digo es obligatorio');
        document.getElementById('codigo').focus();
        return;
    }
    
    if (!formData.nombre) {
        alert('El nombre es obligatorio');
        document.getElementById('nombre').focus();
        return;
    }
    
    // Mostrar indicador de carga
    const btnGuardar = document.querySelector('#modalProducto .btn-primary');
    const textoOriginal = btnGuardar.innerHTML;
    btnGuardar.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Guardando...';
    btnGuardar.disabled = true;
    
    console.log('游닋 Enviando datos:', formData);
    
    // Enviar datos al servidor
    fetch('/guardar_producto', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(formData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            
            // Cerrar modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('modalProducto'));
            modal.hide();
            
            // Recargar la p치gina para mostrar los cambios
            window.location.reload();
        } else {
            alert('Error: ' + (data.error || 'Error desconocido'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error de conexi칩n al guardar el producto');
    })
    .finally(() => {
        // Restaurar bot칩n
        btnGuardar.innerHTML = textoOriginal;
        btnGuardar.disabled = false;
    });
}

// Funci칩n para ajustar stock
function ajustarStock(id) {
    // Primero obtener informaci칩n del producto
    fetch(`/api/producto_detalle/${id}`)
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                alert('Error: ' + data.error);
                return;
            }
            
            stockActual = data.stock;
            
            document.getElementById('stockProductoId').value = id;
            document.getElementById('infoProductoStock').innerHTML = `
                <div class="alert alert-info">
                    <strong>Producto:</strong> ${data.codigo} - ${data.nombre}<br>
                    <strong>Stock actual:</strong> <span class="badge bg-primary">${data.stock} unidades</span>
                </div>
            `;
            
            // Limpiar formulario
            document.getElementById('formStock').reset();
            document.getElementById('tipoMovimiento').value = 'entrada';
            document.getElementById('cantidadStock').min = '1';
            document.getElementById('ayudaCantidad').textContent = 'Ingrese la cantidad a agregar';
            
            // Mostrar modal
            new bootstrap.Modal(document.getElementById('modalStock')).show();
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error al cargar informaci칩n del producto');
        });
}

// Funci칩n para guardar cambios de stock
function guardarStock() {
    const form = document.getElementById('formStock');
    
    if (!form.checkValidity()) {
        form.reportValidity();
        return;
    }
    
    const formData = {
        producto_id: document.getElementById('stockProductoId').value,
        tipo_movimiento: document.getElementById('tipoMovimiento').value,
        cantidad: parseFloat(document.getElementById('cantidadStock').value),
        motivo: document.getElementById('motivo').value.trim()
    };
    
    // Validaciones adicionales
    if (formData.cantidad <= 0 && formData.tipo_movimiento !== 'ajuste') {
        alert('La cantidad debe ser mayor a 0');
        return;
    }
    
    // Validar que la cantidad sea un n칰mero v치lido con m치ximo 3 decimales
    if (isNaN(formData.cantidad) || formData.cantidad < 0) {
        alert('La cantidad debe ser un n칰mero v치lido');
        return;
    }

    if (formData.tipo_movimiento === 'ajuste' && formData.cantidad < 0) {
        alert('La cantidad para ajuste no puede ser negativa');
        return;
    }
    
    // Mostrar indicador de carga
    const btnGuardar = document.querySelector('#modalStock .btn-info');
    const textoOriginal = btnGuardar.innerHTML;
    btnGuardar.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Procesando...';
    btnGuardar.disabled = true;
    
    // Enviar datos al servidor
    fetch('/ajustar_stock', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(formData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(`${data.message}\n\nStock anterior: ${data.stock_anterior}\nStock nuevo: ${data.stock_nuevo}`);
            
            // Cerrar modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('modalStock'));
            modal.hide();
            
            // Recargar la p치gina para mostrar los cambios
            window.location.reload();
        } else {
            alert('Error: ' + (data.error || 'Error desconocido'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error de conexi칩n al ajustar stock');
    })
    .finally(() => {
        // Restaurar bot칩n
        btnGuardar.innerHTML = textoOriginal;
        btnGuardar.disabled = false;
    });
}

// Funci칩n para activar/desactivar producto
function toggleProducto(id) {
    if (confirm('쮺ambiar el estado del producto?')) {
        fetch(`/toggle_producto/${id}`, {
            method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.message);
                window.location.reload();
            } else {
                alert('Error: ' + (data.error || 'Error desconocido'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error de conexi칩n al cambiar estado del producto');
        });
    }
}

// Funci칩n para limpiar filtros
function limpiarFiltros() {
    document.getElementById('buscarProducto').value = '';
    document.getElementById('filtroCategoria').value = '';
    document.getElementById('filtroStock').value = '';
    document.getElementById('filtroEstado').value = 'activo';
    aplicarFiltrosProductos();
}

// Funci칩n para aplicar filtros
function aplicarFiltrosProductos() {
    const buscar = document.getElementById('buscarProducto').value.trim();
    const categoria = document.getElementById('filtroCategoria').value;
    const stock = document.getElementById('filtroStock').value;
    const estado = document.getElementById('filtroEstado').value;
    
    // Construir URL con par치metros
    const params = new URLSearchParams();
    if (buscar) params.append('buscar', buscar);
    if (categoria) params.append('categoria', categoria);
    if (stock) params.append('stock', stock);
    if (estado) params.append('estado', estado);

    fetch(`/buscar_productos_admin?${params.toString()}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                actualizarTablaProductos(data.productos);
            } else {
                alert('Error en la b칰squeda: ' + (data.error || 'Error desconocido'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error de conexi칩n en la b칰squeda');
        });
}

// Funci칩n auxiliar para obtener el badge de stock
function getStockBadge(stock) {
    if (stock <= 0) {
        return `<span class="badge bg-danger">${stock}</span>`;
    } else if (stock < 10) {
        return `<span class="badge bg-warning text-dark">${stock}</span>`;
    } else {
        return `<span class="badge bg-success">${stock}</span>`;
    }
}

// Funci칩n para cargar categor칤as din치micamente
function cargarCategorias() {
    fetch('/obtener_categorias')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Actualizar filtro de categor칤as
                const filtroCategoria = document.getElementById('filtroCategoria');
                
                const nuevasOpciones = data.categorias.map(cat => 
                    `<option value="${cat}">${cat}</option>`
                ).join('');
                
                filtroCategoria.innerHTML = `<option value="">Todas las categor칤as</option>${nuevasOpciones}`;
                
                // Actualizar datalist del formulario
                const datalist = document.getElementById('categorias');
                datalist.innerHTML = data.categorias.map(cat => 
                    `<option value="${cat}"></option>`
                ).join('');
            }
        })
        .catch(error => {
            console.error('Error cargando categor칤as:', error);
        });
}


// Variables globales para acceso r치pido
let productosSeleccionados = new Set();
let productosAccesoRapidoActuales = [];

// ===== FUNCIONES DE ACCESO R츼PIDO =====

function cargarProductosAccesoRapido() {
    fetch('/api/productos_acceso_rapido')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                productosAccesoRapidoActuales = data.productos;
                actualizarVistaAccesoRapido(data.productos);
                actualizarContadorAccesoRapido(data.productos.length);
            }
        })
        .catch(error => {
            console.error('Error cargando productos de acceso r치pido:', error);
        });
}

function actualizarVistaAccesoRapido(productos) {
    const grid = document.getElementById('productos_acceso_rapido_grid');
    const mensaje = document.getElementById('mensaje_sin_acceso_rapido');
    
    if (!grid || !mensaje) return;
    
    if (productos.length === 0) {
        grid.innerHTML = '';
        mensaje.style.display = 'block';
        return;
    }
    
    mensaje.style.display = 'none';
    
    grid.innerHTML = productos.map((producto, index) => `
        <div class="col-md-3 col-sm-6 mb-3">
            <div class="card border-success">
                <div class="card-body p-2">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <span class="badge bg-success">#${index + 1}</span>
                        <button class="btn btn-danger btn-sm" onclick="quitarDeAccesoRapido(${producto.id})" title="Quitar">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <h6 class="card-title text-primary mb-1">${producto.codigo}</h6>
                    <p class="card-text small mb-2">${producto.nombre.length > 30 ? producto.nombre.substring(0, 30) + '...' : producto.nombre}</p>
                    <div class="d-flex justify-content-between">
                        <span class="text-success fw-bold">$${producto.precio.toFixed(2)}</span>
                        <span class="badge bg-${producto.stock > 10 ? 'success' : producto.stock > 0 ? 'warning' : 'danger'}">
                            ${producto.stock}
                        </span>
                    </div>
                </div>
            </div>
        </div>
    `).join('');
}

function actualizarContadorAccesoRapido(cantidad) {
    const contador = document.getElementById('contador_acceso_rapido');
    if (contador) {
        contador.textContent = `${cantidad}/8`;
        contador.className = `badge ${cantidad >= 8 ? 'bg-danger' : 'bg-light'} text-dark`;
    }
}



function mostrarProductosEnModal(productos) {
    const tbody = document.getElementById('tabla_productos_acceso_rapido');
    if (!tbody) return;
    
    tbody.innerHTML = productos.map(producto => `
        <tr>
            <td>
                <input type="checkbox" class="form-check-input" 
                       ${productosSeleccionados.has(producto.id) ? 'checked' : ''}
                       onchange="toggleProductoAccesoRapido(${producto.id}, this.checked)">
            </td>
            <td><code>${producto.codigo}</code></td>
            <td>
                <strong>${producto.nombre}</strong>
                ${producto.es_combo ? '<br><span class="badge bg-warning text-dark">OFERTA</span>' : ''}
            </td>
            <td class="text-end">$${producto.precio.toFixed(2)}</td>
            <td class="text-center">
                <span class="badge bg-${producto.stock > 10 ? 'success' : producto.stock > 0 ? 'warning' : 'danger'}">
                    ${producto.stock}
                </span>
            </td>
            <td><span class="badge bg-info">${producto.categoria || 'Sin categor칤a'}</span></td>
        </tr>
    `).join('');
}

function toggleProductoAccesoRapido(productoId, seleccionado) {
    if (seleccionado) {
        if (productosSeleccionados.size >= 8) {
            alert('M치ximo 8 productos permitidos');
            // Desmarcar el checkbox
            event.target.checked = false;
            return;
        }
        productosSeleccionados.add(productoId);
    } else {
        productosSeleccionados.delete(productoId);
    }
    
    actualizarContadorSeleccionados();
}

function actualizarContadorSeleccionados() {
    const contador = document.getElementById('seleccionados_count');
    if (contador) {
        contador.textContent = productosSeleccionados.size;
    }
    
    // Actualizar checkbox maestro
    const selectAll = document.getElementById('select_all_acceso');
    const checkboxes = document.querySelectorAll('#tabla_productos_acceso_rapido input[type="checkbox"]');
    const checkedCount = document.querySelectorAll('#tabla_productos_acceso_rapido input[type="checkbox"]:checked').length;
    
    if (selectAll) {
        selectAll.indeterminate = checkedCount > 0 && checkedCount < checkboxes.length;
        selectAll.checked = checkedCount === checkboxes.length && checkboxes.length > 0;
    }
}

function toggleTodosAccesoRapido() {
    const selectAll = document.getElementById('select_all_acceso');
    const checkboxes = document.querySelectorAll('#tabla_productos_acceso_rapido input[type="checkbox"]');
    
    if (selectAll && selectAll.checked) {
        // Seleccionar todos (m치ximo 8)
        productosSeleccionados.clear();
        let count = 0;
        checkboxes.forEach(checkbox => {
            if (count < 8) {
                checkbox.checked = true;
                const productoId = parseInt(checkbox.onchange.toString().match(/\d+/)[0]);
                productosSeleccionados.add(productoId);
                count++;
            } else {
                checkbox.checked = false;
            }
        });
    } else {
        // Deseleccionar todos
        productosSeleccionados.clear();
        checkboxes.forEach(checkbox => {
            checkbox.checked = false;
        });
    }
    
    actualizarContadorSeleccionados();
}





function quitarDeAccesoRapido(productoId) {
    if (confirm('쯈uitar este producto del acceso r치pido?')) {
        fetch(`/api/toggle_acceso_rapido/${productoId}`, {
            method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                cargarProductosAccesoRapido();
                alert(data.message);
            } else {
                alert('Error: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error de conexi칩n');
        });
    }
}




function toggleAccesoRapidoDirecto(productoId) {
    console.log('Toggle acceso rapido para producto:', productoId);
    
    const btn = event.target.closest('button');
    const originalContent = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
    btn.disabled = true;
    
    fetch(`/api/toggle_acceso_rapido/${productoId}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            // EN LUGAR DE RECARGAR, VOLVER A APLICAR FILTROS
            aplicarFiltrosProductos();
            // Tambi칠n actualizar la vista de acceso r치pido
            cargarProductosAccesoRapido();
        } else {
            alert('Error: ' + data.error);
            btn.innerHTML = originalContent;
            btn.disabled = false;
        }
    })
    .catch(error => {
        console.error('Error de conexion:', error);
        alert('Error de conexion: ' + error.message);
        btn.innerHTML = originalContent;
        btn.disabled = false;
    });
}


// Actualizar la funci칩n actualizarTablaProductos para incluir la nueva columna
function actualizarTablaProductos(productos) {
    const tbody = document.querySelector('#tablaProductos tbody');
    
    if (productos.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="11" class="text-center text-muted">
                    <i class="fas fa-search"></i> No se encontraron productos
                </td>
            </tr>
        `;
        return;
    }
    
    tbody.innerHTML = productos.map(producto => {
        const stockBadge = getStockBadge(producto.stock);
        const estadoBadge = producto.activo ? 
            '<span class="badge bg-success">Activo</span>' : 
            '<span class="badge bg-secondary">Inactivo</span>';
        
        const btnToggleClass = producto.activo ? 'btn-danger' : 'btn-success';
        const btnToggleTitle = producto.activo ? 'Desactivar' : 'Activar';
        
        // Calcular margen si no existe
        const costo = producto.costo || 0;
        const precio = producto.precio || 0;
        let margen = producto.margen || 0;
        
        // Si no hay margen guardado, calcularlo desde precio y costo
        if (!producto.margen && costo > 0) {
            margen = ((precio / costo) - 1) * 100;
        }
        
        const editFunction = producto.es_combo ? 'editarCombo' : 'editarProducto';
        
        // COLUMNA DE ACCESO R츼PIDO CORREGIDA - Con opci칩n de quitar
        const tieneAccesoRapido = producto.acceso_rapido === true || producto.orden_acceso_rapido > 0;
        const accesoRapidoColumn = tieneAccesoRapido ?
            `<div class="text-center">
                <span class="badge bg-warning text-dark mb-1" title="Producto en acceso r치pido (posici칩n ${producto.orden_acceso_rapido || 0})">
                    <i class="fas fa-bolt"></i> #${producto.orden_acceso_rapido || 0}
                </span>
                <br>
                <button class="btn btn-outline-danger btn-sm" onclick="toggleAccesoRapidoDirecto(${producto.id})" title="Quitar de acceso r치pido">
                    <i class="fas fa-minus"></i>
                </button>
            </div>` :
            `<button class="btn btn-outline-warning btn-sm" onclick="toggleAccesoRapidoDirecto(${producto.id})" title="Agregar a acceso r치pido">
                <i class="fas fa-plus"></i>
            </button>`;
        
        return `
            <tr>
                <td><code>${producto.codigo}</code></td>
                <td>
                    <strong>${producto.nombre}</strong>
                    ${producto.es_combo ? '<br><span class="badge bg-warning text-dark">OFERTA</span>' : ''}
                    ${producto.descripcion ? 
                        `<br><small class="text-muted">${producto.descripcion.substring(0, 50)}${producto.descripcion.length > 50 ? '...' : ''}</small>` : 
                        ''
                    }
                </td>
                <td>
                    <span class="badge bg-info">${producto.categoria || 'Sin categor칤a'}</span>
                </td>
                <td class="text-end">
                    <small class="text-muted">$</small><strong>${costo.toFixed(2)}</strong>
                </td>
                <td class="text-center">
                    <span class="badge bg-warning text-dark">${margen.toFixed(2)}%</span>
                </td>
                <td class="text-end">
                    <strong>$${precio.toFixed(2)}</strong>
                    ${producto.es_combo && producto.producto_base ? 
                        (() => {
                            const precio_normal = producto.producto_base.precio * producto.cantidad_combo;
                            const descuento = ((precio_normal - producto.precio) / precio_normal * 100);
                            return `<br><small class="text-danger">-${descuento.toFixed(1)}%</small>`;
                        })() : ''
                    }
                </td>
                <td class="text-center">${stockBadge}</td>
                <td class="text-center">${Math.round(producto.iva)}%</td>
                <td>${estadoBadge}</td>
                <td class="text-center">${accesoRapidoColumn}</td>
                <td>
                    <div class="btn-group btn-group-sm">
                        <button class="btn btn-warning" onclick="${editFunction}(${producto.id})" title="Editar">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-info" onclick="ajustarStock(${producto.id})" title="Ajustar Stock">
                            <i class="fas fa-boxes"></i>
                        </button>
                        <button class="btn ${btnToggleClass}" onclick="toggleProducto(${producto.id})" title="${btnToggleTitle}">
                            <i class="fas fa-power-off"></i>
                        </button>
                    </div>
                </td>
            </tr>
        `;
    }).join('');
}




// ===== EVENT LISTENERS =====

document.addEventListener('DOMContentLoaded', function() {
    console.log('游 Inicializando p치gina de productos...');
    
    // Cargar categor칤as al inicio
    cargarCategorias();
    
    
    // Event listener para costo - recalcula todas las listas
    document.getElementById('costo').addEventListener('input', function() {
        calcularPrecio();
    });

    // Event listener para margen Lista 1
    document.getElementById('margen').addEventListener('input', function() {
        calculoManual = true;
        calcularPrecio();
    });

    // Event listeners para m치rgenes Listas 2-5
    for (let i = 2; i <= 5; i++) {
        const margenInput = document.getElementById(`margen${i}`);
        if (margenInput) {
            margenInput.addEventListener('input', function() {
                calcularPrecio();
            });
        }
    }

    // Event listener para precio Lista 1 (edici칩n manual)
    document.getElementById('precio').addEventListener('input', function() {
        if (!calculoManual) {
            calcularMargen();
        }
    });

    // Event listener para cuando el precio pierde el foco
    document.getElementById('precio').addEventListener('blur', function() {
        if (!modoEdicion) {
            calcularPrecio();
        }
    });
    
    // Cambiar ayuda seg칰n tipo de movimiento de stock
    document.getElementById('tipoMovimiento').addEventListener('change', function() {
        const tipo = this.value;
        const cantidadInput = document.getElementById('cantidadStock');
        const ayuda = document.getElementById('ayudaCantidad');
        
        switch(tipo) {
            case 'entrada':
                 cantidadInput.min = '0.001';
                ayuda.textContent = 'Ingrese la cantidad a agregar (ej: 10.300 para 10kg 300g)';
                break;
            case 'salida':
                cantidadInput.min = '0.001';
                ayuda.textContent = `Ingrese la cantidad a quitar (m치ximo: ${stockActual})`;
                break;
            case 'ajuste':
                cantidadInput.min = '0';
                ayuda.textContent = 'Ingrese la cantidad final que debe quedar';
                break;
        }
    });
    
    // B칰squeda en tiempo real
    const inputBuscar = document.getElementById('buscarProducto');
    let timeoutBusqueda;
    
    inputBuscar.addEventListener('input', function() {
        clearTimeout(timeoutBusqueda);
        timeoutBusqueda = setTimeout(() => {
            aplicarFiltrosProductos();
        }, 500);
    });
    
    // Aplicar filtros cuando cambien los selects
    document.getElementById('filtroCategoria').addEventListener('change', aplicarFiltrosProductos);
    document.getElementById('filtroStock').addEventListener('change', aplicarFiltrosProductos);
    document.getElementById('filtroEstado').addEventListener('change', aplicarFiltrosProductos);

    // Validar formulario en tiempo real
    const form = document.getElementById('formProducto');
    const inputs = form.querySelectorAll('input, select, textarea');
    
    inputs.forEach(input => {
        input.addEventListener('blur', function() {
            if (this.checkValidity()) {
                this.classList.remove('is-invalid');
                this.classList.add('is-valid');
            } else {
                this.classList.remove('is-valid');
                this.classList.add('is-invalid');
            }
        });
    });
    
    // Convertir c칩digo a may칰sculas autom치ticamente
    document.getElementById('codigo').addEventListener('input', function() {
        this.value = this.value.toUpperCase();
    });
    
    // Enviar formulario con Enter
    form.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            guardarProducto();
        }
    });
    
    // Validaci칩n de c칩digo 칰nico
    document.getElementById('codigo').addEventListener('blur', function() {
        const codigo = this.value.trim();
        const productoId = document.getElementById('productoId').value;
        
        if (codigo && (!productoId || !productoActual || productoActual.codigo !== codigo)) {
            // Verificar si el c칩digo ya existe
            fetch(`/api/producto/${codigo}`)
                .then(response => response.json())
                .then(data => {
                    if (!data.error) {
                        // El c칩digo ya existe
                        this.setCustomValidity('Este c칩digo ya existe');
                        this.classList.add('is-invalid');
                    } else {
                        // El c칩digo es 칰nico
                        this.setCustomValidity('');
                        this.classList.remove('is-invalid');
                        this.classList.add('is-valid');
                    }
                })
                .catch(error => {
                    // Error en la consulta, asumir que es v치lido
                    this.setCustomValidity('');
                    this.classList.remove('is-invalid');
                });
        }
    });
    
    
    console.log('九 P치gina de productos inicializada correctamente');
});

cargarProductosAccesoRapido();
    
console.log('九 Gesti칩n de acceso r치pido inicializada');

</script>
{% endblock %}